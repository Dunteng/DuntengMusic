# äº‘å¼€å‘å…¨æ ˆéŸ³ä¹ç¤¾åŒº

## 0.æ¦‚è¿°

<https://juejin.im/post/5d54bbaf518825219c282370>

## 1.è¯¾ç¨‹å¯¼å­¦









## 2.é¡¹ç›®å‡†å¤‡

### é¡¹ç›®åˆå§‹åŒ–

#### å¼€é€šäº‘å¼€å‘æœåŠ¡

ç‚¹å‡»å¼€å‘è€…å·¥å…·ä¸­çš„äº‘å¼€å‘å³å¯ã€‚

```js
//app.js
App({
  onLaunch: function () {
    
    if (!wx.cloud) {
      console.error('è¯·ä½¿ç”¨ 2.2.3 æˆ–ä»¥ä¸Šçš„åŸºç¡€åº“ä»¥ä½¿ç”¨äº‘èƒ½åŠ›')
    } else {
      wx.cloud.init({
        // env å‚æ•°è¯´æ˜ï¼š
        //   env å‚æ•°å†³å®šæ¥ä¸‹æ¥å°ç¨‹åºå‘èµ·çš„äº‘å¼€å‘è°ƒç”¨ï¼ˆwx.cloud.xxxï¼‰ä¼šé»˜è®¤è¯·æ±‚åˆ°å“ªä¸ªäº‘ç¯å¢ƒçš„èµ„æº
        //   æ­¤å¤„è¯·å¡«å…¥ç¯å¢ƒ ID, ç¯å¢ƒ ID å¯æ‰“å¼€äº‘æ§åˆ¶å°æŸ¥çœ‹
        //   å¦‚ä¸å¡«åˆ™ä½¿ç”¨é»˜è®¤ç¯å¢ƒï¼ˆç¬¬ä¸€ä¸ªåˆ›å»ºçš„ç¯å¢ƒï¼‰
        env: 'dev-r049g',
        traceUser: true,  //è®°å½•å°ç¨‹åºçš„è®¿é—®è€…
      })
    }

    this.globalData = {}  //å…¨å±€å±æ€§å’Œæ–¹æ³•
  }
})
```



#### tabbar

![](https://pic1.zhimg.com/v2-19deb38ccb7b019595ce00ab8c608ee8_r.jpg)



## 3.æ’­æ”¾åˆ—è¡¨å®ç°

```
- ç»„ä»¶åŒ–å¼€å‘æ€æƒ³
- å®šæ—¶è§¦å‘äº‘å‡½æ•°è¯»å–æ•°æ®å¹¶å†™å…¥äº‘æ•°æ®åº“
- çªç ´äº‘å‡½æ•°è¯»å–æ•°æ®æ¡æ•°é™åˆ¶
- äº‘å‡½æ•°è·¯ç”±ä¼˜åŒ–tcb-routerå’Œæ´‹è‘±æ¨¡å‹
```

 ### é¦–é¡µè½®æ’­å›¾

```js
<swiper indicator-dots="true" autoplay="true" interval="2000" duration="1000" circular="true">
  <block wx:for="{{swiperImgUrls}}">
    <swiper-item>
      <image src="{{item.url}}" mode="widthFix" class="img"></image>
    </swiper-item>
  </block>
</swiper>
```

### ç»„ä»¶åŒ–å¼€å‘æ€æƒ³

#### æ¦‚è¿°ï¼š

ç»„ä»¶ï¼šğŸ‘‰åœ¨ç”¨æˆ·ç•Œé¢å¼€å‘é¢†åŸŸï¼Œç»„ä»¶æ˜¯ä¸€ç§é¢å‘ç”¨æˆ·çš„ã€ç‹¬ç«‹çš„ã€å¯å¤ç”¨çš„äº¤äº’å…ƒç´ çš„å°è£…ã€‚

åœ¨å°ç¨‹åºçš„ç»„ä»¶åŒ–å¼€å‘ä¸­ï¼ŒåŒ…æ‹¬å››ä¸ªéƒ¨åˆ†ï¼šã€wxmlç»“æ„ã€‘ã€jsé€»è¾‘ã€‘ã€wxssæ ·å¼ã€‘ã€jsoné…ç½®ã€‘ã€‚

#### ç»„ä»¶åŒ–å¼€å‘çš„æ„ä¹‰ï¼š

- ç»„ä»¶åŒ–æ˜¯å¯¹å®ç°çš„åˆ†å±‚ï¼Œæ˜¯æ›´æœ‰æ•ˆçš„ä»£ç ç»„åˆæ–¹å¼
- ç»„ä»¶åŒ–æ˜¯å¯¹èµ„æºçš„é‡ç»„å’Œä¼˜åŒ–ï¼Œä»è€Œä½¿é¡¹ç›®èµ„æºç®¡ç†æ›´åˆç†ã€‚
- ç»„ä»¶åŒ–å¼€å‘ç²’åº¦æ›´å°ï¼Œæ›´åˆ©äºä¼˜åŒ–ç»´æŠ¤ï¼Œåˆ©äºå•å…ƒæµ‹è¯•ã€‚
- æ–¹ä¾¿é‡æ„

#### è®¾è®¡åŸåˆ™

- é«˜å†…èš
- ä½è€¦åˆ
- å•ä¸€èŒè´£
- é¿å…è¿‡å¤šå‚æ•°ï¼š ç»„ä»¶ä¸€èˆ¬æ˜¯å¯é…ç½®çš„ï¼Œæ¯”å¦‚å°ç¨‹åºè‡ªå¸¦çš„swiperç»„ä»¶é‡Œé¢çš„å¾ˆå¤šå±æ€§éƒ½æ˜¯å¯é…ç½®çš„ã€‚ä½†æ˜¯æˆ‘ä»¬éœ€è¦è®¤è¯†åˆ°ï¼Œç»„ä»¶çš„å¯é…ç½®å‚æ•°ä¸å®œè¿‡å¤šï¼Œä¸”è¦åšå¥½é»˜è®¤å€¼çš„é…ç½®ï¼Œå¦åˆ™å‹å¥½åº¦å¾ˆä½ã€‚

#### æœ¬é¡¹ç›®å°è£…çš„ç»„ä»¶

- æ­Œå•ç»„ä»¶
- æ­Œæ›²ç»„ä»¶
- æ­Œæ›²è¿›åº¦æ¡ç»„ä»¶
- æ­Œè¯ç»„ä»¶
- åŠ¨æ€å¡ç‰‡ç»„ä»¶
- åŠ¨æ€æ§åˆ¶ç»„ä»¶
- åº•éƒ¨å¼¹çª—ç»„ä»¶
- ç™»å½•ç»„ä»¶
- æœç´¢ç»„ä»¶





### æ­Œå•ç»„ä»¶å®ç°

ã€/components/playlist/ã€‘ç¼–å†™ç»„ä»¶å®ç°ï¼Œé€šè¿‡ã€/pages/playlist/playlist.json ã€‘è¿›è¡Œç»„ä»¶å¼•å…¥ã€‚åœ¨é¦–é¡µé€šè¿‡çˆ¶ç»„ä»¶æ·»åŠ å±æ€§ä¼ å€¼ç»™æ­Œå•ç»„ä»¶ã€‚



ä¸€ä¸ªç»†èŠ‚ï¼Œåœ¨æ­Œå•ç»„ä»¶ä¸­çš„æ–‡æœ¬ä»‹ç»éƒ¨åˆ†åªæ˜¾ç¤ºä¸¤è¡Œä¸”å¤šä½™çš„éƒ¨åˆ†ç”¨çœç•¥å·è¡¨ç¤ºğŸ‘‡

![](https://pic4.zhimg.com/80/v2-77212831d8a8c46a67e9dbe808ce8e1f_hd.jpg)

```css
.playlist-name{
  font-size: 26rpx;
  line-height: 1.2;
  padding: 2px 0 0 6px;
  display: -webkit-box;
  -webkit-box-orient: vertical;
  -webkit-line-clamp:2;
  overflow: hidden;
  text-overflow: ellipsis;
}
```



å¦ä¸€ä¸ªç»†èŠ‚æ˜¯è¦å¤„ç†æ’­æ”¾æ¬¡æ•°ï¼Œå°†å…¶æ ¼å¼åŒ–ï¼Œè¿™é‡Œç”¨åˆ°äº†[**æ•°æ®ç›‘å¬å™¨observers**](https://developers.weixin.qq.com/miniprogram/dev/framework/custom-component/observer.html)

```js
  observers:{
    // ç›‘å¬playlistItemé‡Œçš„playCountå±æ€§ï¼Œè¿™æ ·ä¸‹é¢è¿™ç§å†™æ³•
    ['playlistItem.playCount'](count){
      // console.log(count)
      //æ ¼å¼åŒ–æ•°æ®ï¼Œä¿ç•™å°æ•°ç‚¹åä¸¤ä½
      // console.log(this._tranNumber(count, 2))
      this.setData({
        _count: this._tranNumber(count,2)  
        //ç”¨dataä¸­çš„_countæ¥å­˜æ”¾ä¿®æ”¹åçš„playlistItem.playCountçš„æ•°æ®,
        //å¦‚æœç›´æ¥å°±å­˜æ”¾ä¸ºè‡ªèº«playlistItem.playCountçš„è¯ä¼šé™·å…¥æ­»å¾ªç¯
        //å³ä¸èƒ½ç»™è¢«ç›‘å¬æ•°æ®æœ¬èº«èµ‹å€¼ä»¥é˜²é™·å…¥æ­»å¾ªç¯  
      })
    }
  },
```



### è¯¦è§£wx:key/promise/async awaitçœ‹è§†é¢‘

åœ¨äº‘å‡½æ•°é‡Œï¼Œç”±äº Node ç‰ˆæœ¬æœ€ä½æ˜¯ 8.9ï¼Œå› æ­¤æ˜¯å¤©ç„¶æ”¯æŒ async/await è¯­æ³•çš„ã€‚è€Œåœ¨å°ç¨‹åºç«¯åˆ™ä¸ç„¶ã€‚åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·é‡Œï¼Œä»¥åŠ Android ç«¯æ‰‹æœºï¼ˆæµè§ˆå™¨å†…æ ¸æ˜¯ QQæµè§ˆå™¨çš„ X5ï¼‰ï¼Œasync/awaitæ˜¯å¤©ç„¶æ”¯æŒçš„ï¼Œä½† iOS ç«¯æ‰‹æœºåœ¨è¾ƒä½ç‰ˆæœ¬åˆ™ä¸æ”¯æŒï¼Œå› æ­¤éœ€è¦å¼•å…¥é¢å¤–çš„ æ–‡ä»¶ã€‚å¯æŠŠè¿™ä¸ª regenerator/runtime.js æ–‡ä»¶å¼•ç”¨åˆ°æœ‰ä½¿ç”¨ async/await çš„æ–‡ä»¶å½“ä¸­ã€‚

```
import regeneratorRuntime from '../../utils/runtime.js'
```

### ã€é‡è¦ã€‘è¯»å–æ­Œå•æ•°æ®å¹¶æ’å…¥äº‘æ•°æ®åº“

ä»æœåŠ¡å™¨ç«¯å–åˆ°æ­Œå•æ•°æ®ï¼Œå¹¶ä¸”æŠŠæ•°æ®å†™å…¥äº‘æ•°æ®åº“å½“ä¸­ã€‚å…¶ä¸­ï¼Œå‘é€httpè¯·æ±‚åœ¨äº‘å‡½æ•°ä¸­è¿›è¡Œï¼Œç„¶åæŠŠæ•°æ®å†™è¿›äº‘æ•°æ®åº“ä¸­ã€‚æœ¬é¡¹ç›®ç”¨åˆ°çš„ç¬¬ä¸‰æ–¹æœåŠ¡å™¨ç«¯æ•°æ®ä¸º<http://musicapi.xiecheng.live/>ï¼Œæ˜¯ä¸€ä¸ªå¤§ç¥ä»ç½‘æ˜“äº‘éŸ³ä¹æ‰’ä¸‹æ¥çš„æ•°æ®ã€‚

ä¸ºä»€ä¹ˆè¦åœ¨äº‘å‡½æ•°ä¸­è¿›è¡Œå‘¢ï¼Ÿ

å› ä¸ºè¿™ä¸ªæ•°æ®æ˜¯ä»ç¬¬ä¸‰æ–¹è·å–åˆ°çš„ï¼Œå…³é”®æ˜¯è¿™äº›éŸ³ä¹æ­Œå•ç­‰æ•°æ®æ¯å¤©éƒ½ä¼šæ›´æ–°ï¼Œå¦‚æœåªæ˜¯è·å–ä¸€æ¬¡çš„è¯ï¼Œå°±æ— æ³•åšåˆ°æ•°æ®çš„åŠæ—¶æ›´æ–°ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬è¦åœ¨å‡½æ•°ä¸­è®¾ç½®ä¸€ä¸ªå®šæ—¶è§¦å‘å™¨ï¼Œä¹Ÿå°±æ˜¯è¯´ä¼šæ¯å¤©å®šæ—¶çš„ä»æœåŠ¡å™¨ä¸­å–æ•°æ®ï¼Œä»¥ä¿è¯å–åˆ°çš„éƒ½æ˜¯æœ€æ–°çš„æ•°æ®ã€‚å–åˆ°æ–°æ•°æ®åä¸æ—§æ•°æ®è¿›è¡Œæ¯”è¾ƒï¼Œæ— åˆ™æ’å…¥ã€‚è€Œä»¥ä¸Šçš„è¿™äº›åŠŸèƒ½ï¼Œåœ¨äº‘å‡½æ•°ä¸­å®Œæˆæœ€ä¸ºåˆé€‚ã€‚

#### ç¼–å†™å¹¶ä¸Šä¼ äº‘å‡½æ•°

åœ¨äº‘å‡½æ•°ä¸­ä½¿ç”¨ä¸€ä¸ªåº“[request-promise](https://github.com/request/request-promise)æ¥è¿›è¡Œå¯¹æœåŠ¡å™¨ç«¯çš„è¯·æ±‚ã€‚

æˆ‘å†™çš„äº‘å‡½æ•°è·¯å¾„ä¸º`/cloudfunctions/getPlaylist`ï¼Œåœ¨è¯¥è·¯å¾„ä¸‹å®‰è£…`request`å’Œ`request-promise`ã€‚

```js
npm install --save request
npm install --save request-promise
```

ç¼–å†™äº‘å‡½æ•°`getPlaylist`ï¼š

```js
// äº‘å‡½æ•°å…¥å£æ–‡ä»¶
const cloud = require('wx-server-sdk')

cloud.init()

// å¼•å…¥request-promiseä¾èµ–
const rp = require("request-promise")

const URL = 'http://musicapi.xiecheng.live/personalized'
// äº‘å‡½æ•°å…¥å£å‡½æ•°
exports.main = async (event, context) => {
  const playlist = await rp(URL).then((res) => {
    // console.log(typeof res) //åœ¨äº‘ç«¯æµ‹è¯•æ‰“å°ç»“æœä¸ºstringï¼Œéœ€è¦å¯¹å…¶è½¬ä¸ºå¯¹è±¡,å¹¶åªå–resultæ•°æ®
    return JSON.parse(res).result
  })
  console.log(playlist)
}
```

ç„¶åå³é”®â€œä¸Šä¼ å¹¶éƒ¨ç½²ï¼šäº‘ç«¯å®‰è£…ä¾èµ– ( ä¸ä¸Šä¼ node_modules ) â€ã€‚ä¹‹åå°±å¯ä»¥åœ¨äº‘å¼€å‘ä¸­çš„äº‘å‡½æ•°é‡Œçœ‹åˆ°è¿™ä¸ª`getPlaylist`äº‘å‡½æ•°ã€‚ç‚¹å‡»äº‘ç«¯æµ‹è¯•å¯ä»¥å¯¹è¯¥å‡½æ•°è¿›è¡Œæµ‹è¯•ã€‚æ³¨æ„æ¯æ¬¡ä¿®æ”¹å®Œäº‘å‡½æ•°åéƒ½è¦é‡æ–°ä¸Šä¼ å¹¶éƒ¨ç½²ã€‚


#### å»ºç«‹äº‘æ•°æ®åº“

åœ¨äº‘å¼€å‘çš„æ•°æ®åº“ä¸­æ–°å»ºé›†åˆ`playlist`ï¼Œå°ç¨‹åºçš„äº‘æ•°æ®åº“æ˜¯éå…³ç³»å‹æ•°æ®åº“ï¼Œè¿™é‡Œçš„é›†åˆç±»ä¼¼äºMySQLä¸­çš„è¡¨ã€‚ç„¶åé€šè¿‡äº‘å‡½æ•°ä¸­ä»£ç å°†ä»ç¬¬ä¸‰æ–¹æœåŠ¡å™¨è·å–åˆ°çš„æ•°æ®ä¸€æ¡æ¡åœ°å†™å…¥äº‘æ•°æ®åº“çš„è¡¨ä¸­ã€‚

```js
// äº‘å‡½æ•°å…¥å£æ–‡ä»¶
const cloud = require('wx-server-sdk')

cloud.init()

// å¾—åˆ°äº‘æ•°æ®åº“å¯¹è±¡
const db = cloud.database()

// å¼•å…¥request-promiseä¾èµ–
const rp = require("request-promise")

const URL = 'http://musicapi.xiecheng.live/personalized'
// äº‘å‡½æ•°å…¥å£å‡½æ•°
exports.main = async (event, context) => {
  const playlist = await rp(URL).then((res) => {
    // console.log(typeof res) //åœ¨äº‘ç«¯æµ‹è¯•æ‰“å°ç»“æœä¸ºstringï¼Œéœ€è¦å¯¹å…¶è½¬ä¸ºå¯¹è±¡,å¹¶åªå–resultæ•°æ®
    return JSON.parse(res).result
  })
  // console.log(playlist)
  for(let i = 0; i<playlist.length; i++){
    // æ³¨æ„ï¼Œå¾€äº‘æ•°æ®åº“é‡Œæ’å…¥æ•°æ®çš„è¿‡ç¨‹æ˜¯å¼‚æ­¥è¿‡ç¨‹ï¼Œä¹Ÿå¿…é¡»åŠ ä¸Šawaitå…³é”®å­—
    await db.collection('playlist').add({
      data:{
        ...playlist[i],//é€šè¿‡ES6å±•å¼€è¿ç®—ç¬¦è¿›è¡Œæ•°æ®çš„å±•å¼€
        createTime: db.serverDate(), //è‡ªå®šä¹‰ä¸€ä¸ªå±æ€§ï¼Œè®°å½•æ•°æ®ç”Ÿæˆçš„æ—¶é—´
      }
    }).then((res)=>{
      console.log('æ’å…¥æˆåŠŸ')
    }).catch((err)=>{
      console.error('æ’å…¥å¤±è´¥')
    })
  }
}
```

ä¸Šé¢ä»£ç éå†äº†ä»ç¬¬ä¸‰æ–¹æœåŠ¡å™¨è·å–åˆ°çš„æ•°æ®å¹¶ä¸€æ¡æ¡æ’å…¥äº†äº‘æ•°æ®åº“é›†åˆä¸­ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¿™é‡Œé¢çš„ä¸¤å¤„å¼‚æ­¥æ“ä½œï¼Œéƒ½è¦åŠ ä¸Š`await`å…³é”®å­—ã€‚

ç„¶åä¸Šä¼ å¹¶éƒ¨ç½²åˆ°äº‘å‡½æ•°ä¸­ï¼Œè¿›è¡Œäº‘ç«¯æµ‹è¯•ï¼Œæµ‹è¯•ç»“æœæ˜¯äº‘æ•°æ®åº“ä¸­æˆåŠŸçš„æ’å…¥äº†æ•°æ®ã€‚

#### æ­Œå•æ•°æ®å»é‡

è¿™ä¸€æ­¥è¦å®ç°çš„æ˜¯ï¼Œäº‘å‡½æ•°è¯»å–æ•°æ®å¹¶æ’å…¥è¿›äº‘æ•°æ®åº“çš„æ—¶å€™ï¼Œè¦å¯¹äº‘æ•°æ®åº“ä¸­çš„æ•°æ®è¿›è¡Œæ¯”å¯¹ï¼Œå¦‚æœæ•°æ®å·²å­˜åœ¨ï¼Œåˆ™ä¸æ’å…¥ï¼Œå¦åˆ™æ’å…¥ã€‚

å¦‚ä½•è¿›è¡Œæ¯”å¯¹ï¼Œæ¯”å¯¹çš„æ ‡å¿—æ˜¯æ­Œå•æ•°æ®ä¸­çš„`id`å€¼ã€‚

åœ¨äº‘å‡½æ•°ä¸­è·å–åˆ°äº‘æ•°æ®åº“ä¸­çš„é›†åˆ`playlist`ï¼Œæ³¨æ„ï¼Œå®ƒä¹Ÿæ˜¯ä¸€ä¸ªå¼‚æ­¥æ“ä½œï¼Œéœ€è¦åŠ ä¸Š`await`

```js
const list = await db.collection('playlist').get()
//ä½†æ˜¯äº‘å‡½æ•°è¯»å–æ•°æ®æ¡æ•°æœ‰é™åˆ¶ï¼Œæœ€å¤šåªèƒ½è¯»å–100æ¡ï¼›å¦‚æœæ˜¯åœ¨å°ç¨‹åºç«¯è¯»å–æœ€å¤šåªèƒ½20æ¡
//ä¹‹åä¼šé’ˆå¯¹è¿™ä¸€é—®é¢˜è¿›è¡Œè§£å†³ï¼Œè¿™é‡Œæš‚æ—¶ä¸è¡¨
```



```js
// äº‘å‡½æ•°å…¥å£æ–‡ä»¶
const cloud = require('wx-server-sdk')

cloud.init()

// å¾—åˆ°äº‘æ•°æ®åº“å¯¹è±¡
const db = cloud.database()
// å¾—åˆ°äº‘æ•°æ®åº“ä¸­playlisté›†åˆå¯¹è±¡
const playlistCollection = db.collection('playlist')

// å¼•å…¥request-promiseä¾èµ–
const rp = require("request-promise")

const URL = 'http://musicapi.xiecheng.live/personalized'
// äº‘å‡½æ•°å…¥å£å‡½æ•°
exports.main = async (event, context) => {
  // ä»äº‘æ•°æ®åº“ä¸­å–åˆ°çš„æ•°æ®
  const list = await playlistCollection.get()

  // ä»ç¬¬ä¸‰æ–¹æœåŠ¡å™¨ç«¯å–åˆ°çš„æ•°æ®
  const playlist = await rp(URL).then((res) => {
    // console.log(typeof res) //åœ¨äº‘ç«¯æµ‹è¯•æ‰“å°ç»“æœä¸ºstringï¼Œéœ€è¦å¯¹å…¶è½¬ä¸ºå¯¹è±¡,å¹¶åªå–resultæ•°æ®
    return JSON.parse(res).result
  })
  // console.log(playlist)

  // ä¸‹é¢è¿›è¡Œæ•°æ®å»é‡ï¼Œæ¯”è¾ƒä»æœåŠ¡å™¨ç«¯è·å–åˆ°çš„æ•°æ®å’Œäº‘æ•°æ®åº“ä¸­çš„é›†åˆçš„æ•°æ®æ˜¯å¦é‡å¤
  const newData = []
  for(let i=0, len1=playlist.length; i<len1;i++){
    let flag = true  //ä¸€å¼€å§‹é»˜è®¤ä¸é‡å¤ï¼Œæ ‡å¿—ä¸ºtrue
    for(let j = 0, len2=list.data.length; j<len2; j++){
      if(playlist[i].id===list.data[j].id){
        flag = false  //æ•°æ®é‡å¤äº†ï¼Œæ ‡å¿—ç½®ä¸ºfalse
        break  //æœ‰ä¸€æ¬¡é‡å¤å°±è·³å‡ºå¾ªç¯åˆ¤æ–­
      }
    }
    if (flag) {
      newData.push(playlist[i])
    }
  }
  // åˆ é™¤äº‘æ•°æ®åº“é‡Œçš„æ•°æ®ï¼Œæ ¹æ®whereé‡Œçš„æ¡ä»¶æ¸…ç©ºæ•°æ®
  // try {
  //   return await db.collection('playlist').where({
  //     // canDislike: false
  //     type: 0
  //   }).remove()
  // } catch (e) {
  //   console.error(e)
  // }

  for(let i = 0; i<newData.length; i++){
    // æ³¨æ„ï¼Œå¾€äº‘æ•°æ®åº“é‡Œæ’å…¥æ•°æ®çš„è¿‡ç¨‹æ˜¯å¼‚æ­¥è¿‡ç¨‹ï¼Œä¹Ÿå¿…é¡»åŠ ä¸Šawaitå…³é”®å­—
    await playlistCollection.add({
      data:{
        // ...playlist[i],//é€šè¿‡ES6å±•å¼€è¿ç®—ç¬¦è¿›è¡Œæ•°æ®çš„å±•å¼€
        ...newData[i],  //ä¸ç”¨playlistäº†ï¼Œå› ä¸ºæ²¡æœ‰å»é‡ï¼Œåº”ä½¿ç”¨å»é‡åçš„newData
        createTime: db.serverDate(), //è‡ªå®šä¹‰ä¸€ä¸ªå±æ€§ï¼Œè®°å½•æ•°æ®ç”Ÿæˆçš„æ—¶é—´
      }
    }).then((res)=>{
      console.log('æ’å…¥æˆåŠŸ')
    }).catch((err)=>{
      console.error('æ’å…¥å¤±è´¥')
    })
  }
  console.log("newdataçš„é•¿åº¦"+newData.length) 
  console.log("playlistçš„é•¿åº¦"+playlist.length)
}
```

ä¸Šé¢ä»£ç ä¸­å®ç°äº†æ•°æ®çš„å»é‡æ“ä½œã€‚åœ¨äº‘å¼€å‘ä¹‹äº‘å‡½æ•°ä¸­è¿›è¡Œäº‘ç«¯æµ‹è¯•ï¼Œç„¶åæŸ¥çœ‹äº‘æ•°æ®åº“ä¸­çš„æ•°æ®ï¼Œå¯ä»¥éªŒè¯ã€‚



#### ã€éš¾ç‚¹ã€‘çªç ´è·å–æ•°æ®æ¡æ•°é™åˆ¶ï¼Œ

å‰é¢è¯´äº†ï¼Œäº‘å‡½æ•°è¯»å–æ•°æ®æ¡æ•°æœ‰é™åˆ¶ï¼Œæœ€å¤šåªèƒ½è¯»å–100æ¡ï¼›å¦‚æœæ˜¯åœ¨å°ç¨‹åºç«¯è¯»å–æœ€å¤šåªèƒ½20æ¡ã€‚éšç€æ—¶é—´çš„æ”¹å˜ï¼Œæ­Œå•ä¿¡æ¯åªä¼šè¶Šæ¥è¶Šå¤šï¼Œè¿™ä¸ªé™åˆ¶æ˜¯ä¼šå½±å“è¿™ä¸ªé¡¹ç›®çš„ã€‚` const list = await playlistCollection.get()`ä»¥åŠæ— æ³•æ»¡è¶³éœ€æ±‚äº†ã€‚è¿™ä¸ªé—®é¢˜å¦‚ä½•è§£å†³ï¼Ÿ

ã€è§£å†³æ€è·¯ã€‘ğŸ‘‡

ä¹‹å‰ä½¿ç”¨` const list = await playlistCollection.get()`ä¼å›¾ä¸€æ¬¡æ€§è·å–åˆ°äº‘æ•°æ®åº“ä¸­playlisté›†åˆçš„æ‰€æœ‰è®°å½•ï¼Œå¦‚æœæ€»æ•°å°äº100ï¼Œé‚£è¿˜å¥½è¯´ï¼Œä½†æ˜¯å®é™…ä¸Šæ•°æ®è‚¯å®šä¼šè¶Šæ¥è¶Šå¤šçš„ã€‚

**é‚£ä¹ˆæˆ‘ä»¬å°±æ¯æ¬¡åªè·å–20æ¡æ•°æ®ï¼Œç„¶ååˆ†å¤šæ¬¡è·å–ï¼Œè¿™æ ·å°±å¯ä»¥å…¨éƒ¨è·å¾—äº‘æ•°æ®åº“çš„æ•°æ®ã€‚**

```js
const MAX_LIMIT = 20 //æ¯æ¬¡è¯»å–äº‘æ•°æ®åº“çš„æ•°æ®äº‘å‡½æ•°ä¸­ä¸€æ¬¡åªèƒ½è·å–100æ¡ï¼Œå°ç¨‹åºç«¯ä¸€æ¬¡åªèƒ½è·å–20æ¡ï¼Œè¿™é‡Œæˆ‘ä»¬è¿›è¡Œè‡ªå®šä¹‰ä¸€æ¬¡æ€§æœ€å¤§è¯»å–æ•°
// äº‘å‡½æ•°å…¥å£å‡½æ•°
exports.main = async (event, context) => {
  // ä»äº‘æ•°æ®åº“ä¸­å–åˆ°çš„æ•°æ®
  // const list = await playlistCollection.get() //ä¸é€‚ç”¨äº†ã€‚äº‘å‡½æ•°ä¸­ä¸€æ¬¡åªèƒ½è·å–100æ¡ï¼Œå°ç¨‹åºç«¯ä¸€æ¬¡åªèƒ½è·å–20æ¡
  const countResult = await playlistCollection.count()  //è·å–åˆ°çš„æ˜¯ä¸€ä¸ªå¯¹è±¡{ total: 30, errMsg: 'collection.count:ok' }
  const total = countResult.total  //å–åˆ°äº‘æ•°æ®åº“ä¸­playlisté›†åˆçš„è®°å½•çš„æ€»æ¡æ•°
  // å¾—å‡ºéœ€è¦å‘äº‘æ•°æ®åº“åˆ†å¤šæ¬¡è¯»å–æ•°æ®çš„æ‰¹æ¬¡
  const batchTimes = Math.ceil(total/MAX_LIMIT)  
  const tasks = []
  for(let i = 0; i<batchTimes; i++){
    let promise = playlistCollection.skip(i*MAX_LIMIT).limit(MAX_LIMIT).get()
    // è¿™å°±å¾—åˆ°äº†ä»ç¬¬0æ¡å–åˆ°ç¬¬99æ¡ï¼Œä»ç¬¬100æ¡å–åˆ°ç¬¬199æ¡ï¼Œä»ç¬¬200æ¡å–åˆ°ç¬¬299æ¡ã€‚ã€‚ã€‚ï¼ˆå‰ææ˜¯MAX_LIMITä¸º100çš„æ—¶å€™ï¼‰
    tasks.push(promise)
  }
    // console.log(tasks) //é‡Œé¢æ˜¯è‹¥å¹²ä¸ªpromiseå¯¹è±¡
  let list = {
    data:[]
  }
  if(tasks.length>0){
    // ä½¿ç”¨äº†promise.all
    list = (await Promise.all(tasks)).reduce((acc, cur)=>{
      return {
        data: acc.data.concat(cur.data)
      }
    })
  }
  // è‡³æ­¤åˆ†æ‰¹è¯»å–äº‘æ•°æ®åº“çš„æ•°æ®å®Œæˆï¼Œè§£å†³äº†å°ç¨‹åºè¯»å–äº‘æ•°æ®åº“æ•°æ®æ¡æ•°çš„é™åˆ¶
```

è¿™é‡Œé¢ç”¨åˆ°äº†ã€promise.allã€‘

åœ¨äº‘å¼€å‘ä¹‹äº‘å‡½æ•°ä¸­è¿›è¡Œäº‘ç«¯æµ‹è¯•ï¼Œç„¶åæŸ¥çœ‹äº‘æ•°æ®åº“ä¸­çš„æ•°æ®ï¼Œå¯ä»¥éªŒè¯



#### è®¾è®¡å®šæ—¶è§¦å‘å™¨ä»¥å®šæ—¶è§¦å‘è·å–æ•°æ®çš„å‡½æ•°getPlaylist()

å…³äºå®šæ—¶è§¦å‘å™¨<https://developers.weixin.qq.com/miniprogram/dev/wxcloud/guide/functions/triggers.html>

åœ¨getPlaylistå‡½æ•°çš„ç›®å½•ä¸‹æ–°å»ºä¸€ä¸ªé…ç½®æ–‡ä»¶config.jsonğŸ‘‡

å…¶ä¸­`"config": "0 0 10,14,16,23 * * * *"`è¡¨ç¤ºåœ¨æ¯å¤©ä¸Šåˆ10ç‚¹ï¼Œä¸‹åˆ2ç‚¹ï¼Œ4ç‚¹å’Œæ™šä¸Š11ç‚¹è§¦å‘ï¼Œè¿™æ ·æ­Œå•ä¿¡æ¯ä¸€å¤©å°±ä¼šæœ‰å››æ¬¡æ›´æ–°ã€‚ï¼ˆæ›´æ–°çš„æ­Œå•ä¿¡æ¯æ¥è‡ªç½‘æ˜“äº‘éŸ³ä¹æ›´æ–°çš„æ¨èæ­Œå•ï¼‰

```
{
  "triggers": [
    {
      "name": "myTrigger",
      "type": "timer",
      "config": "0 0 10,14,16,23 * * * *"
    }
  ]
}
```

ä¹‹åè¦ä¸Šä¼ è§¦å‘å™¨ã€‚ç‚¹å‡»å½“å‰äº‘å‡½æ•°getPlaylistï¼Œé¼ æ ‡å³é”®ç‚¹å‡»â€ä¸Šä¼ è§¦å‘å™¨â€œã€‚è¿™æ ·è¿™ä¸ªå®šæ—¶è§¦å‘å™¨æ‰èƒ½ç”Ÿæ•ˆã€‚



åœ¨äº‘å¼€å‘æ§åˆ¶å°çš„äº‘å‡½æ•°ä¸­ï¼Œæœ‰ä¸€ä¸ªâ€œé…ç½®â€é€‰é¡¹ï¼Œç‚¹å‡»ï¼Œæ›´æ”¹é‡Œé¢çš„â€œè¶…æ—¶æ—¶é—´â€ï¼Œæ”¹ä¸º20ç§’æ¯”è¾ƒåˆé€‚ã€‚

è‡³æ­¤ï¼Œäº‘å‡½æ•°`getPlaylist`çš„å¼€å‘å¤§è‡´å®Œæˆã€‚



### ä»äº‘æ•°æ®åº“ä¸­è·å–æ•°æ®å¹¶æ¸²æŸ“åˆ°é¡µé¢ä¸­

<img src="https://pic4.zhimg.com/v2-26cc4fde482475db8c039fd0462522ef_r.jpg" style="width:300px" />

#### æ–°å»ºmusicäº‘å‡½æ•°

è¿™ä¸ªmusicäº‘å‡½æ•°ç”¨äºæŸ¥è¯¢æ­Œå•ä¿¡æ¯ã€‚

ã€æ³¨æ„ã€‘ç”±äºæ­Œå•æ•°æ®ä¼šå¾ˆå¤šï¼Œæ‰€ä»¥è¦åšåˆ°**åˆ†é¡µ**çš„æŸ¥è¯¢æ•°æ®ï¼Œä¸”æŸ¥è¯¢ç»“æœæŒ‰æ•°æ®åˆ›å»ºæŒ‰æ—¶é—´å€’åºæ’åº

```js
// äº‘å‡½æ•°å…¥å£æ–‡ä»¶
const cloud = require('wx-server-sdk')

cloud.init()

// äº‘å‡½æ•°å…¥å£å‡½æ•°
exports.main = async (event, context) => {
  // æŸ¥è¯¢æ­Œå•æ•°æ®ï¼Œå¹¶ä¸”æ˜¯åˆ†é¡µæŸ¥è¯¢ï¼ŒæŒ‰æ•°æ®åˆ›å»ºæ—¶é—´å€’åºæ’åº
   return await cloud.database().collection('playlist')
   .skip(event.start)
   .limit(event.count)
   .orderBy('createTime', 'desc')
   .get()
   .then((res)=>{
     return res
   })
}
```



#### è°ƒç”¨musicäº‘å‡½æ•°

æ¥ç€åœ¨`miniprogram/pages/playlist/playlist.js`ä¸­è°ƒç”¨è¯¥äº‘å‡½æ•°è·å–äº‘æ•°æ®åº“çš„æ­Œå•æ•°æ®ã€‚

```js
  onLoad: function (options) {
    this._getPlaylist()
  },

  _getPlaylist(){
    wx.showLoading({
      title: 'åŠ è½½ä¸­',
    })

    wx.cloud.callFunction({
      name: 'music',
      data: {
        start: this.data.playlist.length,
        count: MAX_LIMIT
      }
    }).then((res) => {
      // console.log(res)
      this.setData({
        playlist: this.data.playlist.concat(res.result.data) //æ³¨æ„æ˜¯è¿½åŠ æ­Œå•æ•°æ®è€Œéæ›¿æ¢æ­Œå•æ•°æ®
      })
      wx.hideLoading() //è®°å¾—å…³é—­loading
    })
  },
```



#### ä¸Šæ‹‰è§¦åº•åˆ·æ–°å’Œä¸‹æ‹‰åˆ·æ–°

ä¸Šæ‹‰è§¦åº•åˆ·æ–°ğŸ‘‡

```js
  /**
   * é¡µé¢ä¸Šæ‹‰è§¦åº•äº‹ä»¶çš„å¤„ç†å‡½æ•°
   */
  onReachBottom: function () {
    this._getPlaylist()
  },
```



ä¸‹æ‹‰åˆ·æ–°å°±æ¯”ä¸Šæ‹‰è§¦åº•å¤æ‚ä¸€ç‚¹

åœ¨`/miniprogram/pages/playlist/playlist.json `ä¸­è¿›è¡Œå¦‚ä¸‹é…ç½®ğŸ‘‡ 

```json
{
  "usingComponents": {
    "playlist-cmp": "/components/playlist/cmp"
  },
  "enablePullDownRefresh": true
}
```

å°ç¨‹åºé»˜è®¤æ˜¯ä¸å¼€å¯ä¸‹æ‹‰åˆ·æ–°çš„ï¼Œé€šè¿‡é…ç½®å°†å…¶ç½®ä¸ºå…è®¸ä¸‹æ‹‰åˆ·æ–°

ç„¶åå°±å¯ä»¥åœ¨**onPullDownRefresh**çš„ç›‘å¬å‡½æ•°ä¸­è¿›è¡Œä»£ç ç¼–å†™

```js
  /**
   * é¡µé¢ç›¸å…³äº‹ä»¶å¤„ç†å‡½æ•°--ç›‘å¬ç”¨æˆ·ä¸‹æ‹‰åŠ¨ä½œ
   */
  onPullDownRefresh: function () {
    // ä¸‹æ‹‰åˆ·æ–°åŠ¨ä½œæ˜¯è¦å…ˆæ¸…ç©ºæ•°æ®,ç„¶åå†é‡æ–°è¯·æ±‚æ•°æ®
    this.setData({
      playlist:[]  
    })
    this._getPlaylist()
  },
```



### äº‘å‡½æ•°è·¯ç”±ä¼˜åŒ–tcb-router

å…³äºtcb-routeræˆ‘å†™çš„ä¸€ç¯‡ç¬”è®°ğŸ‘‰<https://juejin.im/post/5dd930385188257353094a2d>

#### èƒŒæ™¯ï¼š

ä¸€ä¸ªç”¨æˆ·åœ¨ä¸€ä¸ªäº‘ç¯å¢ƒä¸­åªèƒ½åˆ›å»º50ä¸ªäº‘å‡½æ•°ï¼Œä¹‹å‰æ˜¯20ä¸ªï¼Œæ›´å°‘ã€‚å½“æˆ‘ä»¬è¦è·å–æ­Œæ›²ä¿¡æ¯çš„æ—¶å€™å¯èƒ½è¦åˆ›å»ºä¸€ä¸ªäº‘å‡½æ•°ï¼Œè¦è·å–ç”µå½±ä¿¡æ¯çš„æ—¶å€™åˆè¦åˆ›å»ºä¸€ä¸ªäº‘å‡½æ•°ã€‚ã€‚ã€‚ã€‚éšç€ä¸šåŠ¡çš„å¢å¤šï¼Œåˆ›å»ºçš„å¯¹åº”çš„äº‘å‡½æ•°æ•°ç›®è¶Šæ¥è¶Šå¤šï¼Œ50ä¸ªå¯èƒ½ä¸å¤Ÿç”¨ï¼Œè€Œä¸”è¿™ç§åšæ³•ä¹Ÿå¾ˆå†—æ‚ã€‚

æ‰€ä»¥å¸Œæœ›æŠŠç›¸ä¼¼çš„è¯·æ±‚å½’ç±»åˆ°åŒä¸€ä¸ªäº‘å‡½æ•°å¤„ç†ï¼Œæ¯”å¦‚æˆ‘ä»¬æŠŠè·å–éŸ³ä¹ä¿¡æ¯å’Œè·å–ç”µå½±ä¿¡æ¯éƒ½åœ¨åŒä¸€ä¸ªäº‘å‡½æ•°é‡Œå®ç°ï¼Œä»è€Œé¿å…åˆ›å»ºå¤šä¸ªäº‘å‡½æ•°çš„æƒ…å†µã€‚

è¦å®ç°è¿™ä¸€åŠŸèƒ½å°±è¦ç”¨åˆ°ä¸€ä¸ªç¬¬ä¸‰æ–¹åº“â€”â€”[tcb-router](https://github.com/TencentCloudBase/tcb-router) ä¸€ä¸ªkoaé£æ ¼çš„äº‘å‡½æ•°è·¯ç”±åº“ã€‚



#### koaæ´‹è‘±æ¨¡å‹

koaæ¡†æ¶é‡‡ç”¨äº†ã€ä¸­é—´ä»¶ã€‘çš„å½¢å¼ï¼Œä¸­é—´ä»¶å¯ä»¥ä»‹å…¥è¯·æ±‚å’Œç›¸åº”çš„å¤„ç†ï¼Œå¯ä»¥ç†è§£æ˜¯ä¸€ä¸ªè½»é‡çº§çš„æ¨¡å—ï¼Œæˆ–è€…åœ¨æˆ‘ä»¬çš„ä»£ç å½“ä¸­æ˜¯ä¸€ä¸ªå‡½æ•°å½¢å¼ã€‚ä¸­é—´ä»¶å¯ä»¥è´Ÿè´£ä¸€ä¸ªç‰¹å®šçš„åŠŸèƒ½ï¼Œé€šè¿‡ä¸€ä¸ª`next`å‡½æ•°æŠŠæ¯ä¸ªä¸­é—´ä»¶ä¹‹é—´å»ºç«‹å…³ç³»ã€‚

ä»€ä¹ˆæ˜¯ã€æ´‹è‘±æ¨¡å‹ã€‘ï¼Ÿ

![](https://ask.qcloudimg.com/http-save/yehe-1000017/uuitxvbg4y.jpeg?imageView2/2/w/1620)

![](https://images0.cnblogs.com/blog2015/570057/201507/281409123445079.jpg)

#### æ–°å»ºtcbRouteräº‘å‡½æ•°â€¢ä¸¾ä¸ªä¾‹å­

tcb-routerï¼š<https://github.com/TencentCloudBase/tcb-router>

æˆ‘ä»¬å®ç°ä¸€ä¸ªåŠŸèƒ½ï¼šæŠŠè·å–éŸ³ä¹ä¿¡æ¯å’Œè·å–ç”µå½±ä¿¡æ¯éƒ½åœ¨åŒä¸€ä¸ªäº‘å‡½æ•°é‡Œå®ç°ï¼Œä¸¤è€…éƒ½è¦è·å–`ç”¨æˆ·openid`å¹¶ä¸”è·å–å„è‡ªçš„ä¿¡æ¯ï¼Œä»è€Œé¿å…åˆ›å»ºå¤šä¸ªäº‘å‡½æ•°çš„æƒ…å†µã€‚

åœ¨tcbRouteräº‘å‡½æ•°çš„ç›®å½•ä¸‹å®‰è£…tcb-routerä¾èµ–ğŸ‘‡

```
npm install --save tcb-router
```



äº‘å‡½æ•°**tcbRouter**

```js
// äº‘å‡½æ•°å…¥å£æ–‡ä»¶
const cloud = require('wx-server-sdk')
// å¼•å…¥tcb-router
const TcbRouter = require('tcb-router')

cloud.init()

// äº‘å‡½æ•°å…¥å£å‡½æ•°
exports.main = async (event, context) => {
  // return {event,context}  //çœ‹çœ‹eventå’Œcontextåˆ°åº•æ˜¯å•¥

  // newä¸€ä¸ªTcbRouterå¯¹è±¡,éœ€è¦ä¼ å…¥ä¸€ä¸ªå‚æ•°,æŠŠeventä¼ å…¥
  // è¿™æ—¶å€™tcb-routerå°±ä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬å¤„ç†äº‹ä»¶ä¸­çš„å‚æ•°å’Œè·¯ç”±è½¬å‘
  const app = new TcbRouter({event})

  // å…¬å…±è·¯ç”±
  // app.use è¡¨ç¤ºè¯¥ä¸­é—´ä»¶ä¼šé€‚ç”¨äºæ‰€æœ‰çš„è·¯ç”±
  app.use(async (ctx,next)=>{
    console.log('è¿›å…¥å…¨å±€ä¸­é—´ä»¶')
    ctx.data = {}
    ctx.data.openId = event.userInfo.openId //é€šè¿‡è¯¥å…¬å…±è·¯ç”±è·å–åˆ°ç”¨æˆ·openid
    await next()  //æ‰§è¡Œä¸€ä¸‹ä¸­é—´ä»¶.è¿™æ˜¯ä¸€ä¸ªå¼‚æ­¥æ“ä½œ,è¦åŠ ä¸Šawait
    console.log('é€€å‡ºå…¨å±€ä¸­é—´ä»¶')
  })

  // musicç›¸å…³çš„è·¯ç”±
  app.router('music', async (ctx,next)=>{
    console.log('è¿›å…¥éŸ³ä¹åç§°è·¯ç”±ä¸­é—´ä»¶')
    ctx.data.musicName = "Let it be"
    await next()  //æ‰§è¡Œä¸€ä¸‹ä¸­é—´ä»¶
    console.log('é€€å‡ºéŸ³ä¹åç§°è·¯ç”±ä¸­é—´ä»¶')
  }, async (ctx, next)=>{
    console.log('è¿›å…¥éŸ³ä¹ç±»å‹è·¯ç”±ä¸­é—´ä»¶')
    ctx.data.musicType = 'æ‘‡æ»šä¹'
    ctx.body = {
      data: ctx.data
    }
    // ctx.body è¿”å›æ•°æ®åˆ°å°ç¨‹åºç«¯
    console.log('é€€å‡ºéŸ³ä¹ç±»å‹è·¯ç”±ä¸­é—´ä»¶')
  })

  // movieç›¸å…³çš„è·¯ç”±
  app.router('movie', async (ctx,next)=>{
    console.log('è¿›å…¥ç”µå½±åç§°è·¯ç”±ä¸­é—´ä»¶')
    ctx.data.movieName = "åƒä¸åƒå¯»"
    await next()  //æ‰§è¡Œä¸€ä¸‹ä¸­é—´ä»¶
    console.log('é€€å‡ºç”µå½±åç§°è·¯ç”±ä¸­é—´ä»¶')
  }, async (ctx, next)=>{
    console.log('è¿›å…¥ç”µå½±ç±»å‹è·¯ç”±ä¸­é—´ä»¶')
    ctx.data.movieType = 'åŠ¨æ¼«'
    ctx.body = {
      data: ctx.data
    }
    // ctx.body è¿”å›æ•°æ®åˆ°å°ç¨‹åºç«¯
    console.log('é€€å‡ºç”µå½±ç±»å‹è·¯ç”±ä¸­é—´ä»¶')
  })

  // // å¿…é¡»å†™! éœ€è¦æŠŠå½“å‰çš„æœåŠ¡è¿”å›
  return app.serve()
}
```

å°ç¨‹åºç«¯è°ƒç”¨tcbRouterå‡½æ•°ğŸ‘‡

```js
 //demo.js
 getMusicInfo(){
    wx.cloud.callFunction({
      name: 'tcbRouter',
      data: {
        $url: 'music'
      }
    }).then((res)=>{
      console.log(res)
    })
  },
  getMovieInfo(){
    wx.cloud.callFunction({
      name: 'tcbRouter',
      data:{
        $url: 'movie'
      }
    }).then((res)=>{
      console.log(res)
    })
  },
```

ä¸Šé¢è¿™æ®µä»£ç ä¸¤ä¸ªæ–¹æ³•å®é™…ä¸Šè°ƒç”¨çš„éƒ½æ˜¯åŒä¸€ä¸ªäº‘å‡½æ•°**tcbRouter**ï¼Œä½†å®ç°äº†ä¸åŒçš„åŠŸèƒ½ã€‚

![](https://pic1.zhimg.com/v2-928c9ce713a0d13a92d18d6abe21b910_r.jpg)



ä¸ºäº†æ›´åŠ ç›´è§‚çš„ä½“ç°ã€æ´‹è‘±æ¨¡å‹ã€‘è¿™ä¸€æ¦‚å¿µåœ¨è¯¥ä¾‹å­ä¸Šçš„åº”ç”¨ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨äº‘å¼€å‘æ§åˆ¶å°çš„äº‘å‡½æ•°è¿è¡Œæ—¥å¿—ä¸­æŸ¥çœ‹æ‰“å°çš„æ—¥å¿—ğŸ‘‡

![](https://pic3.zhimg.com/v2-0484ed79f891b5e7b2e82ad95296e6ca_r.jpg)

![](https://images0.cnblogs.com/blog2015/570057/201507/281409123445079.jpg)



#### tcbRouterå¯¹musicäº‘å‡½æ•°è¿›è¡Œæ”¹é€ 

å‰é¢è¯´è¿‡ï¼Œæˆ‘ä»¬è¦æŠŠ**ç›¸ä¼¼çš„è¯·æ±‚å½’ç±»åˆ°åŒä¸€ä¸ªäº‘å‡½æ•°å¤„ç†**ã€‚

åœ¨äº‘å‡½æ•°musicæ‰€å¯¹åº”çš„ç›®å½•ä¸‹å®‰è£…tcb-routerä¾èµ–ï¼š

```j
npm install --save tcb-router
```



äº‘å‡½æ•°musicğŸ‘‡

```js
// äº‘å‡½æ•°å…¥å£æ–‡ä»¶
const cloud = require('wx-server-sdk')
// å¼•å…¥tcb-router
const TcbRouter = require('tcb-router')

cloud.init()

// äº‘å‡½æ•°å…¥å£å‡½æ•°
exports.main = async (event, context) => {
  const app = new TcbRouter({event})

  app.router('playlist', async (ctx,next)=>{
    // æŸ¥è¯¢æ­Œå•æ•°æ®ï¼Œå¹¶ä¸”æ˜¯åˆ†é¡µæŸ¥è¯¢ï¼ŒæŒ‰æ•°æ®åˆ›å»ºæ—¶é—´å€’åºæ’åº
    // æ³¨æ„,æ²¡ä½¿ç”¨tcb-routerä¹‹å‰æ˜¯ç”¨returè¿”å›,ç°åœ¨è¦ç”¨ ctx.body è¿”å›æ•°æ®åˆ°å°ç¨‹åºç«¯
    ctx.body = await cloud.database().collection('playlist')
      .skip(event.start)
      .limit(event.count)
      .orderBy('createTime', 'desc')
      .get()
      .then((res) => {
        //  console.log(res)
        return res
      })
  })
  // å¿…é¡»å†™! éœ€è¦æŠŠå½“å‰çš„æœåŠ¡è¿”å›
  return app.serve()

}
```

é‡æ–°ä¸Šä¼ å¹¶éƒ¨ç½²è¯¥äº‘å‡½æ•°ã€‚

é€šè¿‡tcb-routeræ”¹é€ åï¼Œè°ƒç”¨musicäº‘å‡½æ•°çš„æ–¹å¼ä¹Ÿè¦è¿›è¡Œä¿®æ”¹ğŸ‘‡

```js
  ///miniprogram/pages/playlist/playlist.js 
  
  _getPlaylist(){
    wx.showLoading({
      title: 'åŠ è½½ä¸­',
    })

    wx.cloud.callFunction({
      name: 'music',
      data: {
        start: this.data.playlist.length,
        count: MAX_LIMIT,
        // äº‘å‡½æ•°musicè¢«tcb-routeråŒ–åè¦ä½¿ç”¨$urlæŒ‡å®šè·¯ç”±
        $url: 'playlist'
      }
    }).then((res) => {
      // console.log(res)
      this.setData({
        playlist: this.data.playlist.concat(res.result.data) //æ³¨æ„æ˜¯è¿½åŠ æ­Œå•æ•°æ®è€Œéæ›¿æ¢æ­Œå•æ•°æ®
      })
      wx.stopPullDownRefresh() //å…³é—­ä¸‹æ‹‰åˆ·æ–°åŠ¨ä½œï¼Œè¿™æ­¥ä¸å†™çš„è¯çœŸæœºä¸ä¼šå›å¼¹é¡µé¢
      wx.hideLoading() //è®°å¾—å…³é—­loading
    })
  },
```



<br>

### è‡ªå®šä¹‰æ­Œæ›²åˆ—è¡¨ç»„ä»¶

#### è·¯ç”±è·³è½¬

åœ¨é¦–é¡µçš„æ­Œå•åˆ—è¡¨ä¸­ï¼Œæ¯ç‚¹å‡»ä¸€ä¸ªæ­Œå•éƒ½è·³è½¬åˆ°ç›¸å¯¹åº”çš„æ­Œæ›²åˆ—è¡¨é‡Œé¢ï¼Œç”¨`wx.navigateTo`è¿›è¡Œè·¯ç”±è·³è½¬ï¼Œåœ¨æ­¤ä¹‹å‰è¦é…ç½®é¡µé¢è·¯ç”±ä¿¡æ¯ã€‚åœ¨`app.json`ä¸­æ·»åŠ `"pages/musiclist/musiclist"`ã€‚

ä¸ºæ­Œå•ç»„ä»¶ç»‘å®šä¸€ä¸ªç‚¹å‡»äº‹ä»¶ï¼Œç‚¹å‡»è§¦å‘å‡½æ•°`goToMusiclist`:

```js
// miniprogram/components/playlist/cmp.js   

	// æ˜¾ç¤ºæ­Œæ›²åˆ—è¡¨
    goToMusiclist() {
      wx.navigateTo({
        url: `../../pages/musiclist/musiclist?playlistId=${this.properties.playlistItem.id}`
      })
    }
```

è¿™æ ·å°±æŠŠæ­Œå•æ•°æ®çš„`id`ä½œä¸ºå‚æ•°ä¼ è¿›è·¯ç”±é‡Œäº†ï¼Œç„¶åæˆ‘ä»¬åœ¨ç›®æ ‡è·¯ç”±å¯¹åº”çš„é¡µé¢æ‰“å°å‡ºè·¯ç”±å‚æ•°ğŸ‘‡

```js
// miniprogram/pages/musiclist/musiclist.js  
  /**
   * ç”Ÿå‘½å‘¨æœŸå‡½æ•°--ç›‘å¬é¡µé¢åŠ è½½
   */
  onLoad: function (options) {
    console.log(options)
  },
```

å¯ä»¥è·å–åˆ°ä¼ è¿‡æ¥çš„å‚æ•°`id`ã€‚æ ¹æ®è¿™ä¸ª`id`å¯ä»¥å‘åç«¯apiè·å–åˆ°å¯¹åº”æ­Œæ›²åˆ—è¡¨çš„æ•°æ®

#### è·å–æ­Œæ›²æ•°æ®

å‰é¢è¯´è¿‡ï¼Œæˆ‘ä»¬è¦æŠŠ**ç›¸ä¼¼çš„è¯·æ±‚å½’ç±»åˆ°åŒä¸€ä¸ªäº‘å‡½æ•°å¤„ç†**ã€‚æ‰€ä»¥ï¼Œè¿™é‡ŒæŠŠè·å–æ­Œå•å¯¹åº”çš„æ­Œæ›²åˆ—è¡¨ä¿¡æ¯çš„å¤„ç†ä¹Ÿæ”¾åœ¨äº‘å‡½æ•°musicé‡Œï¼Œé€šè¿‡tcb-routerè¿›è¡Œä»»åŠ¡æ´¾å‘ã€‚

è¿™é‡Œæ¶‰åŠåˆ°å‘é€httpè¯·æ±‚çš„æ“ä½œï¼ˆå‘åç«¯apiå‘é€ajaxè¯·æ±‚ï¼‰ï¼Œæ‰€ä»¥åœ¨äº‘å‡½æ•°musicæ‰€åœ¨ç›®å½•ä¸‹å®‰è£…`request`å’Œ`request-promise`ä¾èµ–ã€‚



ç»™äº‘å‡½æ•°musicæ·»åŠ è·å–æ­Œå•å†…æ­Œæ›²åˆ—è¡¨æ•°æ®çš„è·¯ç”±å¤„ç†å‡½æ•°musiclistğŸ‘‡

```js
// cloudfunctions/music/index.js 

// å¼•å…¥request-promise
const rp = require('request-promise')

const BASE_URL = 'http://musicapi.xiecheng.live'
//ç”¨ ctx.body è¿”å›æ•°æ®åˆ°å°ç¨‹åºç«¯
 app.router('musiclist', async (ctx, next)=>{
    ctx.body = await rp(BASE_URL+'/playlist/detail?id='+event.playlistId)
    .then((res)=>{
      return JSON.parse(res)
    })
  })
```

ç„¶ååœ¨æ­Œå•è¯¦æƒ…é¡µå¯¹åº”çš„`/miniprogram/pages/musiclist/musiclist.js `ä¸­è·å¾—æ•°æ®å¹¶ä¿å­˜ğŸ‘‡

```js
  data: {
    //æ­Œå•è¯¦æƒ…ä¿¡æ¯
    listInfo: {},
    // æ­Œæ›²åˆ—è¡¨
    musiclist: []
  },
  
    /**
   * ç”Ÿå‘½å‘¨æœŸå‡½æ•°--ç›‘å¬é¡µé¢åŠ è½½
   */
  onLoad: function (options) {
    console.log(options) //å¯ä»¥è·å–åˆ°è·¯ç”±ä¼ è¿›æ¥çš„å‚æ•°ï¼Œè¿™é‡Œæ˜¯æ­Œå•id
    wx.cloud.callFunction({
      name: 'music',
      data:{
        playlistId: options.playlistId,
        $url: 'musiclist'
      }
    }).then((res)=>{
      // console.log(res)
      const pl = res.result.playlist
      this.setData({
        musiclist: pl.tracks,
        listInfo: {
          coverImgUrl: pl.coverImgUrl,
          name: pl.name
        }
      })
    })
  },
```

è¿™é‡Œå¯ä»¥é…ç½®ä¸€ä¸‹äº‘å‡½æ•°musicçš„è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤æ˜¯3ç§’ï¼Œè¿™å¯¼è‡´å¾ˆå¤šå›¾ç‰‡æ²¡æ¥å¾—åŠåŠ è½½é¡¹ç›®æŠ¥é”™ï¼Œæ•…å¯ä»¥åœ¨äº‘å¼€å‘æ§åˆ¶å°è®¾ç½®musicäº‘å‡½æ•°çš„è¶…æ—¶äº‹ä»¶ä¸º20ç§’ã€‚



#### æ¸²æŸ“æ­Œå•æ­Œæ›²åˆ—è¡¨è¯¦æƒ…é¡µé¢musiclist

ä»ä¸Šä¸€æ­¥å·²ç»è·å–åˆ°åç«¯æ•°æ®å¹¶ä¿å­˜åœ¨äº†musiclist.jsçš„dataä¸­äº†ï¼Œæ‰€ä»¥ç›´æ¥å¼€å§‹æ•°æ®æ¸²æŸ“å°±è¡Œäº†ã€‚

è¯¦æƒ…é¡µçš„å¤´éƒ¨èƒŒæ™¯å›¾è¿›è¡Œäº†**é«˜æ–¯æ¨¡ç³Š**çš„å¤„ç†ã€‚

```html
<!--pages/musiclist/musiclist.wxml-->
<view class="detail-container" style="background:url({{listInfo.coverImgUrl}}) center/cover no-repeat"></view>
<view class="detail-mask"></view>
```



```js
.detail-container{
  height: 320rpx;
  filter: blur(40rpx);  /*css3æ»¤é•œå±æ€§*/
  opacity: 0.4;
}

.detail-mask{
  position: absolute;
  width: 100%;
  height: 320rpx;
  background-color: #333;
  top: 0;
  left: 0;
  z-index: -1;
}
```



#### musiclistç»„ä»¶å¼€å‘

ä¸Šé¢æåˆ°çš„æ­Œå•æ­Œæ›²åˆ—è¡¨è¯¦æƒ…é¡µé¢çš„å¤´éƒ¨èƒŒæ™¯å›¾å·²ç»å®Œæˆäº†ï¼Œè¯¥é¡µé¢ä¸‹é¢çš„éƒ¨åˆ†å°±æ˜¯æ­Œæ›²åˆ—è¡¨çš„å±•ç¤ºï¼Œè¿™ä¸€æ­¥å¯ä»¥å°è£…æˆä¸€ä¸ªç»„ä»¶ï¼Œæ–¹ä¾¿ä¹‹åçš„å¤ç”¨ã€‚

æ–°å»ºä¸€ä¸ªcomponentï¼š/miniprogram/components/musiclist/cmp

æˆ‘ä»¬æƒ³è¦åœ¨`/miniprogram/pages/musiclist/musiclist.wxml `ä¸­å¼•ç”¨è¯¥ç»„ä»¶ï¼Œè¦å…ˆåœ¨`/miniprogram/pages/musiclist/musiclist.json `ä¸­è¿›è¡Œæ³¨å†Œå¼•å…¥ğŸ‘‡

```json
{
  "usingComponents": {
    "musiclist-cmp": "/components/musiclist/cmp"
  }
}
```

ç„¶ååœ¨ä½¿ç”¨ç”¨è¿™ä¸ªç»„ä»¶çš„æ—¶å€™ï¼Œå°†æ­Œæ›²æ•°æ®ä½œä¸ºå…¶å±æ€§å€¼ä¼ å…¥ï¼Œ`musiclist-cmp`ç»„ä»¶åœ¨`musiclist/cmp.js `ä¸­çš„`properties`ä¸­è¿›è¡Œæ¥æ”¶ã€‚

ä¹‹åå°±å¯ä»¥è¿›è¡Œå¸ƒå±€å’Œæ•°æ®æ¸²æŸ“å®ç°è¯¥ç»„ä»¶çš„é¡µé¢æ˜¾ç¤ºéƒ¨åˆ†äº†ã€‚

<img src="https://pic1.zhimg.com/v2-1f2f1b731031c2db538fe6c1481eb700_r.jpg" style="width:300px" />



#### æ­Œæ›²ç‚¹å‡»æ ·å¼é«˜äº®

ç°åœ¨æƒ³è¦ç‚¹å‡»ä¸€é¦–æ­Œï¼Œå…¶æ–‡å­—å˜æˆçº¢è‰²æ ·å¼ã€‚

è¿™å°±è¦å–åˆ°è¯¥æ­Œæ›²çš„ç´¢å¼•ï¼Œè¿™é‡Œä½¿ç”¨äº†ä¸¤ä¸ªä¸ªè‡ªå®šä¹‰å±æ€§ã€‚ç»‘å®šä¸€ä¸ªç‚¹å‡»äº‹ä»¶è§¦å‘å‡½æ•°è·å–åˆ°è¯¥ç´¢å¼•å¹¶ä¿®æ”¹å…¶æ ·å¼ã€‚

```html
// /miniprogram/components/musiclist/cmp.wxml  
<view class="musiclist-container" bindtap="onSelect" data-musicid="{{item.id}}" data-index="{{index}}">
```

æ³¨æ„è‡ªå®šä¹‰å±æ€§éƒ½æ˜¯`data-xxx`çš„æ ¼å¼ï¼Œé€šè¿‡`event.currentTarget.dataset.musicid`æ¥è·å–åˆ°è¯¥è‡ªå®šä¹‰å±æ€§ã€‚

```
    onSelect(event){
      console.log(event)
      console.log(event.currentTarget.dataset.musicid)
    }
```

è¿›ä¸€æ­¥è¯¥å…¶åŠ ä¸Šæ ·å¼ï¼Œæ³¨æ„è¿™é‡Œçš„åˆ¤æ–­æ“ä½œ`{{item.id===playingId?'playing':''}}`ğŸ‘‡

```html
  <view class="musiclist-container  {{item.id===playingId?'playing':''}}" bindtap="onSelect" data-musicid="{{item.id}}" data-index="{{index}}">
```

```
.playing view, .playing text{
  color: #d43c43;
}
```

è¿™æ ·æ¯æ¬¡ç‚¹å‡»æ­Œæ›²ï¼Œè¢«ç‚¹å‡»çš„æ­Œæ›²çš„æ ·å¼å°±ä¼šå˜çº¢.

æ¥ä¸‹æ¥å°±æ˜¯è¦åœ¨ç‚¹å‡»äº†æ­Œæ›²ä¹‹åè¿›å…¥æ­Œæ›²çš„æ’­æ”¾é¡µï¼ŒåŒæ—¶æŠŠ`playingId`å³æ­Œæ›²çš„`id`å’Œ`index`ä¼ è¿›å»ã€‚

```js
    onSelect(event){
      // console.log(event)
      // console.log(event.currentTarget.dataset.musicid)
      const ds = event.currentTarget.dataset
      this.setData({
        playingId: ds.musicid
      })
      wx.navigateTo({
        url: `../../pages/player/player?musicId=${ds.musicid}&index=${ds.index}`,
      })
    }
```

åœ¨`app.json`ä¸­é…ç½®æ–°çš„é¡µé¢`pages/player/player`ï¼Œä¹‹åçš„æ’­æ”¾é¡µåœ¨è¿™é‡Œè¿›è¡Œå®ç°ã€‚

```json
  "pages": [
    "pages/playlist/playlist",
    "pages/blog/blog",
    "pages/profile/profile",
    "pages/demo/demo",
    "pages/musiclist/musiclist",
    "pages/player/player"
  ],
```



## 4.æ’­æ”¾å™¨åŠŸèƒ½å®ç°

```
- åª²ç¾åŸç”Ÿä½“éªŒçš„å°ç¨‹åºéŸ³ä¹æ’­æ”¾å™¨
- æ­Œè¯è§£æå’Œæ’­æ”¾äº‹ä»¶è”åŠ¨
- æ€§èƒ½ä¼˜åŒ–
- å¼•å…¥iconfontå­—ä½“å›¾æ ‡
```

### æœ¬åœ°ç¼“å­˜æ­Œæ›²ä¿¡æ¯

è·å–æ­Œæ›²ä¿¡æ¯å‰é¢è¯´äº†å¯ä»¥é€šè¿‡æ­Œæ›²åˆ—è¡¨é‡Œè¢«ç‚¹å‡»çš„è¯¥æ­Œæ›²çš„idå€¼ï¼Œé€šè¿‡å‘é€ç½‘ç»œè¯·æ±‚è·å¾—è¯¥æ­Œæ›²çš„è¯¦ç»†ä¿¡æ¯ã€‚ä½†å…¶å®åœ¨æ­Œæ›²åˆ—è¡¨é˜¶æ®µï¼Œæ­Œæ›²åˆ—è¡¨æ•°æ®è·å–çš„æ—¶å€™ï¼Œæ¯ä¸€é¦–æ­Œçš„ä¿¡æ¯éƒ½å·²ç»æ‹¿åˆ°äº†ï¼Œæ‰€ä»¥ä¸å¿…å†å»è°ƒç”¨æ–°çš„ç½‘ç»œè¯·æ±‚ã€‚é‚£ä¹ˆè¦æ€ä¹ˆä¿å­˜åœ¨æ­Œæ›²åˆ—è¡¨é˜¶æ®µå¾—åˆ°çš„æ­Œæ›²ä¿¡æ¯å‘¢ï¼Ÿè¿™é‡Œç”¨åˆ°äº†**æœ¬åœ°ç¼“å­˜**ã€‚

æ‰€ä»¥åˆè¦å›åˆ°ä¸Šä¸€ä¸ªé˜¶æ®µâ€”â€”æ­Œæ›²åˆ—è¡¨ç»„ä»¶é˜¶æ®µã€‚åœ¨è·å–åˆ°æ­Œæ›²åˆ—è¡¨ä¿¡æ¯çš„æ—¶å€™ï¼Œè¦å°†å…¶å­˜å…¥æœ¬åœ°ç¼“å­˜ã€‚

åœ¨å¼€å‘è€…å·¥å…·è°ƒè¯•å™¨ä¸­çš„Storageä¸­å¯ä»¥çœ‹åˆ°ï¼Œ`wx.setStorageSync`æ˜¯æ•°æ®è¦†ç›–çš„è€Œä¸æ˜¯æ•°æ®è¿½åŠ çš„ï¼Œæ‰€ä»¥æ¯æ¬¡åªä¿å­˜å½“å‰ç‚¹å‡»è¿›æ¥çš„æ­Œå•çš„æ•°æ®ã€‚

/miniprogram/pages/musiclist/musiclist.js ğŸ‘‡

```js
  onLoad: function (options) {
    wx.showLoading({
      title: 'åŠ è½½ä¸­',
    })
    console.log(options) //å¯ä»¥è·å–åˆ°è·¯ç”±ä¼ è¿›æ¥çš„å‚æ•°ï¼Œè¿™é‡Œæ˜¯æ­Œå•id
    wx.cloud.callFunction({
      name: 'music',
      data:{
        playlistId: options.playlistId,
        $url: 'musiclist'
      }
    }).then((res)=>{
      // console.log(res)
      const pl = res.result.playlist
      this.setData({
        musiclist: pl.tracks,
        listInfo: {
          coverImgUrl: pl.coverImgUrl,
          name: pl.name
        }
      })
      this._setMusiclist() // æ­Œæ›²åˆ—è¡¨ä¿¡æ¯å­˜å…¥ç¼“å­˜
      wx.hideLoading()
    })
  },

  _setMusiclist(){
    wx.setStorageSync('musiclist', this.data.musiclist)
  },
```



### è·å–æœ¬åœ°ç¼“å­˜ä¿¡æ¯å¹¶æ¸²æŸ“é¡µé¢

æœ¬åœ°ç¼“å­˜äº†ä¸€ä¸ªæ­Œæ›²åˆ—è¡¨çš„ä¿¡æ¯ï¼Œæ˜¯ä¸€ä¸ªæ•°ç»„çš„æ ¼å¼ã€‚è€Œåœ¨æ’­æ”¾é¡µé‡Œä¼ è¿›äº†ä¸¤ä¸ªè‡ªå®šä¹‰å±æ€§`data-musicid `å’Œ` data-index`ï¼Œé€šè¿‡è¿™ä¸ª`data-index`å°±èƒ½ç›´æ¥è·å–åˆ°å½“å‰æ’­æ”¾æ­Œæ›²çš„ä¿¡æ¯ã€‚

```js
  // pages/player/player.js

	//ç”¨äºå­˜æ”¾è·å–åˆ°çš„æœ¬åœ°ç¼“å­˜ä¿¡æ¯
	let musiclist = [] 
	// æ­£åœ¨æ’­æ”¾çš„æ­Œæ›²çš„index
	let nowPlayingIndex = 0

  /**
   * ç”Ÿå‘½å‘¨æœŸå‡½æ•°--ç›‘å¬é¡µé¢åŠ è½½
   */
  onLoad: function (options) {
    console.log(options)
    nowPlayingIndex = options.index
    musiclist = wx.getStorageSync('musiclist')
    this._loadMusicDetail()
  },

  _loadMusicDetail(){
    // å½“å‰æ’­æ”¾æ­Œæ›²çš„ä¿¡æ¯
    let music = musiclist[nowPlayingIndex]
    console.log(music)

    wx.setNavigationBarTitle({
      title: music.name
    })

    this.setData({
      picUrl: music.al.picUrl
    })
  },
```

åœ¨é¡µé¢æ¸²æŸ“éƒ¨åˆ†ï¼Œä¾æ—§ä½¿ç”¨äº†ä¸€ä¸ªé«˜æ–¯æ¨¡ç³Šçš„æ•ˆæœï¼Œç„¶ååšäº†ä¸€ä¸ªé»‘èƒ¶å”±æœºæŒ‡é’ˆçš„æ•ˆæœï¼Œä½¿ç”¨CSS3åŠ¨ç”»æ•ˆæœğŸ‘‡

![](https://pic1.zhimg.com/80/v2-33ce6d02c02b02b90e2e74293dbfcd40_hd.jpg)

### å°ç¨‹åºå¼•å…¥icofontå­—ä½“å›¾æ ‡å®ç°æ’­æ”¾æ§ä»¶éƒ¨åˆ†

åœ¨[icofont](https://www.iconfont.cn/)å®˜ç½‘ä¸­æŒ‘é€‰å‡ ä¸ªå›¾ç‰‡ï¼ŒåŠ å…¥è´­ç‰©è½¦ï¼Œç„¶åæ·»åŠ åˆ°é¡¹ç›®ä¸­ï¼Œç‚¹å‡»font classï¼Œç‚¹å‡»åœ¨çº¿é“¾æ¥ï¼Œç„¶ååœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€è¯¥é“¾æ¥ï¼Œå‘ç°æ˜¯ä¸€æ®µcssä»£ç ï¼Œå°†å…¶æ‹·è´ä¸‹æ¥ä¿å­˜åœ¨æˆ‘ä»¬çš„å°ç¨‹åºæ ¹è·¯å¾„ä¸‹å‘½åä¸º`iconfont.wxss`ï¼Œç„¶ååœ¨`app.wxss`ä¸­å¼•å…¥ï¼Œè¿™æ ·å…¨å±€ä¸‹éƒ½å¯ä»¥ä½¿ç”¨è¿™ä¸ªå­—ä½“å›¾æ ‡ã€‚

```css
@import 'iconfont.wxss';
```

åœ¨éœ€è¦å¼•ç”¨å­—ä½“å›¾æ ‡çš„é¡µé¢å¦‚ä¸‹å¼•ç”¨å³å¯ï¼Œè¿™æ ·æ¯”èµ·ç›´æ¥ä¸‹è½½å›¾æ ‡æ–‡ä»¶æ›´åŠ èŠ‚çœé¡¹ç›®å¤§å°ã€‚

```html
<view class="control">
  <text class="iconfont icon-fast-backward"></text>
  <text class="iconfont icon-play-circle-fill"></text>
  <text class="iconfont icon-poweroff-circle-fill"></text>
  <text class="iconfont icon-fast-forward"></text>
</view>
```

æ¥ä¸‹æ¥ç»™å®ƒä»¬æ·»åŠ æ ·å¼å³å¯ã€‚

### æ’­æ”¾æ§ä»¶åŠŸèƒ½å®ç°

ç»§ç»­è¡¥å……äº‘å‡½æ•°`music`é‡Œé¢çš„åŠŸèƒ½ğŸ‘‡

```js
  app.router('musicUrl', async(ctx,next)=>{
    ctx.body = await rp(BASE_URL+`/song/url?id=${event.musicId}`).then((res)=>{
      return res
    })
  })
```

ä¹‹åä¸Šä¼ æ›´æ–°äº‘å‡½æ•°ã€‚

åœ¨ä¸­ä½¿ç”¨è¯¥äº‘å‡½æ•°`music`ä¸­çš„`musicUrl`ä¸­é—´ä»¶ğŸ‘‡

```js
    wx.cloud.callFunction({
      name: 'music',
      data:{
        musicId,
        $url: 'musicUrl'
      }
    }).then(res=>{
      console.log(JSON.parse(res.result)) //å°†å­—ç¬¦ä¸²jsonæ ¼å¼åŒ–æˆå¯¹è±¡æ ¼å¼
    })
```

è¿™ç»“æœä¸­çš„urlå°±æ˜¯è¯¥æ­Œæ›²çš„æºã€‚

æ¥ä¸‹æ¥åˆ©ç”¨å°ç¨‹åºé‡Œçš„ä¸€ä¸ª[èƒŒæ™¯éŸ³é¢‘ç®¡ç†å™¨åŠŸèƒ½`wx.getBackgroundAudioManager()`](https://developers.weixin.qq.com/miniprogram/dev/api/media/background-audio/BackgroundAudioManager.html)å°†æ­Œæ›²æ’­æ”¾å‡ºæ¥ğŸ‘‡

```js
// miniprogram/pages/player/player.js 

// è·å–å…¨å±€å”¯ä¸€çš„èƒŒæ™¯éŸ³é¢‘ç®¡ç†å™¨
const backgroundAudioManager = wx.getBackgroundAudioManager()

    wx.cloud.callFunction({
      name: 'music',
      data:{
        musicId,
        $url: 'musicUrl'
      }
    }).then(res=>{
      console.log(JSON.parse(res.result))
      let result = JSON.parse(res.result)
      backgroundAudioManager.src = result.data[0].url  //æ­Œæ›²æº
      backgroundAudioManager.title = music.name //æ­Œæ›²å
      backgroundAudioManager.coverImgUrl = music.al.picUrl //æ­Œæ›²å°é¢
      backgroundAudioManager.singer = music.ar[0].name //æ­Œæ‰‹å
      backgroundAudioManager.epname = music.al.name //ä¸“è¾‘å
    })
```

å¯ä»¥æ’­æ”¾æ­Œæ›²äº†ï¼

![](https://pic4.zhimg.com/v2-256cf023641f1d8e8bd50be69690e28b_r.jpg)

è¿™é‡Œå¯ä»¥çœ‹åˆ°ä¸€ä¸ªæç¤ºğŸ‘‰VM211:1 è‹¥éœ€è¦å°ç¨‹åºåœ¨é€€åˆ°åå°åç»§ç»­æ’­æ”¾éŸ³é¢‘ï¼Œä½ éœ€è¦åœ¨ app.json ä¸­é…ç½® requiredBackgroundModes å±æ€§ï¼Œè¯¦è§: https://developers.weixin.qq.com/miniprogram/dev/framework/config.html#requiredbackgroundmodes

```a&#39;p
  "requiredBackgroundModes": [
    "audio"
  ],
```

å¼€å‘ç‰ˆå’Œä½“éªŒç‰ˆä¸Šå¯ä»¥ç›´æ¥ç”Ÿæ•ˆï¼Œæ­£å¼ç‰ˆè¿˜éœ€é€šè¿‡å®¡æ ¸ã€‚



ç”¨ä¸€ä¸ªå˜é‡`isPlaying`æ¥è¡¨ç¤ºå½“å‰æ˜¯å¦æœ‰éŸ³ä¹åœ¨æ’­æ”¾ï¼Œæ¥ä¸‹æ¥æ’­æ”¾æŒ‰é’®çš„åˆ‡æ¢å’Œæ­Œæ›²å°é¢çš„æ—‹è½¬å’ŒæŒ‡é’ˆçš„æ‘†æ”¾éƒ½å›´ç»•è¿™ä¸ªå˜é‡æ¥æ§åˆ¶ğŸ‘‡

```js
  data: {
    picUrl: '',
    isPlaying: false
  },
```

æŒ‰é’®çš„åˆ‡æ¢ğŸ‘‡

```html
  <text class="iconfont {{isPlaying?'icon-poweroff-circle-fill':'icon-play-circle-fill'}}" bindtap="togglePlaying"></text>
```

é€šè¿‡`backgroundAudioManager.pause() `å’Œ`backgroundAudioManager.play()`æ¥æ§åˆ¶éŸ³ä¹çš„æš‚åœå’Œæ’­æ”¾ã€‚

```js
  togglePlaying(){
    if(this.data.isPlaying){
      backgroundAudioManager.pause()  
    }else{
      backgroundAudioManager.play()
    }
    this.setData({
      isPlaying: !this.data.isPlaying
    })
  },
```

å°é¢æ—‹è½¬ğŸ‘‡

```html
<image class="player-img rotation {{isPlaying?'':'rotation-paused '}}" src="{{picUrl}}"></image>
```

æ­Œæ›²æš‚åœçš„æ—¶å€™ï¼Œå°é¢è¦åœåœ¨é‚£ä¸€å¸§çš„çŠ¶æ€ï¼Œä½¿ç”¨CSS3é‡Œçš„`animation-play-state: paused;`

```css
.rotation{
  animation: rotation 12s linear infinite;
  -moz-animation: rotation 12s linear infinite;
  -webkit-animation: rotation 12s linear infinite;
  -o-animation: rotation 12s linear infinite ;
}
.rotation-paused{
  /* å®šæ ¼åœ¨åŠ¨ç”»çš„æŸä¸€å¸§ */
  animation-play-state: paused;
}
@keyframes rotation{
  from{
    transform: rotate(0deg);
  }
  to{
    transform: rotate(360deg);
  }
}
```

æŒ‡é’ˆçš„æ‘†æ”¾ğŸ‘‡

```html
<view class="player-disc {{isPlaying?'play':''}}">
```

```css
.player-disc::after{
  content: '';
  width: 192rpx;
  height: 274rpx;
  position: absolute;
  top: -150rpx;
  left: 266rpx;
  background: url('https://s3.music.126.net/m/s/img/needle.png?702cf6d95f29e2e594f53a3caab50e12') no-repeat center/contain;
  transform: rotate(-15deg);
  transform-origin: 24rpx 10rpx;
  transition: transform 0.5s ease;
}
.play.player-disc::after{
  transform: rotate(0deg)
}
```

ä¸Šä¸€é¦–/ä¸‹ä¸€é¦–åˆ‡æ¢ğŸ‘‡

```js
  onPrev(){
    nowPlayingIndex--
    if(nowPlayingIndex<0){
      nowPlayingIndex = musiclist.length-1
    }
    this._loadMusicDetail(musiclist[nowPlayingIndex].id)
  },
  onNext(){
    nowPlayingIndex++
    if (nowPlayingIndex == musiclist.length) {
      nowPlayingIndex = 0
    }
    this._loadMusicDetail(musiclist[nowPlayingIndex].id)
  },
```

### è¿›åº¦æ¡ç»„ä»¶

#### ç»“æ„å¸ƒå±€

æ–°å»ºè¿›åº¦æ¡ç»„ä»¶`/miniprogram/components/progress-bar/cmp `ï¼Œæ’­æ”¾é¡µè¦å¼•ç”¨ï¼Œæ‰€ä»¥åœ¨`/miniprogram/pages/player/player.json `ä¸­å¼•å…¥è¯¥ç»„ä»¶ğŸ‘‡

```json
{
  "usingComponents": {
    "progress-bar": "../../components/progress-bar/cmp"
  }
}
```

å¼€å§‹ç¼–å†™è¯¥ç»„ä»¶ä»£ç ã€‚

è¿›åº¦æ¡éœ€è¦å¯ä»¥ç§»åŠ¨ï¼Œè¿™é‡Œç”¨åˆ°äº†æ–°çš„æ ‡ç­¾`<progress>`ã€ `<movable-area>`å’Œ`<movable-view>`ã€‚è¯¦è§[æ–‡æ¡£](https://developers.weixin.qq.com/miniprogram/dev/component/movable-area.html)

åˆæ­¥çš„å¸ƒå±€ğŸ‘‡

```html
<!--components/progress-bar/cmp.wxml-->
<view class="container">
  <text class="time">{{showTime.currentTime}}</text>
  <view class="control">
    <movable-area class="movable-area">
      <movable-view direction="horizontal" class="movable-view" damping="1000" x="{{movableDis}}" ></movable-view>
    </movable-area>
    <progress stroke-width="4" backgroundColor="#969696" activeColor="#fff" percent="{{progress}}"></progress>
  </view>
  <text class="time">{{showTime.totalTime}}</text>
</view>
```

```css
.container{
  display: flex;
  align-items: center;
}

.control {
  position: relative;
  flex: 1;
}
.movable-area{
  width: 100%;
  height: 34rpx;
  position: absolute;
  bottom: -14rpx;
  left: 0;
}
.movable-view{
  width: 36rpx;
  height: 36rpx;
  background-color: #fefefe;
  border-radius: 50%;
}
.time{
  color: #fff;
}
```

![](https://pic1.zhimg.com/80/v2-c771a30feb89a12d41d60ff182430908_hd.jpg)



#### è·å–èŠ‚ç‚¹å¸ƒå±€ä¿¡æ¯

å°ç¨‹åºä¸­æ²¡æœ‰Domæ“ä½œï¼Œä½†æ˜¯ä¾ç„¶èƒ½é€šè¿‡æŸäº›æ–¹æ³•è·å–åˆ°å…ƒç´ èŠ‚ç‚¹ã€‚

[wx.createSelectorQuery()](https://developers.weixin.qq.com/miniprogram/dev/api/wxml/wx.createSelectorQuery.html)è¿”å›ä¸€ä¸ª [SelectorQuery](https://developers.weixin.qq.com/miniprogram/dev/api/wxml/SelectorQuery.html) å¯¹è±¡å®ä¾‹ã€‚åœ¨è‡ªå®šä¹‰ç»„ä»¶æˆ–åŒ…å«è‡ªå®šä¹‰ç»„ä»¶çš„é¡µé¢ä¸­ï¼Œåº”ä½¿ç”¨ **this.createSelectorQuery()** æ¥ä»£æ›¿

```js
// miniprogram/components/progress-bar/cmp.js   
// ç»„ä»¶ç”Ÿå‘½å‘¨æœŸ
  lifetimes:{
    ready(){
      this._getMovableDis()
    }
  },

  /**
   * ç»„ä»¶çš„æ–¹æ³•åˆ—è¡¨
   */
  methods: {
    _getMovableDis(){
      // wx.createSelectorQuery()è¿”å›ä¸€ä¸ª SelectorQuery å¯¹è±¡å®ä¾‹ã€‚åœ¨è‡ªå®šä¹‰ç»„ä»¶æˆ–åŒ…å«è‡ªå®šä¹‰ç»„ä»¶çš„é¡µé¢ä¸­ï¼Œåº”ä½¿ç”¨ this.createSelectorQuery() æ¥ä»£æ›¿
      const query = this.createSelectorQuery()
      query.select('.movable-area').boundingClientRect()
      query.select('.movable-view').boundingClientRect()
      query.exec((rect)=>{
        console.log(rect)
        movabelAreaWidth = rect[0].width
        movableViewWidth = rect[1].width
      })
    }
  }
```

æ‰“å°ç»“æœå¦‚ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œå°ç¨‹åºè™½ç„¶æ— æ³•è·å–åˆ°domå…ƒç´ ï¼Œä½†æ˜¯å¯ä»¥å¾—åˆ°èŠ‚ç‚¹çš„å¸ƒå±€ã€å¤§å°ã€ä½ç½®ä¿¡æ¯ğŸ‘‡

![](https://pic3.zhimg.com/80/v2-991622b5bbeea7bad6b1943e3808bbbe_hd.jpg)

æ¥ä¸‹æ¥å°±å¯ä»¥é€šè¿‡è¿™äº›ä¿¡æ¯æ”¹å˜è¿›åº¦æ¡ä¸­æ»‘å—çš„ä½ç½®ã€‚



#### backgroundAudioManagerçš„æ–¹æ³•å’Œè·å–æ­Œæ›²æ€»æ—¶é—´

```js
    _bindBGMEvent(){
      backgroundAudioManager.onPlay(()=>{
        console.log('onPlay')
      })
      backgroundAudioManager.onStop(() => {
        console.log('onStop')
      })
      backgroundAudioManager.onPause(() => {
        console.log('onPause')
      })
      backgroundAudioManager.onWaiting(() => {
        console.log('onWaiting')
      })
      backgroundAudioManager.onCanplay(() => {
        console.log('onCanplay')
        console.log(backgroundAudioManager.duration) //ç»“æœæœ‰æ—¶å€™ä¸ºundefinedæœ‰æ—¶å€™åˆå¯ä»¥æ­£ç¡®è·å–åˆ°æ­Œæ›²æ€»æ—¶é•¿ï¼Œå°ç¨‹åºçš„ä¸€ä¸ªå‘ã€‚æ‰€ä»¥è¿™ä¸‹é¢è¿›è¡Œä¸€ä¸‹å¤„ç†
        if(typeof backgroundAudioManager.duration != 'undefined'){
          // å¦‚æœä¸ä¸ºundefinedåˆ™æ˜¯æ­£ç¡®å–åˆ°äº†duration
          this._setTime()
        }else{
          // å¦åˆ™å¯ä»¥ä½¿ç”¨å®šæ—¶å™¨ï¼Œè¿‡ä¸€ç§’ä¹‹åå†å–durationã€‚ å¥‡æŠ€æ·«å·§
          setTimeout(()=>{
            this._setTime()
          },1000)
        }
      })
      backgroundAudioManager.onTimeUpdate(() => {
        // æ’­æ”¾è¿‡ç¨‹ä¸­ä¸€ç›´éƒ½ä¼šå‘ç”Ÿï¼Œæš‚åœçš„æ—¶å€™å‘ç”Ÿä¸€æ¬¡ï¼Œé¡µé¢åˆ‡æ¢æ—¶åˆä¼šé‡æ–°å‘ç”Ÿ
        console.log('onTimeUpdate')
      })
      backgroundAudioManager.onEnded(() => {
        console.log('onEnded')
      })
      backgroundAudioManager.onError(() => {
        console.log('onError')
      })
    },
```

```js
    _setTime(){
      const duration = backgroundAudioManager.duration
      console.log(duration)  //æ˜¯ç§’çš„æ ¼å¼
      const durationFmt = this._TimeFormat(duration) //æ ¼å¼åŒ–ä¸ºåˆ†ç§’æ ¼å¼
      console.log(durationFmt)
      this.setData({
        ['showTime.totalTime']: `${durationFmt.min}:${durationFmt.sec}`
      })
    },

    _TimeFormat(second){
      const min = Math.floor(second / 60) 
      const sec = Math.floor(second % 60)
      return {
        'min': this._add0(min),
        'sec': this._add0(sec)
      }
    },
    // å¯¹äºå°äº10çš„åˆ†å’Œç§’è¦åœ¨å‰é¢è¡¥ä¸Š0
    _add0(time){
      return time<10?'0'+time:''+time
    }
```

è¿™é‡Œæ³¨æ„ä¸€ä¸‹åœ¨setDataçš„æ—¶å€™å¦‚æœåªæƒ³æ”¹å˜å¯¹è±¡ä¸­çš„ä¸€ä¸ªå±æ€§ï¼Œå¯ä»¥ä½¿ç”¨è¿™ç§æ ¼å¼è®¾ç½®ğŸ‘‰` ['obj.abc']: xxx`ã€‚

ä¸Šé¢çš„æ–¹æ³•è·å–åˆ°äº†å½“å‰æ’­æ”¾æ­Œæ›²çš„æ€»æ—¶é•¿ï¼Œç»è¿‡æ ¼å¼åŒ–ä¹‹åèµ‹å€¼ç»™ `showTime.totalTime`ï¼Œæ•ˆæœå¦‚ä¸‹ğŸ‘‡

![](https://pic1.zhimg.com/80/v2-5ece2082a119f4ff917fdeff27a5fb3c_hd.png)



#### è¿›åº¦æ¡ä¸æ’­æ”¾çŠ¶æ€è”åŠ¨

```html
      <movable-view direction="horizontal" class="movable-view" damping="1000" x="{{movableDis}}" ></movable-view>
    </movable-area>
    <progress stroke-width="4" backgroundColor="#969696" activeColor="#fff" percent="{{progress}}"></progress>
```

`<movable-view>`ä¸­çš„`x`å±æ€§å°±æ˜¯å…¶è·ç¦»å·¦è¾¹çš„é•¿åº¦ï¼Œ`<progress>`ä¸­çš„`percent`å±æ€§æ˜¯æ»‘åŠ¨æ¡å·¦ä¾§çš„è·ç¦»ï¼Œè¿›åº¦æ¡äºŒè¿˜æ’­æ”¾äº‹ä»¶çš„è”åŠ¨å…³é”®å°±æ˜¯æ”¹å˜è¿™ä¸¤è€…çš„æ•°å€¼å¤§å°ï¼Œè€Œè¿™ä¸ªè¿‡ç¨‹åœ¨`backgroundAudioManager.onTimeUpdate()`ä¸­å‘ç”Ÿã€‚

```js
      backgroundAudioManager.onTimeUpdate(() => {
        // æ’­æ”¾è¿‡ç¨‹ä¸­ä¸€ç›´éƒ½ä¼šå‘ç”Ÿï¼Œæš‚åœçš„æ—¶å€™å‘ç”Ÿä¸€æ¬¡ï¼Œé¡µé¢åˆ‡æ¢æ—¶åˆä¼šé‡æ–°å‘ç”Ÿ
        console.log('onTimeUpdate')
        const currentTime = backgroundAudioManager.currentTime
        console.log(currentTime)
        const duration = backgroundAudioManager.duration
        const currentTimeFmt = this._TimeFormat(currentTime)
        this.setData({
          movableDis:(movabelAreaWidth-movableViewWidth)*currentTime/duration,
          progress: currentTime / duration * 100,
          ['showTime.currentTime']: `${currentTimeFmt.min}:${currentTimeFmt.sec}`
        })
      })
```

ä¸Šé¢ä»£ç ä¸­è·å–å½“å‰èƒŒæ™¯éŸ³ä¹æ’­æ”¾æ—¶é—´ç”¨çš„æ˜¯`backgroundAudioManager.currentTime`ã€‚



##### ã€ä¼˜åŒ–ã€‘

![](https://pic1.zhimg.com/80/v2-37f63012c6134f77b7daae1b6ddcbb0b_hd.png)

è¿™ä¸ªè”åŠ¨é çš„æ˜¯`currentTime`ï¼Œä½†æ˜¯`currentTime`æ¯ä¸€ç§’ä¸­æœ‰å¥½å‡ ä¸ªï¼Œå¯¼è‡´ä¸€ç§’å†…ç¨‹åºå°±è®¾ç½®äº†å¥½å‡ æ¬¡ç›¸åŒçš„æ•°æ®ã€‚è¦åšå¾—ä¼˜åŒ–å°±æ˜¯å‡å°‘è¿™ç§é‡å¤çš„èµ‹å€¼ğŸ‘‡

```js
	let currentSec = -1 //å½“å‰ç§’æ•°

      backgroundAudioManager.onTimeUpdate(() => {
        // æ’­æ”¾è¿‡ç¨‹ä¸­ä¸€ç›´éƒ½ä¼šå‘ç”Ÿï¼Œæš‚åœçš„æ—¶å€™å‘ç”Ÿä¸€æ¬¡ï¼Œé¡µé¢åˆ‡æ¢æ—¶åˆä¼šé‡æ–°å‘ç”Ÿ
        // console.log('onTimeUpdate')
        const currentTime = backgroundAudioManager.currentTime
        // console.log(currentTime)
        const duration = backgroundAudioManager.duration
        let sec = currentTime.toString().split('.')[0]
        if(sec!=currentSec){
          console.log(sec)
          const currentTimeFmt = this._TimeFormat(currentTime)
          this.setData({
            movableDis:(movabelAreaWidth-movableViewWidth)*currentTime/duration,
            progress: currentTime / duration * 100,
            ['showTime.currentTime']: `${currentTimeFmt.min}:${currentTimeFmt.sec}`
          })
          // æ›´æ–°currentSec
          currentSec = sec
        }else{
          // ç§’æ•°ç›¸åŒçš„æƒ…å†µä¸‹å°±ä¸å†é‡å¤è¿›è¡Œä¸Šè¿°çš„èµ‹å€¼æ“ä½œäº†ï¼Œä¼˜åŒ–æ€§èƒ½
        }
      })
```



#### æ‹–æ‹½è¿›åº¦æ¡

è¦å®ç°æ‰‹åŠ¨æ‹–æ‹½è¿›åº¦æ¡è¿›è€Œæ”¹å˜æ­Œæ›²æ’­æ”¾è¿›åº¦ï¼Œè¿™é‡Œå°±è¦ç»™æ ‡ç­¾`movable-view`æ·»åŠ ä¸€ä¸ª`bindchange`äº‹ä»¶ï¼Œä½†æ˜¯åŒæ—¶è¦æ³¨æ„åˆ°ï¼Œå¦‚æœç”¨æˆ·åå¤å·¦å³æ‹–æ‹½è¿›åº¦æ¡ï¼Œè¿™ä¼šä½¿å¾—äº‹ä»¶ä¸æ–­è§¦å‘ï¼Œè¿™æ˜¯å¯¹å°ç¨‹åºçš„æ€§èƒ½å½±å“å¾ˆä¸å¥½çš„ä¸€ä»¶äº‹ã€‚æ‰€ä»¥åœ¨è¿™é‡Œè¦åšä¸€ä¸ªå¤„ç†ã€‚å†ç»™æ ‡ç­¾`movable-view`æ·»åŠ ä¸€ä¸ª`bindtouchend`äº‹ä»¶ï¼Œè¡¨ç¤ºå½“å‰è§¦æ‘¸ç»“æŸæ‰‹ç¦»å¼€å±å¹•çš„æ—¶å€™è§¦å‘äº‹ä»¶ã€‚ğŸ‘‡

```html
<movable-view direction="horizontal" class="movable-view" damping="1000" x="{{movableDis}}" bindchange="onChange" bindtouchend="onTouchEnd"/>
```

å½“ç”¨æˆ·æ¯æ¬¡å–æ‹–æ‹½ç§»åŠ¨è¿›åº¦æ¡çš„æ—¶å€™ï¼Œå‡½æ•°onChangeè·å–åˆ°ç§»åŠ¨åˆ°çš„è·ç¦»ï¼Œå½“ç»“æŸæ‹–æ‹½è§¦å‘touchendçš„æ—¶å€™ï¼Œå†åœ¨onTouchEndé‡Œé¢é€šè¿‡setDataçš„æ–¹å¼ï¼ŒæŠŠå½“æ—¶çš„çŠ¶æ€è®¾ç½®åˆ°è¿›åº¦æ¡ä¸­ã€‚ä½†æ˜¯è¿™é‡Œè¦æ³¨æ„åˆ°ï¼Œæˆ‘ä»¬ä¹‹å‰è®¾ç½®äº†è¿›åº¦æ¡ä¸æ’­æ”¾çŠ¶æ€è”åŠ¨çš„åŠŸèƒ½ï¼Œé€šè¿‡setDataæ”¹å˜movableDisï¼Œæ‰€ä»¥åœ¨æ­Œæ›²æ­£å¸¸æ’­æ”¾çš„æ—¶å€™è¿›åº¦æ¡æ˜¯åœ¨èµ°çš„ï¼Œä¹Ÿæ˜¯åœ¨ä¸æ–­è§¦å‘onchangeå‡½æ•°çš„ï¼Œæ‰€ä»¥è¿™é‡Œonchangeå‡½æ•°è¦å¤„ç†åˆ¤æ–­ä»¥ä¸‹ä»€ä¹ˆæ—¶å€™æ˜¯ç”¨æ‰‹æ‹–æ‹½å¯¼è‡´çš„çŠ¶æ€æ”¹å˜ï¼Œä»€ä¹ˆæ—¶å€™æ˜¯æ­Œæ›²æ­£å¸¸æ’­æ”¾å¯¼è‡´çš„çŠ¶æ€æ”¹å˜ï¼Œè¿™é‡Œé€šè¿‡`event.detail.source`æ¥åˆ¤æ–­ï¼Œï¼ˆ[è¯¦è§æ–‡æ¡£](https://developers.weixin.qq.com/miniprogram/dev/component/movable-view.html)ï¼‰å½“`event.detail.source`çš„å€¼ä¸ºç©ºå­—ç¬¦ä¸²çš„æ—¶å€™è¡¨ç¤ºæ˜¯æ­Œæ›²æ’­æ”¾å¼•èµ·çš„çŠ¶æ€æ”¹å˜ï¼Œè¿™æ—¶ä¸åšå¤„ç†ï¼›å½“`event.detail.source`çš„å€¼ä¸º'touch'çš„æ—¶å€™ï¼Œè¯´æ˜æ˜¯æ‰‹åŠ¨æ‹–æ‹½å¼•èµ·çš„ï¼Œè¿™æ—¶å°±è¦è¿›è¡Œç›¸å…³å¤„ç†äº†ã€‚

```js
    // miniprogram/components/progress-bar/cmp.js 
	onChange(event){
      console.log(event)
      // æ‹–åŠ¨
      if(event.detail.source == 'touch'){
        this.data.progress = event.detail.x / (movabelAreaWidth-movableViewWidth)*100
        this.data.movableDis = event.detail.x
        // æ‹–åŠ¨è¿‡ç¨‹ä¸­ä¸æ–­ä¿å­˜æ›´æ–°æ¯ä¸ªç¬é—´çš„çŠ¶æ€
      }

    },
    onTouchEnd(){
      const currentTimeFmt = this._TimeFormat(Math.floor(backgroundAudioManager.currentTime))
      this.setData({
        progress: this.data.progress,
        movableDis: this.data.movableDis,
        ['showTime.currentTime']: currentTimeFmt.min + ":" + currentTimeFmt.sec
      })
      // èƒŒæ™¯éŸ³ä¹è·³è½¬åˆ°æ‹–æ‹½å¤„å¯¹åº”çš„æ—¶åˆ»
      backgroundAudioManager.seek((this.data.progress/100)*duration)
      
    },
```

è¿™æ ·æ‰‹åŠ¨æ‹–æ‹½è¿›åº¦æ¡çš„åŠŸèƒ½å°±å®ç°äº†ã€‚

##### ã€ä¼˜åŒ–ã€‘

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæ‰‹åŠ¨æ‹–æ‹½è¿›åº¦æ¡å¹¶ä½¿æ­Œæ›²è·³è½¬åˆ°å¯¹åº”çš„çŠ¶æ€è¿™ä¸€åŠŸèƒ½æ˜¯å®ç°äº†ï¼Œä½†æ˜¯è¿˜æœ‰ä¸ªbugè¦ä¼˜åŒ–â€”â€”åœ¨æˆ‘ä»¬ç”¨æ‰‹æ‹–æ‹½è¿›åº¦æ¡çš„æ—¶å€™ï¼Œæ»‘å—æœ‰æ—¶å€™ä¼šè·³å›å»åŸæ¥çš„ä½ç½®ã€‚å› ä¸ºæ­Œæ›²ä¸€ç›´åœ¨æ’­æ”¾ï¼Œè€Œè¿™ä¸ªæ’­æ”¾è¿‡ç¨‹ä¸­ä¸€ç›´åœ¨æ›´æ–°è¿›åº¦æ¡çš„çŠ¶æ€ï¼ŒğŸ‘‡

```js
      backgroundAudioManager.onTimeUpdate(() => {
        // æ’­æ”¾è¿‡ç¨‹ä¸­ä¸€ç›´éƒ½ä¼šå‘ç”Ÿï¼Œæš‚åœçš„æ—¶å€™å‘ç”Ÿä¸€æ¬¡ï¼Œé¡µé¢åˆ‡æ¢æ—¶åˆä¼šé‡æ–°å‘ç”Ÿ
        // console.log('onTimeUpdate')
        const currentTime = backgroundAudioManager.currentTime
        // console.log(currentTime)
        const duration = backgroundAudioManager.duration
        let sec = currentTime.toString().split('.')[0]
        if(sec!=currentSec){
          // console.log(sec)
          const currentTimeFmt = this._TimeFormat(currentTime)
          this.setData({
            movableDis:(movabelAreaWidth-movableViewWidth)*currentTime/duration,
            progress: currentTime / duration * 100,
            ['showTime.currentTime']: `${currentTimeFmt.min}:${currentTimeFmt.sec}`
          })
          // æ›´æ–°currentSec
          currentSec = sec
        }else{
          // ç§’æ•°ç›¸åŒçš„æƒ…å†µä¸‹å°±ä¸å†é‡å¤è¿›è¡Œä¸Šè¿°çš„èµ‹å€¼æ“ä½œäº†ï¼Œä¼˜åŒ–æ€§èƒ½
        }
      })
```

æˆ‘ä»¬å¸Œæœ›åœ¨æ‹–æ‹½è¿›åº¦æ¡çš„æ—¶å€™æš‚åœå› æ­Œæ›²æ’­æ”¾å¯¼è‡´çš„æ›´æ–°è¿›åº¦æ¡æ“ä½œã€‚

æˆ‘ä»¬è¦åŠ ä¸Šä¸€ä¸ªã€é”ç»“æ„ã€‘

```js
// æ ‡å¿—å½“å‰è¿›åº¦æ¡æ˜¯å¦åœ¨æ‹–æ‹½ï¼Œå¦‚æœfalseåˆ™onTimeUpdateæ—¶æ›´æ–°çŠ¶æ€ï¼Œå¦åˆ™ä¸Šé”
// è§£å†³å½“è¿›åº¦æ¡æ‹–åŠ¨çš„æ—¶å€™å’ŒbackgroundAudioManager.onTimeUpdateäº‹ä»¶å†²çªé—®é¢˜
let isMving = false 
...
  methods: {
    onChange(event){
      if(event.detail.source == 'touch'){
        isMoving = true //ä¸Šé”
        ...
      }

    },
    onTouchEnd(){
      ...
      isMoving = false //è§£é”
    },
	 _bindBGMEvent(){
      backgroundAudioManager.onPlay(()=>{
        isMoving = false //è§£é”,åœ¨è¿™é‡Œè§£é”æ˜¯æœ€ä¿é™©çš„ï¼Œå› ä¸ºæœ‰æ—¶å€™onTouchEndè§£é”ååˆä¼šè§¦å‘onChangeï¼Œç®—æ˜¯å°ç¨‹åºçš„ä¸€ä¸ªå‘
      })
```

åªæœ‰å½“isMovingä¸ºfalseçš„æ—¶å€™æ‰è¿›è¡Œåç»­çš„setDatağŸ‘‡

![](https://pic2.zhimg.com/80/v2-f32bcc5c7816021b5f20c323aa94d01b_hd.png)



### è‡ªåŠ¨æ’­æ”¾ä¸‹ä¸€é¦–

å½“å‰æ­Œæ›²æ’­æ”¾å®Œæˆåä¼šè§¦å‘backgroundAudioManagerä¸€ä¸ªonEndedäº‹ä»¶ã€‚

æˆ‘ä»¬åœ¨ä¸Šé¢/miniprogram/pages/player/player.js ä¸­å®ç°è¿‡ä¸€ä¸ªä¸‹ä¸€é¦–çš„åŠŸèƒ½ï¼Œå‡½æ•° onNext()ã€‚

é‚£ä¹ˆåªè¦åœ¨backgroundAudioManagerè§¦å‘äº†onEndedäº‹ä»¶çš„æ—¶å€™æ‰§è¡ŒonNextå°±å¯ä»¥å®ç°è‡ªåŠ¨æ’­æ”¾äº†ï¼š

```js
// miniprogram/pages/player/player.js
    onLoad: function (options) {
    backgroundAudioManager.onEnded(() => {
      this.onNext() //è°ƒç”¨onNextï¼Œåˆ‡æ¢ä¸‹ä¸€é¦–
    })

    console.log(options)
    nowPlayingIndex = options.index
    musiclist = wx.getStorageSync('musiclist')
    this._loadMusicDetail(options.musicId)
  },
```



è¿˜å¯ä»¥åœ¨è¿›åº¦æ¡ç»„ä»¶å†…éƒ¨å®Œæˆè¿™ä¸ªåŠŸèƒ½ï¼Œç”¨åˆ°çˆ¶å­ç»„ä»¶é€šè®¯çš„æ–¹å¼ã€‚è¿›åº¦æ¡ç»„ä»¶ä½œä¸ºæ’­æ”¾å™¨é¡µé¢çš„ä¸€ä¸ªå­ç»„ä»¶ï¼Œæƒ³è¦è°ƒç”¨pleyer.jsä¸­çš„onNextå‡½æ•°ï¼Œå°±éœ€è¦å­ç»„ä»¶å‘çˆ¶ç»„ä»¶é€šè®¯è®©çˆ¶ç»„ä»¶è°ƒç”¨onNextå‡½æ•°ã€‚

```js
      // miniprogram/components/progress-bar/cmp.js 
      backgroundAudioManager.onEnded(() => {
        console.log('onEnded')
        // è‡ªå®šä¹‰ç»„ä»¶è§¦å‘äº‹ä»¶
        this.triggerEvent('musicEnd')
      })
```

```html
// miniprogram/pages/player/player.wxml 
<!-- è¿›åº¦æ¡ -->
<view class="progress-bar">
  <progress-bar  bind:musicEnd="onNext"/>
</view>
```

å°±æ˜¯è¿™ä¹ˆç®€å•å°±å®ç°äº†ï¼Œæ¯”èµ·ç¬¬ä¸€ç§æ–¹å¼è¿™ç§æ›´åŠ è§„èŒƒï¼Œæœ‰æ¡ç†ï¼Œè€Œä¸”å‡å°‘äº†åŠŸèƒ½è€¦åˆã€‚



### æ­Œè¯æ˜¾ç¤ºç»„ä»¶

å®ç°åŠŸèƒ½ï¼š

1. ç‚¹å‡»å°é¢æ—¶æ˜¾ç¤ºæ­Œè¯ï¼Œç‚¹å‡»æ­Œè¯æ—¶æ˜¾ç¤ºå°é¢
2. 



##### æ­Œè¯ä¸å°é¢çš„åˆ‡æ¢

è€æ ·å­æ–°å»º`/miniprogram/components/lyric/cmp`

/miniprogram/pages/player/player.json è¿›è¡Œç»„ä»¶çš„æ³¨å†Œå¼•å…¥ğŸ‘‡	

```json
{
  "usingComponents": {
    "progress-bar": "../../components/progress-bar/cmp",
    "lyric": "../../components/lyric/cmp"
  }
}
```

ç„¶ååœ¨/miniprogram/pages/player/player.wxml ä¸­å¼•ç”¨å°±æœ‰äº†ã€‚



å°é¢å’Œæ­Œè¯ç»„ä»¶éƒ½ç»‘å®šä¸€ä¸ªç‚¹å‡»äº‹ä»¶ï¼Œè§¦å‘å‡½æ•°onChangeLyricShowä¿®æ”¹å˜é‡isLyricShowï¼Œè€Œè¿™ä¸ªå˜é‡å†³å®šå°é¢å’Œæ­Œè¯çš„åˆ‡æ¢ã€‚

```h&#39;t&#39;m
<view class="player-disc {{isPlaying?'play':''}}" bindtap="onChangeLyricShow" hidden="{{isLyricShow}}">

...

<!-- æ­Œè¯ç»„ä»¶ -->
<lyric isLyricShow="{{!isLyricShow}}" bindtap="onChangeLyricShow"/>
```

```html
<!--components/lyric/cmp.wxml-->
<scroll-view hidden="{{isLyricShow}}">
æ­Œè¯
</scroll-view>

```

```js
  onChangeLyricShow(){
    this.setData({
      isLyricShow: !this.data.isLyricShow
    })
  },
```



##### åŠ è½½æ­Œè¯ä¹‹äº‘å‡½æ•°musicæ›´æ–°

```js
  // åŠ è½½æ­Œè¯æ•°æ®
  app.router("lyric", async(ctx, next)=>{
    ctx.body = await rp(BASE_URL+`/lyric?id=${event.musicId}`).thne(res=>{
      return res
    })
  })
```



##### è°ƒç”¨äº‘å‡½æ•°è·å–æ­Œè¯å¹¶ä¿å­˜

```js
// åœ¨å…³é—­åŠ è½½åŠ¨ç”»å

      // åŠ è½½æ­Œè¯
      wx.cloud.callFunction({
        name: 'music',
        data:{
          musicId,
          $url: 'lyric'
        }
      }).then(res=>{
        console.log(res)
        let lyric = 'æš‚æ— æ­Œè¯'
        const lrc = JSON.parse(res.result).lrc
        if(lrc){
          lyric = lrc.lyric
        }
        this.setData({
          lyric: lyric
        })
      })
```

å°†/miniprogram/pages/player/player.js ä¸­çš„lyricæ•°æ®ä¼ ç»™æ­Œè¯ç»„ä»¶ğŸ‘‡

```html
<!-- æ­Œè¯ç»„ä»¶ -->
<lyric isLyricShow="{{!isLyricShow}}" bindtap="onChangeLyricShow" lyric="{{lyric}}"/>
```

åœ¨æ­Œè¯ç»„ä»¶çš„jsæ–‡ä»¶ä¸­ğŸ‘‡

```js
  properties: {
    isLyricShow:{
      type: Boolean,
      value: false
    },
    lyric: String,
  },

  observers: {
    lyric(lrc){
      console.log(lrc)
    }
  },

```

æ‰“å°ç»“æœå¦‚ä¸‹ï¼Œå¯ä»¥ä¸€çª¥æ­Œè¯æ•°æ®çš„æ‘¸æ ·ğŸ‘‡

![](https://pic2.zhimg.com/80/v2-eb4794dbd0df6dbd08489b82185600a8_hd.png)

è¿™æ ·çš„æ•°æ®éœ€è¦åšè¿›ä¸€æ­¥è§£æã€‚



##### æ­Œè¯æ•°æ®è§£æ

åœ¨æ­Œè¯ç»„ä»¶ä¸­å®šä¹‰å‡½æ•°ï¼Œåšå¯¹æ­Œè¯æ•°æ®çš„è§£æï¼Œå…¶ä¸­ä¹ŸåŒ…æ‹¬äº†å¯¹æ— æ­Œè¯æƒ…å†µçš„å¤„ç†ï¼š

```js
    _paresLyric(sLyric) {
      let line = sLyric.split('\n')
      let _lyricList = []
      line.forEach((elem)=>{
        let time = elem.match(/\[(\d{2,}):(\d{2})(?:\.(\d{2,3}))?]/g)
        if(time!=null){
          let lrc = elem.split(time)[1]
          let timeReg = time[0].match(/(\d{2,}):(\d{2})(?:\.(\d{2,3}))?/)
          // æŠŠäº‹ä»¶è½¬æ¢ä¸ºç§’
          let time2Seconds = parseInt(timeReg[1]*60)+parseInt(timeReg[2])+parseInt(timeReg[3])/1000
          _lyricList.push({
            lrc,
            time: time2Seconds
          })
        }
      })
      // æœ‰äº›æ­Œè¯æ˜¯ç©ºçš„ï¼Œä¸Šè¿°çš„è§£æå¯¹å…¶æ— æ•ˆï¼Œ_lyricListä»æ˜¯ç©ºçš„ï¼Œåˆ™è®¾ç½®ä¸ºæš‚æ— æ­Œè¯
      if(_lyricList.length==0){
        _lyricList.push({
          lrc: "æš‚æ— æ­Œè¯",
          time: 0
        })
        console.log(_lyricList)
      }
        
      this.setData({
        lrclist: _lyricList
      })
       console.log(this.data.lrclist)
    }
```

æ•°æ®è§£æå®Œæˆåæ‰“å°å‡ºæ¥å¦‚ä¸‹ğŸ‘‡

![](https://pic3.zhimg.com/v2-d86e763974f40d002f04ee2c4e51c90e_r.jpg)

æ¥ä¸‹æ¥å°±å¯ä»¥ä½¿ç”¨è¯¥æ•°æ®æ¸²æŸ“åˆ°é¡µé¢ä¸Šã€‚

![](https://pic4.zhimg.com/80/v2-d80136333f400903755e71f850b32f6b_hd.jpg)





##### æ­Œè¯è”åŠ¨

ä¹‹å‰åœ¨è¿›åº¦æ¡ç»„ä»¶progress-barä¸­ï¼Œ`backgroundAudioManager.onTimeUpdate`å¯ä»¥è·å–åˆ°å½“å‰æ—¶é—´çš„ç§’æ•°`backgroundAudioManager.currentTime`ï¼Œå°†å…¶å’Œæ­Œè¯ç»„ä»¶lyricä¸­çš„å½“å‰`lrclist.time`è¿›è¡Œæ¯”è¾ƒï¼Œè‹¥ç›¸åŒåˆ™å½“å‰çš„`lrclist.lrc`å³ä¸ºé«˜äº®æ ·å¼ã€‚

è¿™æ ·éœ€è¦è¿›è¡Œç»„ä»¶é—´çš„é€šè®¯ï¼Œè¦æŠŠè¿›åº¦æ¡ç»„ä»¶progress-barçš„`backgroundAudioManager.currentTime`ä¼ ç»™æ­Œè¯ç»„ä»¶lyricã€‚

è¿™é‡Œåšçš„æ˜¯å…ˆæŠŠè¿›åº¦æ¡ç»„ä»¶progress-barçš„`backgroundAudioManager.currentTime`ä¼ ç»™è°ƒç”¨å®ƒçš„çˆ¶çº§â€”â€”æ’­æ”¾å™¨é¡µé¢playerï¼Œç„¶åplayerå†å°†`backgroundAudioManager.currentTime`ä¿å­˜å¹¶ä¼ ç»™æ­Œè¯ç»„ä»¶lyricï¼Œçˆ¶çº§æ’­æ”¾å™¨é¡µé¢ä½œä¸ºä¸­é—´äººå®ç°äº†ä¸¤ä¸ªå­ç»„ä»¶ä¹‹é—´çš„é€šè®¯ã€‚

è¿™é‡Œæˆ‘æ€è·¯æœ‰äº†é—®é¢˜ï¼Œæˆ‘ä¸€å¼€å§‹æ˜¯æƒ³è¦è¿›åº¦æ¡ç»„ä»¶progress-barçš„`backgroundAudioManager.onTimeUpdate`é€šè¿‡triggerEventæ¥è‡ªå®šä¹‰ä¸€ä¸ªäº‹ä»¶è®©çˆ¶çº§playerè§¦å‘ï¼ŒåŒæ—¶æŠŠ`backgroundAudioManager.currentTime`ä½œä¸ºå‚æ•°ä¼ è¿‡å»ï¼Œè¿™ä¸€æ­¥æ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚ä¸‹ä¸€æ­¥æˆ‘æƒ³å½“ç„¶çš„è®©playerè§¦å‘äº‹ä»¶æ‰§è¡Œå‡½æ•°ï¼ŒæŠŠå‚æ•°å­˜åˆ°dataä¸­ï¼Œç„¶åå¦ä¸€ä¸ªå­ç»„ä»¶æ­Œè¯ç»„ä»¶ä¸­è‡ªå®šä¹‰ä¸€ä¸ªå±æ€§ï¼Œå±æ€§å€¼ä¸ºæˆ‘ä»¬ä¿å­˜åˆ°dataä¸­`backgroundAudioManager.currentTime`ï¼Œè¿™æ ·æ­Œè¯ç»„ä»¶å°±è·å–åˆ°äº†æˆ‘ä»¬æƒ³è¦çš„æ•°æ®ã€‚**ä½†æ˜¯ï¼**è¿™ç§æ–¹å¼æ˜¯ä¸€æ¬¡æ€§çš„ï¼Œéšådataçš„æ•°æ®éšç€æ’­æ”¾çš„è¿›è¡Œè€Œæ”¹å˜ï¼Œè€Œæ­Œè¯ç»„ä»¶ä¸­ä¿å­˜çš„æ°¸è¿œæ˜¯ä¸€å¼€å§‹çš„åˆå§‹æ•°æ®ï¼Œå®ƒæ˜¯ä¸ä¼šæ•°æ®è”åŠ¨çš„ã€‚

æ­£ç¡®åšæ³•å¦‚ä¸‹ğŸ‘‡

ç»™æ­Œè¯ç»„ä»¶å…ƒç´ åŠ ä¸Šä¸€ä¸ªç±»åï¼Œæ¥ä¸‹æ¥è¦è·å–åˆ°å®ƒï¼š

```html
/miniprogram/pages/player/player.wxml 
<!-- æ­Œè¯ç»„ä»¶ -->
<lyric class="lyric" isLyricShow="{{!isLyricShow}}" bindtap="onChangeLyricShow" lyric="{{lyric}}" />
```

åœ¨/miniprogram/pages/player/player.js ä¸­é€šè¿‡`this.selectComponent('.lyric')`è·å–åˆ°å®ƒã€‚è¿™æ˜¯æˆ‘ç¬¬ä¸€æ¬¡ç”¨åˆ°è‡ªå®šä¹‰ç»„ä»¶çš„[selectComponent](https://developers.weixin.qq.com/miniprogram/dev/reference/api/Component.html)æ–¹æ³•ï¼Œä½¿ç”¨é€‰æ‹©å™¨é€‰æ‹©ç»„ä»¶å®ä¾‹èŠ‚ç‚¹ï¼Œè¿”å›åŒ¹é…åˆ°çš„ç¬¬ä¸€ä¸ªç»„ä»¶å®ä¾‹å¯¹è±¡ã€‚

```js
  timeUpdate(event){
    // console.log(event.detail.currentTime)
    this.selectComponent('.lyric').update(event.detail.currentTime)
  },
```

è¿™é‡Œçš„updateæ–¹æ³•è¦åœ¨æ­Œè¯ç»„ä»¶lyricä¸­è¿›è¡Œå®šä¹‰ï¼š

```js
    update(currentTime){
      console.log(currentTime)
    },
```

æ¥ä¸‹æ¥æˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ°éšç€æ­Œæ›²çš„æ’­æ”¾ï¼Œåœ¨æ­Œè¯ç»„ä»¶ä¸­ä¸æ–­æ‰“å°å‡ºä¼ å…¥çš„å‚æ•°currentTimeã€‚æˆ‘ä»¬å°±æˆåŠŸåœ¨æ­Œè¯ç»„ä»¶ä¸­è·å–åˆ°äº†å½“å‰æ’­æ”¾çš„ç§’æ•°ï¼Œæ‰€ä»¥å¯ä»¥è¿›è¡Œä¸‹ä¸€æ­¥çš„åŒ¹é…äº†ã€‚

```js
    update(currentTime){
      // console.log(currentTime)
      let lrcList = this.data.lrclist
      if(lrcList.length == 0){ //å¦‚æœæ²¡æœ‰æ­Œè¯çº¯éŸ³ä¹ï¼Œç›´æ¥é€€å‡ºå•¥ä¹Ÿä¸å¹²
        return
      }
      for(let i = 0, len = lrcList.length; i < len; i++){
        if(currentTime<=lrcList[i].time){
          this.setData({
            nowLyricIndex: i-1
          })
          break // åŒ¹é…ä¸Šäº†å°±ä¸ç”¨å†è¿›è¡Œåç»­çš„åŒ¹é…äº†ï¼ŒèŠ‚çœæ€§èƒ½å¼€é”€
        }
      }
    },
```

æ ·å¼éšç€nowLyricIndexè€Œæ”¹å˜ğŸ‘‡

```html
<!--components/lyric/cmp.wxml-->

<scroll-view hidden="{{isLyricShow}}" class="lyric-scroll">
  <view class="lyric-panel">
    <block wx:for="{{lrclist}}" wx:key="item">
      <view class="lyric {{index==nowLyricIndex?'hightlight-lyric':''}}">{{item.lrc}}</view>
    </block>
  </view>
</scroll-view>
```

æ•ˆæœå¦‚ä¸‹ğŸ‘‡

![](https://pic2.zhimg.com/80/v2-9cb654d2edd0362165b0ceba5ff13875_hd.png)

æ¥ä¸‹æ¥è¦è§£å†³çš„å°±æ˜¯é«˜äº®éƒ¨åˆ†å±…ä¸­ä¸åŠ¨ï¼Œæ­Œè¯å‘ä¸Šæ»šåŠ¨ã€‚

æ­Œè¯éƒ¨åˆ†æ˜¯ç”¨`scroll-view`åŒ…èµ·æ¥çš„ï¼Œè®¾ç½®`scroll-top`ï¼Œ`scroll-y`è§„å®šçºµå‘æ»šåŠ¨ï¼Œ`scroll-with-animation="true"`ä½¿æ»šåŠ¨æœ‰åŠ¨ç”»æ•ˆæœã€‚ä¸æ–­å˜åŒ–`scroll-top`å…¶å€¼å®ç°æ»šåŠ¨æ•ˆæœï¼š

```html
<!--components/lyric/cmp.wxml-->

<scroll-view hidden="{{isLyricShow}}" class="lyric-scroll" scroll-top="{{scrollTop}}" scroll-y>
  <view class="lyric-panel">
    <block wx:for="{{lrclist}}" wx:key="item">
      <view class="lyric {{index==nowLyricIndex?'hightlight-lyric':''}}">{{item.lrc}}</view>
    </block>
  </view>
</scroll-view>

```

```js
// components/lyric/cmp.js
let lyricHeight = 0 

// ç»„ä»¶ç”Ÿå‘½å‘¨æœŸ
  lifetimes:{
    ready(){
      // wx.getSystemInfoå¯ä»¥è·å–åˆ°å½“å‰æ‰‹æœºçš„ä¿¡æ¯ï¼Œå…¶ä¸­åŒ…æ‹¬å±å¹•å®½åº¦screenWidth
      wx.getSystemInfo({
        success: function(res) {
          // åœ¨å°ç¨‹åºä¸­å®½åº¦éƒ½ä¸º750rpxï¼Œä¸‹é¢å¯ä»¥æ±‚å‡º1rpxå¯¹åº”å¤šå°‘pxï¼Œå†ä¹˜ä»¥ä¸€è¡Œæ­Œè¯çš„é«˜åº¦64rpxï¼Œ
          // å³å¯æ±‚å‡ºä¸€è¡Œæ­Œè¯æœ‰å¤šå°‘px
          lyricHeight = res.screenWidth / 750 * 64
        },
      })
    }
  },
  
```

```js
    update(currentTime){
      // console.log(currentTime)
      let lrcList = this.data.lrclist
      if(lrcList.length == 0){ //å¦‚æœæ²¡æœ‰æ­Œè¯çº¯éŸ³ä¹ï¼Œç›´æ¥é€€å‡ºå•¥ä¹Ÿä¸å¹²
        return
      }
      for(let i = 0, len = lrcList.length; i < len; i++){
        if(currentTime<=lrcList[i].time){
          this.setData({
            nowLyricIndex: i-1,
            scrollTop: (i-1)*lyricHeight
          })
          break // åŒ¹é…ä¸Šäº†å°±ä¸ç”¨å†è¿›è¡Œåç»­çš„åŒ¹é…äº†ï¼ŒèŠ‚çœæ€§èƒ½å¼€é”€
        }
      }
    },
```

è¿™é‡Œçš„æ¯è¡Œæ­Œè¯åœ¨æ ·å¼ä¸­å·²ç»å†™æ­»äº†64rpxï¼Œæ‰€ä»¥ä¸æ–­ç´¯ä¹˜å°±è¡Œäº†ã€‚ä½†æ˜¯scroll-topè§„å®šçš„å€¼å•ä½æ˜¯pxï¼Œæ‰€ä»¥è¦è¿›è¡Œrpxå’Œpxçš„æ¢ç®—ã€‚å…·ä½“å¦‚ä¸ŠğŸ‘†

åˆ°è¿™ä¸€æ­¥ï¼Œæ­Œè¯è”åŠ¨åŸºæœ¬å®ç°äº†ã€‚


##### ã€ä¼˜åŒ–ã€‘

å¾ˆå¤šæ­Œçš„æ­Œè¯æ•°æ®æ˜¯è¿™æ ·çš„ï¼Œæ¯”å¦‚å­™ç‡•å§¿çš„ã€Šå¼€å§‹æ‡‚äº†ã€‹å…¨æ›²4åˆ†32ç§’ï¼Œä½†æ˜¯æ­Œè¯æ•°æ®çš„æœ€åä¸€è¡Œæ˜¯`[03:58.830] å¿«ä¹æ˜¯é€‰æ‹©`ï¼Œè¿™å°±å¯¼è‡´äº†ä¸€ä¸ªbugï¼Œå½“æˆ‘æ»‘åŠ¨è¿›åº¦æ¡åˆ°4åˆ†04ç§’çš„æ—¶å€™ï¼Œ`currentTime<=lrcList[i].time`çš„åˆ¤å®šä¸æˆç«‹ï¼Œæ‰€ä»¥åç»­çš„setDataä¹Ÿä¸æˆç«‹ï¼Œæ­Œè¯è”åŠ¨å¤±è´¥ã€‚

é‚£ä¹ˆå°±è¦è¿›è¡Œä¸€ä¸‹ä¼˜åŒ–ï¼Œå½“å½“å‰æ—¶é—´è¶…è¿‡äº†æ­Œè¯æ•°æ®çš„æœ€åä¸€ç»„çš„æ—¶é—´çš„æ—¶å€™ï¼Œå°±æŠŠnowLyricIndexç½®ä¸º`lrcList.length-1`ï¼Œç›´æ¥è®©æœ€åä¸€ç»„æ­Œè¯é«˜äº®ï¼Œæ»šåŠ¨é•¿åº¦ä¸ºlrcList.length * lyricHeight

```js
    update(currentTime){
      // console.log(currentTime)
      let lrcList = this.data.lrclist
      if(lrcList.length == 0){ //å¦‚æœæ²¡æœ‰æ­Œè¯çº¯éŸ³ä¹ï¼Œç›´æ¥é€€å‡ºå•¥ä¹Ÿä¸å¹²
        return
      }
      // å¦‚æœå½“å‰çš„æ—¶é—´æ¯”æ­Œè¯æ•°æ®çš„æœ€åä¸€ç»„éƒ½è¦å¤§ï¼Œç›´æ¥è®©æœ€åä¸€ç»„æ­Œè¯é«˜äº®ï¼Œæ»šåŠ¨é•¿åº¦ä¸ºlrcList.length * lyricHeight
      if (currentTime > lrcList[lrcList.length-1].time){
        this.setData({
          nowLyricIndex: lrcList.length-1,
          scrollTop: lrcList.length * lyricHeight
        })
      }
      for(let i = 0, len = lrcList.length; i < len; i++){
        if(currentTime<=lrcList[i].time){
          this.setData({
            nowLyricIndex: i-1,
            scrollTop: (i-1)*lyricHeight
          })
          break // åŒ¹é…ä¸Šäº†å°±ä¸ç”¨å†è¿›è¡Œåç»­çš„åŒ¹é…äº†ï¼ŒèŠ‚çœæ€§èƒ½å¼€é”€
        }else{
          
        }
      }
    },
```



### ã€ä¼˜åŒ–ã€‘

ç›®å‰æœ‰ä¸ªbugï¼Œæˆ‘åœ¨æ­Œæ›²åˆ—è¡¨ç‚¹å‡»æŸä¸€é¦–æ­Œï¼Œæ­Œæ›²é«˜äº®å¹¶æ’­æ”¾ï¼Œä½†å½“åˆ‡æ¢åˆ°å…¶ä»–æ­Œæ›²æ—¶ï¼Œé«˜äº®æ²¡æœ‰è·Ÿç€å˜æˆå½“å‰æ’­æ”¾çš„æ­Œæ›²ä»æ—¶ä¹‹å‰çš„æ­Œæ›²ï¼Œå¦å¤–å½“æˆ‘ç¦»å¼€è¿™ä¸ªæ­Œæ›²åˆ—è¡¨é¡µçš„ç„¶åå†æ¬¡è¿›å…¥è¯¥æ­Œæ›²åˆ—è¡¨é¡µçš„æ—¶å€™ï¼Œå½“å‰æ’­æ”¾æ­Œæ›²æ²¡æœ‰æ˜¾ç¤ºé«˜äº®ã€‚

è¿™æ˜¯å› ä¸ºé«˜äº®å¤„ç†æ˜¯æ ¹æ®æ­Œæ›²åˆ—è¡¨ç»„ä»¶musiclistä¸­çš„`playingId`æ¥åˆ¤æ–­çš„ã€‚`{{item.id===playingId?'playing':''}}`ã€‚æ¯æ¬¡åˆ‡æ¢å…¶ä»–æ­Œæ›²çš„æ—¶å€™`playingId`æ²¡æœ‰æ”¹å˜ï¼Œè€Œç¦»å¼€åˆ—è¡¨é¡µå†æ¬¡è¿›å…¥çš„æ—¶å€™`playingId`åˆå˜æˆäº†é»˜è®¤çš„-1ã€‚

```html
<!--components/musiclist/cmp.wxml-->
<block wx:for="{{musiclist}}" wx:key="id">
  <view class="musiclist-container  {{item.id===playingId?'playing':''}}" bindtap="onSelect" data-musicid="{{item.id}}" data-index="{{index}}" >
    <view class="musiclist-index">{{index+1}}</view>
    <view class="musiclist-info">
      <view class="musiclist-name">{{item.name}}</view>
      <view class="musiclist-singer">{{item.ar[0].name}} - {{item.al.name}}</view>
    </view>
  </view>
</block>
```

æ‰€ä»¥éœ€è¦æœ‰ä¸€ä¸ªå…¬å…±çš„å±æ€§`playingId`ï¼ŒÂ·playingId`ä¸èƒ½åªå±äºæ’­æ”¾åˆ—è¡¨ç»„ä»¶ã€‚

å¼€å§‹ä½¿ç”¨app.jsè¿›è¡Œå…¬å…±å±æ€§æ“ä½œğŸ‘‡

app.jsæ˜¯å°ç¨‹åºå…¨å±€çš„æ“ä½œï¼Œåˆå§‹çŠ¶æ€çš„app.jsğŸ‘‡

```js
//app.js
App({
  onLaunch: function () {
    
    if (!wx.cloud) {
      console.error('è¯·ä½¿ç”¨ 2.2.3 æˆ–ä»¥ä¸Šçš„åŸºç¡€åº“ä»¥ä½¿ç”¨äº‘èƒ½åŠ›')
    } else {
      wx.cloud.init({
        // env å‚æ•°è¯´æ˜ï¼š
        //   env å‚æ•°å†³å®šæ¥ä¸‹æ¥å°ç¨‹åºå‘èµ·çš„äº‘å¼€å‘è°ƒç”¨ï¼ˆwx.cloud.xxxï¼‰ä¼šé»˜è®¤è¯·æ±‚åˆ°å“ªä¸ªäº‘ç¯å¢ƒçš„èµ„æº
        //   æ­¤å¤„è¯·å¡«å…¥ç¯å¢ƒ ID, ç¯å¢ƒ ID å¯æ‰“å¼€äº‘æ§åˆ¶å°æŸ¥çœ‹
        //   å¦‚ä¸å¡«åˆ™ä½¿ç”¨é»˜è®¤ç¯å¢ƒï¼ˆç¬¬ä¸€ä¸ªåˆ›å»ºçš„ç¯å¢ƒï¼‰
        env: 'dev-r049g',
        traceUser: true,  //è®°å½•å°ç¨‹åºçš„è®¿é—®è€…
      })
    }

    this.globalData = {}  //å…¨å±€å±æ€§å’Œæ–¹æ³•
  }
})

```

å°†è¦ç”¨åˆ°çš„å…¨å±€å…¬å…±å±æ€§å®šä¹‰åœ¨`this.globalData`ä¸­å¹¶å®šä¹‰å¯¹å…¶çš„èµ‹å€¼å–å€¼æ“ä½œï¼š

```js
//app.js
App({
  onLaunch: function () {
    
    if (!wx.cloud) {
      console.error('è¯·ä½¿ç”¨ 2.2.3 æˆ–ä»¥ä¸Šçš„åŸºç¡€åº“ä»¥ä½¿ç”¨äº‘èƒ½åŠ›')
    } else {
      wx.cloud.init({
        // env å‚æ•°è¯´æ˜ï¼š
        //   env å‚æ•°å†³å®šæ¥ä¸‹æ¥å°ç¨‹åºå‘èµ·çš„äº‘å¼€å‘è°ƒç”¨ï¼ˆwx.cloud.xxxï¼‰ä¼šé»˜è®¤è¯·æ±‚åˆ°å“ªä¸ªäº‘ç¯å¢ƒçš„èµ„æº
        //   æ­¤å¤„è¯·å¡«å…¥ç¯å¢ƒ ID, ç¯å¢ƒ ID å¯æ‰“å¼€äº‘æ§åˆ¶å°æŸ¥çœ‹
        //   å¦‚ä¸å¡«åˆ™ä½¿ç”¨é»˜è®¤ç¯å¢ƒï¼ˆç¬¬ä¸€ä¸ªåˆ›å»ºçš„ç¯å¢ƒï¼‰
        env: 'dev-r049g',
        traceUser: true,  //è®°å½•å°ç¨‹åºçš„è®¿é—®è€…
      })
    }

    this.globalData = {
      playingMusicId: -1
    }  
  },
  setPlayingMusicId(musicId){
    this.globalData.playingMusicId = musicId
  },
  getPlayingMusicId(){
    return this.globalData.playingMusicId
  }
})

```

é‚£ä¹ˆå¦‚ä½•åœ¨é¡µé¢ä¸­è·å–åˆ°app.jsçš„æ•°æ®å‘¢ï¼Ÿ

é€šè¿‡`getApp()`è·å–åˆ°ï¼š

![](https://pic3.zhimg.com/v2-f960a6739ee917def9070005a3225cfa_r.jpg)

åœ¨æ­Œæ›²åŠ è½½çš„æ—¶å€™å°†å½“å‰æ’­æ”¾æ­Œæ›²çš„idè®¾ç½®ä¸ºå…¨å±€çš„

![](https://pic3.zhimg.com/v2-df18c14bb8cde16802c8c1b4456443c2_r.jpg)

ç„¶ååœ¨æ­Œæ›²åˆ—è¡¨é¡µé¢æ¯æ¬¡æ˜¾ç¤ºçš„æ—¶å€™è·å–è¯¥å…¨å±€çš„idç„¶åä¿å­˜ä¸ºè‡ªå·±çš„playingIdï¼Œè¿™é‡Œç”¨åˆ°äº†[ç»„ä»¶æ‰€åœ¨é¡µé¢çš„ç”Ÿå‘½å‘¨æœŸ](https://developers.weixin.qq.com/miniprogram/dev/framework/custom-component/lifetimes.html)ã€‚

```js
// components/musiclist/cmp.js
const app = getApp()
...
  pageLifetimes:{
    show(){
      // console.log('æˆ‘å‡ºç°äº†' + app.getPlayingMusicId())
      this.setData({
        playingId: app.getPlayingMusicId()
      })
    }
  },
```

æå®šã€‚

**è¿˜æœ‰ä¸€ä¸ªè¦ä¼˜åŒ–çš„ç‚¹**ï¼Œå½“å¦‚ä¸‹å›¾æ‰€ç¤ºé€šè¿‡æ‰‹æœºå¾®ä¿¡è‡ªå¸¦çš„æ§åˆ¶æŒ‰é’®æš‚åœäº†æ­Œæ›²æ’­æ”¾ï¼Œä½†æ˜¯å°ç¨‹åºæ’­æ”¾é¡µé‡Œçš„æ’­æ”¾æŒ‰é’®æ²¡æœ‰è·Ÿç€æ”¹å˜ï¼Œå°é¢ä»åœ¨æ—‹è½¬ï¼ŒæŒ‡é’ˆä¹Ÿæ²¡æœ‰æŠ¬èµ·ã€‚è¿™äº›éƒ½æ˜¯ç”±`/miniprogram/pages/player/player.js `ä¸­çš„`isPlaying`æ¥å½±å“çš„ã€‚è¿™ä¸€ç‚¹éœ€è¦ä¼˜åŒ–ã€‚

<img src="https://pic1.zhimg.com/80/v2-5ac4aae674051ca3f47952f56e49a260_hd.png" style="width:300px" />

<img src="https://pic3.zhimg.com/80/v2-71123a7b248283f7c98fe5320e448a8b_hd.png" style="width:300px" />

è¿™ä¸ªå…¶å®å¾ˆç®€å•ï¼Œé€šè¿‡æ‰‹æœºå¾®ä¿¡è‡ªå¸¦çš„æ§åˆ¶æŒ‰é’®æš‚åœæˆ–æ’­æ”¾äº†æ­Œæ›²æ’­æ”¾ï¼Œä¹Ÿä¼šè§¦å‘backgroundAudioManager.onPauseå’ŒbackgroundAudioManager.onPlay



![](https://pic2.zhimg.com/v2-283c843098570a6502b90b6ba19faadd_r.jpg)



![](https://pic1.zhimg.com/v2-1ebdd55e42b96ce3fc835d269c5525fc_r.jpg)



![](https://pic2.zhimg.com/v2-60c401d61f2bbb872cb73319530d67a9_r.jpg)

è‡³æ­¤æå®šã€‚

**è¿˜æœ‰ä¸€ä¸ªè¦ä¼˜åŒ–çš„ç‚¹ã€‚**æ­Œæ›²åˆ—è¡¨é¡µç‚¹å‡»äº†æŸä¸€é¦–æ­Œæ›²ï¼Œè¿›å…¥åˆ°äº†æ’­æ”¾é¡µå¹¶å¼€å§‹æ’­æ”¾ï¼Œè¿”å›ï¼Œå›åˆ°æ­Œæ›²åˆ—è¡¨é¡µï¼Œå†æ¬¡ç‚¹å‡»è¯¥æ­Œæ›²çš„æ—¶å€™ï¼Œåˆé‡æ–°æ’­æ”¾äº†ï¼Œè¿™ä¸ªä¸å¥½ï¼Œè¦è®©ä»–æ¥ç€æ’­æ”¾è€Œéé‡å¤´æ’­æ”¾ã€‚

åœ¨æ’­æ”¾é¡µ`/miniprogram/pages/player/player.js `ä¸­æ·»åŠ ä¸€ä¸ªæ ‡å¿—ä½`isSame`ï¼Œè¡¨ç¤ºè¦æ’­æ”¾çš„æ˜¯å¦ä¸ºåŒä¸€é¦–æ­Œæ›²ã€‚

![](https://pic3.zhimg.com/v2-d57aeb2e681fc7c0e4b5dcc1db6406d2_r.jpg)

åœ¨æ¯æ¬¡è¦è½½å…¥æ­Œæ›²ä¿¡æ¯ä¹‹å‰ï¼Œå…ˆåˆ¤æ–­ç‚¹å‡»è¦æ’­çš„æ­Œæ›²å’Œæ—§çš„å½“å‰æ­Œæ›²æ˜¯ä¸æ˜¯åŒä¸€é¦–ï¼Œè¿›è€Œå˜åŒ–`isSame`çš„å€¼ã€‚æ¥ç€é€šè¿‡isSameçš„å€¼çŸ¥é“æ˜¯ä¸æ˜¯åŒä¸€é¦–æ­Œæ›²ï¼Œä¸æ˜¯çš„å°±åœæ­¢ä¸Šä¸€é¦–çš„æ’­æ”¾ï¼Œå¹¶ç»™`backgroundAudioManager`è¿›è¡Œä¸€äº›åˆ—æ–°å€¼çš„èµ‹å€¼ã€‚å¦åˆ™ä¸ç”¨ã€‚

![](https://pic4.zhimg.com/v2-62a3e8c6c42874e4d9a0145541a57703_r.jpg)



![](https://pic1.zhimg.com/v2-bb03d4b7d220387c3c1898b799fe53d0_r.jpg)

åˆ°è¿™ä¸€æ­¥ä¸ºæ­¢åŸºæœ¬è§£å†³äº†é‡æ–°ç‚¹å‡»æ­Œæ›²é‡æ–°æ’­æ”¾çš„é—®é¢˜ï¼Œä½†æ˜¯è¿˜æœ‰ä¸€ä¸ªbugï¼Œå°±æ˜¯è¿›åº¦æ¡çš„æ€»æ—¶é—´åˆå˜æˆäº†00ï¼š00ï¼Œè¿™ä¸€ç‚¹è¦è§£å†³ã€‚

![](https://pic2.zhimg.com/80/v2-40e1c883113d3385b0cda2dd0e996e54_hd.png)

æŠŠ`isSame`ä¼ è¿‡å»ç»™è¿›åº¦æ¡ç»„ä»¶ğŸ‘†ğŸ‘‡

```js
  properties: {
    isSame: Boolean
  },
  
    // ç»„ä»¶ç”Ÿå‘½å‘¨æœŸ
  lifetimes:{
    ready(){
      if(this.properties.isSame&&this.data.showTime.totalTime== '00:00'){
        this._setTime() //é‡æ–°å¤„ç†totalTime
      }
      this._getMovableDis()
      this._bindBGMEvent()
    }
  },
```

è‡³æ­¤æˆåŠŸè§£å†³bugã€‚

# æœ‰ä¸ªè¦å¾…ä¼˜åŒ–çš„ç‚¹ï¼Œå¦‚æœé¢‘ç¹æŒ‰ä¸‹ä¸€é¦–ä¼šå‡ºé—®é¢˜

## 5.ã€ä¹è¯„åŠ¨æ€ã€‘åŠŸèƒ½å®ç°



```
- è¯¥åŠŸèƒ½ç±»ä¼¼åšæ–‡å‘å¸ƒ
- å°ç¨‹åºç”¨æˆ·ä¿¡æ¯æˆæƒæµç¨‹
- å¤šæ–‡ä»¶ä¸Šä¼ äº‘å­˜å‚¨å¼‚æ­¥æ“ä½œ
- äº‘æ•°æ®åº“æ¨¡ç³ŠæŸ¥è¯¢ã€ç´¢å¼•æŸ¥è¯¢ã€æƒé™æŸ¥è¯¢
```

### å¤´éƒ¨

å…ˆé…ç½®ä¸€ä¸‹blog.jsoné‡Œé¢çš„` "navigationBarTitleText": "åŠ¨æ€"`ï¼Œè¿™æ ·ç‚¹å‡»åˆ°åŠ¨æ€é¡µæ—¶ä¸Šæ–¹å°±æ˜¾ç¤ºå¯¹åº”çš„åŠ¨æ€äºŒå­—ã€‚ç›¸åº”çš„å…¶ä»–ä¸¤ä¸ªtabbaré¡µé¢ä¹Ÿè¦æ”¹ä¸€ä¸‹ã€‚

è¿™é‡Œè¦åšçš„å¤´éƒ¨ç”¨åˆ°ä¸¤ä¸ªiconå›¾æ ‡ï¼Œæ‰€ä»¥æˆ‘æ‰¾äº†ä¸¤ä¸ªiconï¼Œæ›´æ–°äº†ä¸€ä¸‹æˆ‘çš„iconfonté¡¹ç›®ï¼Œå¹¶æŠŠæ–°ç”Ÿæˆçš„iconfont.cssæ›´æ–°åˆ°äº†å°ç¨‹åºé¡¹ç›®ä¸­ã€‚å…·ä½“æ“ä½œåœ¨éŸ³ä¹æ’­æ”¾å™¨æ§ä»¶é‚£é‡Œæœ‰è®²ã€‚

ä¹‹å‰åœ¨éŸ³ä¹æ’­æ”¾æ§ä»¶é‚£é‡Œä½¿ç”¨iconå›¾ç‰‡ä½¿ç”¨çš„æ—¶`text`æ ‡ç­¾ï¼Œè¿™é‡Œè¿˜å¯ä»¥ä½¿ç”¨`<i>`æ ‡ç­¾ğŸ‘‡

```html
<!--miniprogram/pages/blog/blog.wxml-->
<view class="container">
  <!-- å¤´éƒ¨ -->
  <view class="header">
    <view class="publish-container" bindtap="onPublish">
      <i class="iconfont icon-fabu"></i>
    </view>
    <view class="search-container"></view>
  </view>

</view>
```

### æœç´¢ç»„ä»¶

```html
<!--components/search/cmp.wxml-->
<view class="container">
  <input class="bar" placeholder="{{placeholder}}" placeholder-class="in-bar"></input>
  <button size="mini" class="search">æœç´¢</button>
</view>
```

è¿™é‡Œé‡åˆ°äº†ä¸€ä¸ªå°ç¨‹åºçš„å‘ã€‚å°ç¨‹åºä¸ŠæŒ‰é’®æ ·å¼button: not([size='mini'])é€ æˆæŒ‰é’®æ ·å¼é”™ä¹±ğŸ‘‡

![](https://pic4.zhimg.com/80/v2-b448a7717144dc56cf0e471e848588df_hd.jpg)

è¿™æ—¶å°ç¨‹åºæ–°ç‰ˆä¸­app.jsoné‡Œ"style": "v2"é€ æˆçš„ï¼Œæ‰€ä»¥è¦ä¹ˆæŠŠè¿™ä¸ª"style": "v2"åˆ å»ï¼Œè¦ä¹ˆå°±ä¹–ä¹–åœ¨buttonä¸ŠåŠ ä¸Š`size="mini"`ã€‚å°±å¯ä»¥æ­£å¸¸åœ°è®¾ç½®buttonçš„å®½åº¦ğŸ‘‡

![](https://pic3.zhimg.com/80/v2-38223bc0438105220403e73234aa088e_hd.jpg)

å¦å¤–è¿™é‡Œçš„placeholderæˆ‘æ²¡æœ‰å†™æ­»ï¼Œé€šè¿‡propertiesæ¥æ§åˆ¶ï¼Œå¤–ç•Œæœ‰ä¼ å€¼è¿‡æ¥å°±ç”¨ä¼ è¿‡æ¥çš„å€¼ï¼Œæ²¡æœ‰çš„è¯å°±ç”¨é»˜è®¤å€¼â€œè¯·è¾“å…¥å…³é”®å­—â€ğŸ‘‡

```js
// miniprogram/components/search/cmp.js   
properties: {
    placeholder: {
      type:String,
      value: "è¯·è¾“å…¥å…³é”®å­—"
    }
  },
```

#### ç»„ä»¶å†…å¼•å…¥iconfont

ä¸Šé¢çš„æœç´¢æ¡†æˆ‘è¦åœ¨é‡Œé¢åŠ ä¸€ä¸ªæ”¾å¤§é•œçš„iconï¼Œæˆ‘å°è¯•ç›´æ¥åƒä¹‹å‰é‚£æ ·å­æ“ä½œï¼Œç›´æ¥ç”¨ä¸€ä¸ª`i`æ ‡ç­¾å¼•å…¥ğŸ‘‡

```html
<!--components/search/cmp.wxml-->
<view class="container">
  <i class="iconfont icon-sousuo"></i>
  <input class="bar" placeholder="{{placeholder}}" placeholder-class="in-bar"></input>
  <button size="mini" class="search">æœç´¢</button>
</view>
```

ä½†æ˜¯è¿™æ˜¯æ— æ•ˆçš„ï¼Œå› ä¸ºç»„ä»¶ä¼šå±è”½å¤–ç•Œçš„cssæ ·å¼ï¼Œè¿™å°±æ˜¯[ç»„ä»¶æ ·å¼éš”ç¦»](https://developers.weixin.qq.com/miniprogram/dev/framework/custom-component/wxml-wxss.html#%E7%BB%84%E4%BB%B6%E6%A0%B7%E5%BC%8F%E9%9A%94%E7%A6%BB) ã€‚æ‰€ä»¥è¯´å…¨å±€ä½œç”¨ä¸‹çš„iconfont.wxssæ˜¯ä½œç”¨ä¸åˆ°è¯¥ç»„ä»¶çš„ã€‚é‚£ä¹ˆæˆ‘å¯ä»¥å¤åˆ¶ä¸€ä¸ªä¸€æ¨¡ä¸€æ ·çš„iconfont.wxssåˆ°ç»„ä»¶æ–‡ä»¶å¤¹ä¸­ï¼Œç„¶ååœ¨ç»„ä»¶çš„cmp.wxssä¸­é€šè¿‡@import 'iconfont.wxss'å¼•å…¥æ–°çš„iconfont.wxssè¿™æ ·å°±è¡Œäº†ã€‚

è¿˜æœ‰å¦ä¸€ç§æ–¹æ³•ğŸ‘‡

#### å¤–éƒ¨æ ·å¼ç±»

ä¸Šé¢çš„æ–¹æ³•ç®€å•ç²—æš´ï¼Œä½†æ˜¯è¦å¤šå»ºä¸€ä¸ªç›¸åŒçš„wxssæ–‡ä»¶ã€‚

å°ç¨‹åºä¸­æœ‰ä¸ªã€[å¤–éƒ¨æ ·å¼ç±»](https://developers.weixin.qq.com/miniprogram/dev/framework/custom-component/wxml-wxss.html#%E5%A4%96%E9%83%A8%E6%A0%B7%E5%BC%8F%E7%B1%BB)ã€‘çš„åŠŸèƒ½ã€‚

```html
<!--miniprogram/pages/blog/blog.wxml-->
<view class="container">
  <!-- å¤´éƒ¨ -->
  <view class="header">
    <view class="publish-container" bindtap="onPublish">
      <i class="iconfont icon-fabu"></i>
    </view>
    <view class="search-container">
      <!-- ä½¿ç”¨å¤–éƒ¨æ ·å¼ç±»çš„æ–¹å¼ä¼ ç»™ç»„ä»¶å¤–éƒ¨çš„æ ·å¼ç±»   ç­‰å·å·¦è¾¹éšä¾¿å‘½åï¼Œå³è¾¹å¿…é¡»æ˜¯ç›®æ ‡ç±»å -->
      <search-cmp iconfont="iconfont" icon-sousuo="icon-sousuo"/>
    </view>
  </view>

</view>
```

```js
// miniprogram/components/search/cmp.js   
// è®°å½•å¤–éƒ¨ä¼ å…¥çš„å¤–éƒ¨æ ·å¼ç±»
  externalClasses:[
    "iconfont",
    "icon-sousuo"
  ],
```

ç„¶åwxmlä¸­è¿™æ ·å†™å°±å¥æ•ˆäº†ğŸ‘‡

```html
  <i class="iconfont icon-sousuo"></i>
```

ã€æ³¨æ„ã€‘ä¼ è¿›æ¥çš„å¤–éƒ¨æ ·å¼ç±»æ˜¯ä¸å¯ä»¥ä¿®æ”¹çš„ã€‚æ‰€ä»¥å¦‚æœæƒ³è¦åœ¨æ­¤åŸºç¡€ä¸Šæ·»åŠ æ–°çš„æ ·å¼ï¼Œå»ºè®®å¦å¤–å†™ä¸€ä¸ªæ ·å¼ç±»ã€‚

### åº•éƒ¨å¼¹å‡ºå±‚

åŠŸèƒ½ï¼šå½“ç”¨æˆ·ç‚¹å‡»å‘å¸ƒæŒ‰é’®è¦å‘å¸ƒåŠ¨æ€çš„æ—¶å€™ï¼Œæˆ–åœ¨å‘å¸ƒè¯„è®ºçš„æ—¶å€™ï¼Œéƒ½ä¼šå¼¹å‡ºä¸€ä¸ªåº•éƒ¨å¼¹å‡ºå±‚ï¼Œè¦æ±‚è·å–ç”¨æˆ·çš„å¾®ä¿¡ä¿¡æ¯ã€‚

å¤„äºå¤ç”¨æ€§è€ƒè™‘ï¼Œå°†åº•éƒ¨å¼¹å‡ºå±‚å°è£…æˆä¸€ä¸ªç»„ä»¶ã€‚

/miniprogram/components/bottom-layer/cmp.wxml ğŸ‘‡

```html
<view class="layer" hidden="{{!layerShow}}">
  <view class="panel">
    <i class="iconfont icon-shanchu" bindtap="onClose"></i>
    <!-- slotæ’æ§½  å…·åæ’æ§½ -->
    <slot name="layer-content"></slot>
  </view>
</view>
```

è¿™é‡Œåˆè¦ç”¨åˆ°å¤–éƒ¨çš„æ ·å¼ç±»äº†ï¼Œè¿™æ¬¡æ˜¯icon-shanchuã€‚

è¿™æ¬¡ç”¨ä¸ªæ–°çš„è§£å†³æ–¹å¼ğŸ‘‡

#### styleIsolationå¤„ç†ç»„ä»¶æ ·å¼éš”ç¦»

å‰é¢è®²äº†é»˜è®¤æƒ…å†µä¸‹ï¼Œè‡ªå®šä¹‰ç»„ä»¶çš„æ ·å¼åªå—åˆ°è‡ªå®šä¹‰ç»„ä»¶ wxss çš„å½±å“ã€‚è¿™é‡Œä»‹ç»ä¸€ä¸ªæ–°çš„è§£å†³æ–¹æ³•â€”â€”æŒ‡å®šç‰¹æ®Šçš„æ ·å¼éš”ç¦»é€‰é¡¹ `styleIsolation` ã€‚

```js
// miniprogram/components/bottom-layer/cmp.js  
options:{
    styleIsolation: 'apply-shared'
  },
```

`apply-shared` è¡¨ç¤ºé¡µé¢ wxss æ ·å¼å°†å½±å“åˆ°è‡ªå®šä¹‰ç»„ä»¶ï¼Œä½†è‡ªå®šä¹‰ç»„ä»¶ wxss ä¸­æŒ‡å®šçš„æ ·å¼ä¸ä¼šå½±å“é¡µé¢ã€‚

è¿™ä¸ªæ¯”ä¹‹å‰ä¸¤ç§æ–¹æ³•éƒ½ç®€ä¾¿ï¼Œä½†æ˜¯è¯·åŠ¡å¿…æ³¨æ„ç»„ä»¶é—´æ ·å¼çš„ç›¸äº’å½±å“ã€‚

**è‡³æ­¤å·²ç»ä»‹ç»äº†ä¸‰ç§å¤„ç†ç»„ä»¶æ ·å¼éš”ç¦»çš„æ–¹æ³•ï¼š**

1. ç»„ä»¶å†…æ–°å»ºå’Œå¤–éƒ¨æ ·å¼ä¸€æ ·çš„æ ·å¼ä»£ç 
2. ä½¿ç”¨å¤–éƒ¨æ ·å¼ç±»externalClassesï¼Œç»„ä»¶å†…ä¸èƒ½ä¿®æ”¹å¤–éƒ¨å¼•å…¥çš„æ ·å¼ç±»
3. ä½¿ç”¨styleIsolationï¼Œè®¾ç½®ä¸º`apply-shared`çš„æ—¶å€™ ç»„ä»¶å†…å¯ä»¥ä¿®æ”¹å¤–éƒ¨å¼•å…¥çš„æ ·å¼ç±»ã€‚



#### ä½¿ç”¨å›ºå®šå®šä½å……æ»¡å±å¹•

```html
<view class="layer">
  <view class="panel">
    <i class="iconfont icon-shanchu"></i>
  </view>
</view>
//miniprogram/components/bottom-layer/cmp.wxml 
```

é€šè¿‡styleIsolationè®¾ç½®çš„å¤–éƒ¨æ ·å¼ç±»å¯ä»¥åœ¨ç»„ä»¶å†…è¿›è¡Œä¿®æ”¹ğŸ‘‡

```css
.layer{
  position: fixed;
  top: 0;
  right: 0;
  bottom: 0;
  left: 0;
  /* è¿™ä¸Šé¢äº”è¡Œä»£ç æ˜¯ä¸ºäº†è®©layerå±‚é“ºæ»¡æ•´ä¸ªå±å¹•ï¼Œå†™å¼¹çª—æ•ˆæœæ—¶ç»å¸¸ä¼šè¿™æ ·ç”¨ */

  z-index: 99;
  text-align: center;
  background: rgba(0, 0, 0, .6);
}
.panel{
  position: absolute;
  bottom: 0rpx;
  left: 0;
  height: 300rpx;
  width: 100%;
  background-color: #f8f8f8f8;
}

/* é€šè¿‡styleIsolationè®¾ç½®çš„å¤–éƒ¨æ ·å¼ç±»å¯ä»¥åœ¨ç»„ä»¶å†…è¿›è¡Œä¿®æ”¹ */
.layer .icon-shanchu{
  position: absolute;
  right: 0;
  top: 10rpx;
  padding: 20rpx;/*ä¸ºäº†å¢åŠ å¯ç‚¹å‡»åŒºåŸŸå¤§å°*/
}
//miniprogram/components/bottom-layer/cmp.wxss 
```

![](https://pic2.zhimg.com/80/v2-9dfaba851e00b7100a4074b28762070f_hd.png)



	#### ä½¿ç”¨slotæ’æ§½

slotæ’æ§½ğŸ‘‰[ç‚¹å‡»](https://developers.weixin.qq.com/miniprogram/dev/framework/custom-component/wxml-wxss.html#%E7%BB%84%E4%BB%B6wxml%E7%9A%84slot)

å…³äºæ•´ä¸ªåº•éƒ¨å¼¹å‡ºå±‚ï¼Œæˆ‘ä»¬ä¸æƒ³ç›´æ¥å†™æ­»äº†é‡Œé¢çš„å†…å®¹ï¼Œå¸Œæœ›æŠŠå¼¹å‡ºå±‚çš„å†…å®¹é€šè¿‡ç»„ä»¶ä½¿ç”¨è€…æ¥ä¼ å…¥ï¼Œæ‰€ä»¥è¿™é‡Œè¦ ä½¿ç”¨`slot` èŠ‚ç‚¹ï¼Œç”¨äºæ‰¿è½½ç»„ä»¶ä½¿ç”¨è€…æä¾›çš„wxmlç»“æ„ã€‚

è¿™é‡Œæˆ‘ä½¿ç”¨äº†å¤šä¸ªæ’æ§½ï¼Œæ‰€ä»¥è¦ä½¿ç”¨**å…·åæ’æ§½**ã€‚



#### æˆæƒç»„ä»¶login 	

æˆ‘æƒ³è¦åœ¨è¿™ä¸ªåº•éƒ¨å¼¹å‡ºå±‚è¿›è¡Œå¾®ä¿¡æˆæƒç¡®è®¤ï¼Œè¿™é‡Œå°è£…ä¸€ä¸ªæˆæƒç»„ä»¶ã€‚åªæœ‰åœ¨è·å–åˆ°å¾®ä¿¡æˆæƒçš„æƒ…å†µä¸‹æ‰èƒ½è¿›è¡ŒåŠ¨æ€å‘å¸ƒå’Œè¯„è®ºã€‚

ğŸ‘‰å…³äº[å¾®ä¿¡å°ç¨‹åºæˆæƒ](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/authorize.html)

è¿™é‡Œçš„æˆæƒç»„ä»¶å†…éƒ¨ä¼šè°ƒç”¨ä¸Šé¢å†™å¥½çš„åº•éƒ¨å¼¹å‡ºå±‚ç»„ä»¶ï¼Œæ‰€ä»¥ä¹‹å‰æˆ‘ä»¬åœ¨blogé¡µé¢è°ƒç”¨åº•éƒ¨å¼¹å‡ºå±‚ç»„ä»¶çš„åšæ³•å°±ä¸è¦äº†ï¼Œæ”¹æˆåœ¨blogé¡µé¢è°ƒç”¨loginæˆæƒç»„ä»¶ï¼Œè€Œè¿™ä¸ªloginæˆæƒç»„ä»¶å†…éƒ¨è°ƒç”¨åº•éƒ¨å¼¹å‡ºå±‚ç»„ä»¶ã€‚

**è¿™é‡Œçœ‹ä¸€ä¸‹blogã€loginå’Œbottom-layerè¿™ä¸‰éƒ¨åˆ†çš„ä»£ç ï¼Œæ¶‰åŠåˆ°æ’æ§½çš„ä½¿ç”¨å’Œç»„ä»¶é—´ä¼ å€¼ï¼Œæ¯”è¾ƒæ‚å°±ä¸å±•å¼€åšç¬”è®°ã€‚**

æ•ˆæœå¦‚ä¸‹ğŸ‘‡

![](https://pic2.zhimg.com/80/v2-f2285b46130dd8fe8083bf3d60b05eb5_hd.png)

æ¥ä¸‹æ¥è¦å®ç°ç‚¹å‡»â€œè·å–å¾®ä¿¡æˆæƒä¿¡æ¯â€è°ƒç”¨å¾®ä¿¡å°ç¨‹åºæˆæƒapiå®ç°æˆæƒçš„åŠŸèƒ½ã€‚

```html
<!--components/login/cmp.wxml-->
<bottom-layer layerShow="{{show}}">
  <view slot="layer-content">
    <button class="login" 
            open-type="getUserInfo"
            >è·å–å¾®ä¿¡æˆæƒä¿¡æ¯</button>
  </view>
</bottom-layer>
```

è¿™é‡Œçš„buttonå†™ä¸Šäº†`open-type`å±æ€§ï¼Œå…¶å€¼ä¸º`getUserInfo`ï¼Œè¿™æ ·ç‚¹å‡»è¯¥æŒ‰é’®çš„æ—¶å€™å°±ä¼šå¼¹å‡ºå°ç¨‹åºç´¢å–ç”¨æˆ·æˆæƒçš„å¼¹çª—ğŸ‘‡

![](https://pic4.zhimg.com/80/v2-9e88fc5514cf543d09f5f99afe0f9619_hd.png)

ç”¨æˆ·ç‚¹å‡»å…è®¸æŒ‰é’®ä¹‹åå°ç¨‹åºä¼šè·å–åˆ°äº†å¾®ä¿¡æˆæƒã€‚æˆ‘ä»¬å†ç»™buttonåŠ å¤šä¸€ä¸ªäº‹ä»¶`bindgetuserinfo`ğŸ‘‡

![](https://pic4.zhimg.com/80/v2-5bd38d61d9b3fa84955cc47270e61b07_hd.png)

åœ¨å…¶å¯¹åº”çš„cmp.jsä¸­å®ç°è¿™ä¸ª`onGotUserInfo`ğŸ‘‡

```js
  methods: {
    onGotUserInfo(event){
      console.log(event)
    }
  }
```

çœ‹çœ‹è¿™ä¸ªeventé‡Œéƒ½æœ‰å•¥ä¿¡æ¯ğŸ‘‡

![](https://pic2.zhimg.com/v2-7226e1dd8884b23580b74f98968d5e45_r.jpg)

å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬å¯ä»¥è·å–åˆ°ç”¨æˆ·çš„å¾®ä¿¡ä¿¡æ¯ã€‚

è¿›ä¸€æ­¥å®Œå–„ğŸ‘‡

è·å¾—æˆæƒåå…³é—­å¼¹å‡ºå±‚ã€ä¼ é€’ç”¨æˆ·ä¿¡æ¯ç»™çˆ¶çº§çš„blogï¼š

![](https://pic4.zhimg.com/80/v2-a5466b21cf9251e35d2e460d25de066d_hd.png)

å¯¹åº”çš„çˆ¶çº§blogğŸ‘‡

```html
  <!-- æˆæƒç»„ä»¶åº•éƒ¨å¼¹å‡ºå±‚ -->
<login-cmp show="{{show}}"
           bind:loginsuccess="onLoginSuccess"
           bind:loginfail="onLoginFail">
           
 // miniprogram/pages/blog/blog.wxml 
```

![](https://pic3.zhimg.com/80/v2-420af70cb910b0ac85ca1980abe94d1c_hd.png)

![](https://pic3.zhimg.com/80/v2-3586021a9e24b96dee6d5718fc78151e_hd.png)

åœ¨ç¼–è¾‘é¡µé¢çš„blog-edit/cmp.jsä¸­å°±å¯ä»¥å¾—åˆ°ä¼ è¿‡æ¥çš„ ä¿¡æ¯ğŸ‘‡

```js
  /**
   * ç”Ÿå‘½å‘¨æœŸå‡½æ•°--ç›‘å¬é¡µé¢åŠ è½½
   */
  onLoad: function (options) {
    console.log(options)
  },
```

æ§åˆ¶å°æ‰“å°è¾“å‡ºä¼ è¿‡æ¥çš„ç”¨æˆ·æ˜µç§°å’Œå¤´åƒã€‚



### åšæ–‡ç¼–è¾‘å’Œå‘å¸ƒé¡µé¢

ç¼–è¾‘éƒ¨åˆ†ç”¨äº†åŸç”Ÿç»„ä»¶`textarea`è¿™ä¸ªåŸç”Ÿç»„ä»¶ã€‚

```html
<!--pages/blog-edit/blog-edit.wxml-->
<view class="container">
  <textarea class="content" 
            placeholder="åˆ†äº«ä½ çš„ä¹è¯„å­~"
            bindinput="onInput"
            maxlength="140"
            auto-focus></textarea>

  <view class="image-list">
    <!-- æ˜¾ç¤ºå›¾ç‰‡ -->

    <!-- é€‰æ‹©å›¾ç‰‡ -->
    <view class="image-wrap selectphoto">
      <i class="iconfont icon-add-fill"></i>
    </view>
  </view>
</view>

<view class="footer">
  <text class="words-num">{{wordsNum}}</text>
  <button size="mini" class="send-btn">å‘å¸ƒ</button>
</view>
```

textareaä½œä¸ºåŸç”Ÿç»„ä»¶ä¸å…è®¸ä½¿ç”¨`bindï¼šxxx`çš„æ ¼å¼ï¼Œæ™ºèƒ½ä½¿ç”¨`bindxxx`çš„æ ¼å¼ï¼Œå…³äºåŸç”Ÿç»„ä»¶è¿˜æœ‰å…¶ä»–é™åˆ¶ï¼Œè§ä¸‹æ–‡ã€‚

![](https://pic2.zhimg.com/80/v2-e52b97255945ec186770da8790245415_hd.png)

![](https://pic4.zhimg.com/80/v2-70d22b11f7dfc15f2d7b453322379c15_hd.png)





#### åŸç”Ÿç»„ä»¶çš„é™åˆ¶

å…³äºåŸç”Ÿç»„ä»¶ğŸ‘‰[ç‚¹å‡»](https://developers.weixin.qq.com/miniprogram/dev/component/native-component.html)

è¦ç‰¹åˆ«æ³¨æ„ã€‚



#### èšç„¦é”®ç›˜å¼¹å‡ºæ—¶footerä¸Šç§»ï¼Œå¤±å»ç„¦ç‚¹æ—¶æ¢å¤

è¿™ä¸ªfooteræ˜¯æœ‰å®æ—¶æ˜¾ç¤ºè¾“å…¥çš„å­—æ•°çš„ï¼Œtextareaèšç„¦**ï¼ˆbindfocusï¼‰**é”®ç›˜å¼¹å‡ºçš„æ—¶å€™æˆ‘å¸Œæœ›footerä¸Šç§»åˆ°é”®ç›˜ä¸Šå¤´ï¼Œå¤±å»ç„¦ç‚¹**ï¼ˆbindblurï¼‰**çš„æ—¶å€™æ¢å¤åŸæ¥ä½ç½®ã€‚

auto-focus è‡ªåŠ¨èšç„¦ã€‚

```html
  <textarea class="content" 
            placeholder="åˆ†äº«ä½ çš„ä¹è¯„å­~"
            bindinput="onInput"
            bindfocus="onFocus"
            bindblur="onBlur"
            maxlength="140"
            auto-focus
            ></textarea>
```

èšç„¦çš„æ—¶å€™è·å–é”®ç›˜å ç”¨çš„é«˜åº¦ï¼Œå°†è¿™ä¸ªé«˜åº¦å€¼èµ‹ç»™footerçš„bottomå€¼ï¼Œè¿™æ ·å°±å¯ä»¥ä½¿å¾—footerè¢«å¼¹èµ·ã€‚

```html
<view class="footer" style="bottom:{{footerBottom}}px">
  <!-- å†…è”æ ·å¼çš„bottomï¼Œé…åˆèšç„¦ä¸Šç§»çš„åŠ¨ä½œï¼›  æ³¨æ„pxä¸è¦æ¼äº† -->
  <text class="words-num">{{wordsNum}}</text>
  <button size="mini" class="send-btn">å‘å¸ƒ</button>
</view>
```

```js
  onFocus(event){
    console.log(event)
    this.setData({
      footerBottom: event.detail.height //è¿™ä¸ªé«˜åº¦å°±æ˜¯é”®ç›˜å ç”¨çš„é«˜åº¦
    })
   }, 

  onBlur(){
    this.setData({
      footerBottom: 0
    })
  },
```

<img src="https://pic4.zhimg.com/80/v2-932d43b4b9be838fa521f6ba7c487dc0_hd.png" style="width:300px" />



### é€‰æ‹©å›¾ç‰‡ä¸šåŠ¡

ç‚¹å‡»â•é€‰æ‹©ä¸Šä¼ çš„å›¾ç‰‡

è¿™é‡Œè¦ç”¨åˆ°ä¸€ä¸ªapi--ã€‹[wx.chooseImage](https://developers.weixin.qq.com/miniprogram/dev/api/media/image/wx.chooseImage.html)

```html
// miniprogram/pages/blog-edit/blog-edit.wxml 
<view class="image-list">
    <!-- æ˜¾ç¤ºå›¾ç‰‡ -->
    <block wx:for="{{images}}" wx:key="*this">
      <view class="image-wrap">
        <image class="image" src="{{item}}" mode="aspectFill"></image>
        <i class="iconfont icon-shanchu" bindtap="onDelImage" data-index="{{index}}"></i>
      </view>
    </block>
    <!-- é€‰æ‹©å›¾ç‰‡ -->
    <view class="image-wrap selectphoto" 
          bindtap="onChooseImage"
          hidden="{{!selectPhoto}}">
      <i class="iconfont icon-add-fill"></i>
    </view>
  </view>
```

è¿™é‡Œä½¿ç”¨äº†flexå¸ƒå±€ï¼Œè‡ªåŠ¨æ¢è¡Œ`flex-wrap: wrap`ï¼Œæ¯è¡Œæ˜¾ç¤ºä¸‰ä¸ªã€‚

![](https://pic4.zhimg.com/80/v2-8c58f12ccee753241a36151705cccb9f_hd.png)



åœ¨ä½¿ç”¨wx.chooseImageçš„æ—¶å€™ï¼Œä¼šç»™æ¯å¼ å›¾ç‰‡ç”Ÿæˆä¸€ä¸ª**ä¸´æ—¶è·¯å¾„**ç”¨ä»¥å”¯ä¸€æ ‡è¯†å¯¹åº”çš„å›¾ç‰‡ï¼Œå³ä¸‹å›¾ä¸­çš„`res.tempFilePaths`ã€‚

![](https://pic1.zhimg.com/v2-c5afd560c89a83ddb62b311965dc9d8c_r.jpg)

æœ€å¤šåªèƒ½ä¼ 9å¼ ï¼Œé€‰æ‹©è¶…è¿‡9å¼ çš„åªå–å‰9å¼ ï¼Œå¹¶ä¸”éšè—æ·»åŠ æŒ‰é’®ï¼Œç‚¹å‡»âŒå¯ä»¥åˆ é™¤ï¼Œä¸€æ—¦åˆ é™¤å¿…å®šæ¢å¤æ·»åŠ æŒ‰é’®ã€‚

#### å›¾ç‰‡é¢„è§ˆåŠŸèƒ½

è¿™å°±è¦ç”¨åˆ°æ–°çš„apiğŸ‘‰ **[wx.previewImage](https://developers.weixin.qq.com/miniprogram/dev/api/media/image/wx.previewImage.html)**

ç»™å›¾ç‰‡ç»‘å®šä¸€ä¸ªç‚¹å‡»äº‹ä»¶ï¼Œè§¦å‘onPreivewImageå‡½æ•°ğŸ‘‡

```html
<image class="image" src="{{item}}" 
               mode="aspectFill" 
               data-imgsrc="{{item}}"
               bindtap="onPreivewImage"></image>
```

```js
  // å›¾ç‰‡é¢„è§ˆåŠŸèƒ½
  onPreivewImage(event){
    wx.previewImage({
      urls: this.data.images,
      current: event.target.dataset.imgsrc,
    })
  },
```







### å‘å¸ƒåŠŸèƒ½â€”â€”å¤šæ–‡ä»¶ä¸Šä¼ äº‘å­˜å‚¨

ç»™å‘å¸ƒæŒ‰é’®ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼Œå°†æ•°æ®ä¸Šä¼ åˆ°äº‘æ•°æ®åº“ä¸­ï¼Œå®ç°æ•°æ®çš„æŒä¹…åŒ–ã€‚è¿™ä¸ªäº‘æ•°æ®åº“æ˜¯ä¸€ä¸ªéå…³ç³»å‹çš„æ•°æ®åº“ï¼Œç”¨jsonæ ¼å¼å­˜å‚¨æ•°æ®ã€‚

å¯¹äºæˆ‘ä»¬è¿™ä¸ªå‘å¸ƒåŠŸèƒ½ï¼Œæ•°æ®åŒ…æ‹¬æ–‡å­—å†…å®¹å’Œå›¾ç‰‡ï¼Œå…¶ä¸­å›¾ç‰‡è¢«å­˜åœ¨äº‘å­˜å‚¨ä¸­ï¼Œå¾®ä¿¡å°ç¨‹åºäº‘å¼€å‘æŠ€æœ¯**äº‘å­˜å‚¨**ä¸­æä¾›äº†è®¸å¤šapiä¾›å¼€å‘è€…ä½¿ç”¨ï¼ŒåŒ…æ‹¬ä¸Šä¼ æ–‡ä»¶ã€ä¸‹è½½æ–‡ä»¶ã€åˆ é™¤æ–‡ä»¶ã€è·å–æ–‡ä»¶é“¾æ¥ç­‰ã€‚

ä¸Šä¼ æ–‡ä»¶åˆ°äº‘å­˜å‚¨åï¼Œä¼šè·å¾—ä¸€ä¸ªäº‘æ–‡ä»¶ID`fileID`ï¼Œä½œä¸ºæ–‡ä»¶çš„å”¯ä¸€æ ‡è¯†ã€‚å½“æˆ‘ä»¬è¦ä½¿ç”¨äº‘å­˜å‚¨ä¸­çš„æŸä¸ªæ•°æ®çš„æ—¶å€™ï¼Œå°±å¯ä»¥é€šè¿‡`fileID`è·å–åˆ°ï¼Œè€Œè¿™ä¸ª`fileID`åˆ™è¢«æˆ‘ä»¬å­˜å‚¨åœ¨**äº‘æ•°æ®åº“**ä¸­ã€‚

**ä¹‹åå¯ä»¥å°†`fileID`çš„å€¼èµ‹ç»™`image`æ ‡ç­¾çš„srcå€¼ï¼Œå°±èƒ½æ˜¾ç¤ºå›¾ç‰‡äº†ï¼Œä½†æ˜¯ç›´æ¥åœ¨æµè§ˆå™¨ä¸­è®¿é—®æ—¶è®¿é—®ä¸åˆ°çš„ï¼Œå¾ˆç¥å¥‡ï¼Œæˆ‘åé¢å†™ä¹è¯„éƒ¨åˆ†çš„æ—¶å€™æ‰å‘ç°çš„ã€‚**

æˆ‘ä»¬è¿˜éœ€è¦çŸ¥é“æ¯æ¡åŠ¨æ€æ˜¯å“ªä¸ªç”¨æˆ·å‘å¸ƒçš„ï¼Œæ‰€ä»¥äº‘æ•°æ®åº“ä¸­è¿˜è¦å­˜å‚¨æ ‡è¯†ç”¨æˆ·çš„`openid`ï¼ˆ**æ³¨æ„ï¼šopenidä¼šè‡ªåŠ¨ç”Ÿæˆæ‰€ä»¥ä¸ç”¨æ‰‹åŠ¨å­˜å…¥ï¼‰**ã€ç”¨æˆ·æ˜µç§°ã€ç”¨æˆ·å¤´åƒã€å‘å¸ƒæ—¶é—´

æ‰€ä»¥å…³ç³»æ˜¯è¿™æ ·å­çš„ğŸ‘‡:

å…ˆå°†å›¾ç‰‡ä¸Šä¼ åˆ°äº‘å­˜å‚¨å¾—åˆ°`fileID`ï¼Œç„¶åå°†`fileID`å’Œå…¶ä»–æ•°æ®ä¸€èµ·å­˜å…¥äº‘æ•°æ®åº“

![](https://pic2.zhimg.com/80/v2-9f148ecb76cc86a457f37c73b0fd4d7e_hd.png)



#### ä¸Šä¼ å›¾ç‰‡è‡³äº‘å­˜å‚¨

ç”¨åˆ°çš„apiğŸ‘‰ [wx.cloud.uploadFile](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/reference-sdk-api/storage/uploadFile/client.uploadFile.html)

wx.cloud.uploadFileæ¯æ¬¡åªèƒ½ä¸Šä¼ ä¸€å¼ ï¼Œæ‰€ä»¥éœ€è¦å¾ªç¯éå†å›¾ç‰‡åˆ—è¡¨ï¼Œæ¯æ¬¡å¾ªç¯éƒ½ä¸Šä¼ ä¸€å¼ ã€‚

æˆ‘ä»¬ç°åœ¨äº‘å­˜å‚¨ä¸­æ–°å»ºä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œæˆ‘å‘½åä¸ºblogï¼Œè¿™äº›å›¾ç‰‡æˆ‘éƒ½æ‰“ç®—å­˜åœ¨è¿™ä¸ªblogä¸­ã€‚

- éœ€è¦ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼å¾—åˆ°æ¯å¼ å›¾ç‰‡çš„åç¼€å
- cloudPathå¿…é¡»åšåˆ°å”¯ä¸€åŒ–ï¼Œé¿å…é‡åå¯¼è‡´çš„èµ„æºè¦†ç›–

```js
  // å‘å¸ƒåŠŸèƒ½
  send(){
    // æ•°æ® â€”â€”> äº‘æ•°æ®åº“
    for(let i = 0; i<this.data.images.length; i++){
      let item = this.data.images[i]
      // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æˆªå–åˆ°æ¯å¼ å›¾ç‰‡çš„åç¼€å
      let suffix = /\.\w+$/.exec(item)[0]
      
      wx.cloud.uploadFile({
        cloudPath: 'blog/' + Date.now() + '-' + Math.random() * 1000000 + suffix, //äº‘å­˜å‚¨è·¯å¾„ï¼Œå¿…é¡»å…ˆå­˜åœ¨ï¼Œè¿™é‡Œåšäº†å”¯ä¸€åŒ–ï¼Œé¿å…é‡åå¯¼è‡´çš„èµ„æºè¦†ç›–
        filePath: item,  // filePathè¡¨ç¤ºä¸Šä¼ æ–‡ä»¶èµ„æºçš„è·¯å¾„
        success: (res)=>{
          console.log(res)  // è¿”å›çš„resä¸­æœ‰fileID
        },
        fail: (err)=>{  
          console.log(err)
        }
      })
    }
  },
```

å›¾ç‰‡å‘å¸ƒåæˆ‘ä»¬å¯ä»¥åœ¨äº‘å­˜å‚¨ä¸­çœ‹åˆ°ğŸ‘‡

![](https://pic1.zhimg.com/v2-91afe198cbd27fc461b79a038f3daf0c_r.jpg)

å¯ä»¥çœ‹åˆ°æ¯å¼ å›¾ç‰‡éƒ½æˆåŠŸå­˜å…¥äº†äº‘å­˜å‚¨ä¸­ï¼Œå¹¶ç”Ÿæˆäº†`flieID`ã€‚æˆ‘ä»¬å³é”®è¿˜å¯ä»¥æŸ¥çœ‹è¯¦æƒ…ï¼Œé‡Œé¢æœ‰æ¯å¼ å›¾ç‰‡çš„æ°¸ä¹…é“¾æ¥ï¼ˆä¸‹è½½åœ°å€ï¼‰ã€ç”Ÿæˆæ—¶é—´ç­‰ç­‰ä¿¡æ¯ã€‚



#### æ•°æ®æ’å…¥äº‘æ•°æ®åº“

ä¸Šæ–‡æˆ‘ä»¬æˆåŠŸå°†å›¾ç‰‡å­˜å…¥äº‘å­˜å‚¨ä¸­ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯ä¸€ä¸ªå¼‚æ­¥çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬éœ€è¦åœ¨æ‰€æœ‰å›¾ç‰‡éƒ½å­˜å…¥äº‘å­˜å‚¨ä¸­ä¹‹åæ‰å°†æ‰€æœ‰çš„`fileID`ä»¥åŠå…¶ä»–æ•°æ®æ’å…¥äº‘æ•°æ®åº“ä¸­ã€‚è¿™é‡Œå°±è¦ç”¨åˆ°**promise.all**

```js
  // miniprogram/pages/blog-edit/blog-edit.js 

  // å‘å¸ƒåŠŸèƒ½
  // å›¾ç‰‡æ•°æ® â€”â€”> äº‘å­˜å‚¨   fileID â€”â€”>äº‘æ•°æ®åº“
  send(){

    if(content.trim()===''){
      wx.showModal({
        title: 'è¯·å†™ç‚¹ä»€ä¹ˆå§~',
        content: '',
      })
      return 
    }
    //ğŸ‘†æ–‡æœ¬ä¸ºç©ºä¸å…è®¸ï¼Œæ–‡æœ¬ä¸ä¸ºç©ºæ‰æ‰§è¡Œä¸‹é¢çš„ç¨‹åºğŸ‘‡

    wx.showLoading({
      title: 'å‘å¸ƒä¸­',
    })

    let promiseArr = []  //ç”¨äºå­˜å‚¨æ¯ä¸ªPromiseå¯¹è±¡
    let fileIds = []  // ç”¨äºå­˜å‚¨fileID
    for(let i = 0; i<this.data.images.length; i++){
      let p = new Promise((resolve, reject)=>{  //å°†æ¯æ¬¡çš„ä¸Šä¼ æ“ä½œéƒ½å°è£…æˆpromise
        let item = this.data.images[i]
        // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æˆªå–åˆ°æ¯å¼ å›¾ç‰‡çš„åç¼€å
        let suffix = /\.\w+$/.exec(item)[0]

        wx.cloud.uploadFile({
          cloudPath: 'blog/' + Date.now() + '-' + Math.random() * 1000000 + suffix, //äº‘å­˜å‚¨è·¯å¾„ï¼Œå¿…é¡»å…ˆå­˜åœ¨ï¼Œè¿™é‡Œåšäº†å”¯ä¸€åŒ–ï¼Œé¿å…é‡åå¯¼è‡´çš„èµ„æºè¦†ç›–
          filePath: item,  // filePathè¡¨ç¤ºä¸Šä¼ æ–‡ä»¶èµ„æºçš„è·¯å¾„
          success: (res) => {
            // console.log(res)  // è¿”å›çš„resä¸­æœ‰fileID
            fileIds = fileIds.concat(res.fileID) //æ¯æ¬¡ä¸Šä¼ æˆåŠŸå°±æ·»åŠ fileIDåˆ°æ•°ç»„ä¸­
            resolve()
          },
          fail: (err) => {
            console.log(err)
            reject()
          }
        })
      })
      
      promiseArr.push(p) 
    }

    // fileIDå­˜å…¥äº‘æ•°æ®åº“
    Promise.all(promiseArr).then(res=>{
      db.collection('blog').add({
        data:{
          ...userInfo,
          content,
          img: fileIds,
          createTime: db.serverDate(),  //æœåŠ¡å™¨æ—¶é—´  
        }
      }).then(res=>{
        wx.hideLoading()
        wx.showToast({
          title: 'å‘å¸ƒæˆåŠŸ',
        })

        // è¿”å›åŠ¨æ€é¡µé¢ï¼Œå¹¶åˆ·æ–°
        wx.navigateBack()

        
      }).catch(err=>{
        wx.hideLoading()
        wx.showToast({
          title: 'å‘å¸ƒå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œ',
        })
      })
    })

  },
```

æ¥ä¸‹æ¥è¦åšçš„å°±æ˜¯åŠ¨æ€é¡µé¢çš„æ˜¾ç¤ºå’Œåˆ·æ–°ã€‚



### åšå®¢å¡ç‰‡ç»„ä»¶ä¸äº‘å‡½æ•°åŠ è½½æ•°æ®

#### äº‘å‡½æ•°blog

åœ¨ä¹è¯„åŠ¨æ€è¿™é‡Œçš„æ¯ä¸ªåšæ–‡åŠ¨æ€éƒ½é€šè¿‡åšå®¢å¡ç‰‡ç»„ä»¶æ¥æ˜¾ç¤ºï¼Œéœ€è¦å°è£…åšå®¢å¡ç‰‡ç»„ä»¶ã€‚

åœ¨æ­¤ä¹‹å‰å…ˆæ–°å»ºä¸€ä¸ªäº‘å‡½æ•°blogï¼Œå’Œä¹‹å‰çš„äº‘å‡½æ•°musicä¸€æ ·ï¼Œä¾æ—§æ˜¯ä½¿ç”¨tcb-routerè¿›è¡Œè·¯ç”±ä¼˜åŒ–ï¼Œå®‰è£…tcb-routerğŸ‘‡

```
npm install tcb-router --save
```

äº‘å‡½æ•°blogä¸­å®ç°listè·¯ç”±ç”¨ä»¥è·å–åšæ–‡æ•°æ®ğŸ‘‡

```js
// äº‘å‡½æ•°å…¥å£æ–‡ä»¶
const cloud = require('wx-server-sdk')

cloud.init()

const TcbRouter = require('tcb-router')
const db = wx.cloud.database()
const blogCollection = db.collection('blog')

// äº‘å‡½æ•°å…¥å£å‡½æ•°
exports.main = async (event, context) => {
  const app = new TcbRouter({
    event
  })

  app.router('list', async (ctx, next)=>{
    let blogList = await blogCollection.skip(event.start)
                    .limit(event.count)
                    .orderBy('createTime','desc')
                    .get()
                    .then(res=>{
                      return res.data
                    })
    ctx.body = blogList //è¿”å›æ•°æ®
  })

  return app.serve
}
```

ä¹‹åä¸Šä¼ éƒ¨ç½²åˆ°äº‘ç«¯ã€‚



#### blogé¡µé¢è°ƒç”¨äº‘å‡½æ•°blogåŠ è½½æ•°æ®

![](https://pic1.zhimg.com/80/v2-d4a6f83bcba7a8dada78cf177a94114c_hd.png)

è¿™é‡Œæš‚ä¸”å®šä¸º`start: 0, count: 10`ï¼Œä¹‹åè¦æ”¹çš„ã€‚

è¿™æ ·æ¯æ¬¡è¿›å…¥blogé¡µé¢å°±åŠ è½½äº†æ•°æ®åº“ä¸­çš„æ•°æ®ã€‚

åˆ°æ•°æ®åæ¥ä¸‹æ¥è¦åšçš„æ˜¯æ¸²æŸ“é¡µé¢ã€‚



#### åšå®¢å¡ç‰‡ç»„ä»¶

blogé¡µé¢ä¸­éå†æ•°æ®ï¼Œä½¿ç”¨åšå®¢å¡ç‰‡ç»„ä»¶blog-cardï¼š

```html
  <!-- åšå®¢å¡ç‰‡ -->
  <view class="blog-list">
    <block wx:for="{{blogList}}" wx:key="_id">
      <view class="blog-panel">
        <blog-card blog="{{item}}"  />
      </view>
    </block>
  </view>
```



```html
<!--components/blog-card/cmp.wxml-->
<view class="blog">
  <!-- æ˜µç§°ã€å¤´åƒã€å‘å¸ƒæ—¶é—´ -->
  <view class="blog-title">
    <image class="blog-portrait" src="{{blog.avatarUrl}}"></image>
    <view class="blog-box">
      <view>{{blog.nickName}}</view>
      <view class="blog-time">{{blog.createTime}}</view>
    </view>
  </view>
  <!-- åšæ–‡å†…å®¹ã€å›¾ç‰‡ -->
  <view class="blog-content" style='white-space:pre-wrap'>{{blog.content}}</view>
  <view class="blog-img">
    <block wx:for="{{blog.img}}" wx:key="{{index}}">
      <image class="img" src="{{item}}" mode="aspectFill"></image>
    </block>
  </view>
</view>
```



è¿™é‡Œæœ‰ä¸ªè¦æ³¨æ„çš„ï¼Œå¾®ä¿¡å°ç¨‹åº`<text>`å’Œ`<view>`æ ‡ç­¾å¹¶ä¸èƒ½è®©æ–‡æœ¬è‡ªåŠ¨æ¢è¡Œï¼Œè¿™å¯¼è‡´äº†æˆ‘æ–‡æœ¬ä¸­çš„ä¸€äº›æ¢è¡Œæ— æ³•æ˜¾ç¤ºå‡ºæ¥ï¼Œå¾®ä¿¡å°ç¨‹åºä¹Ÿä¸æ”¯æŒ `<br/>`æ¢è¡Œã€‚

å¤„ç†æ–¹æ³•ï¼š

```html

```

![](https://pic2.zhimg.com/80/v2-473c285c7a0be119ff6d0ad238772670_hd.png)

è¿™é‡Œå¤§ä½“ä¸Šçš„æ ·å¼æ²¡æ¯›ç—…äº†ï¼Œä½†æ˜¯æ—¶é—´è¿™é‡Œè¦æ ¼å¼åŒ–æˆæˆ‘ä»¬ä¹ æƒ¯çš„æ ¼å¼ã€‚



#### æ ¼å¼åŒ–æ—¶é—´

åœ¨utilsæ–‡ä»¶å¤¹æ–°å»ºä¸€ä¸ªformatTime.jsæ–‡ä»¶ï¼Œç”¨ä»¥ä¸“é—¨æ ¼å¼åŒ–æ—¶é—´ã€‚

```js
module.exports = (date)=>{
  let fmt = 'yyyy-MM-dd hh:mm'
  const o = {
    'M+': date.getMonth()+1,  // æœˆä»½ date.getMonth()å€¼ä¸º0~11ï¼Œæ‰€ä»¥è¦åŠ 1
    'd+': date.getDate(),     // æ—¥
    'h+': date.getHours(),    // æ—¶ 
    'm+': date.getMinutes(),  // åˆ†
  }

  if(/(y+)/.test(fmt)){
    fmt = fmt.replace(RegExp.$1, date.getFullYear())
  }
  for(let k in o){
    if(new RegExp('(' + k + ')').test(fmt)){
      // o[k].toString().length == 1åˆ¤æ–­æ˜¯ä¸æ˜¯0~9ï¼Œæ˜¯çš„è¯å‰é¢è¦è¡¥é›¶
      fmt = fmt.replace(RegExp.$1, o[k].toString().length==1 ? '0'+o[k] : o[k])
    }
  }
  return fmt
}
```



åœ¨åšå®¢å¡ç‰‡ç»„ä»¶ä¸­ä½¿ç”¨è¿™ä¸ªæ ¼å¼åŒ–åŠŸèƒ½ï¼Œæœ‰ä¸¤ç§æ–¹æ³•ï¼šä¸€ç§æ˜¯åœ¨ç»„ä»¶ç”Ÿå‘½å‘¨æœŸattachedæ—¶æ ¼å¼åŒ–ï¼Œå¦ä¸€ç§æ—¶é€šè¿‡observersæ ¼å¼åŒ–ï¼š

```js
// components/blog-card/cmp.js

// å¼•å…¥æ ¼å¼åŒ–æ—¶é—´çš„jsæ–‡ä»¶
import formatTime from '../../utils/formatTime.js'
Component({
  /**
   * ç»„ä»¶çš„å±æ€§åˆ—è¡¨
   */
  properties: {
    blog: Object
  },

  lifetimes:{
    attached(){
      // console.log(this.properties.blog)
      let createTime = new Date(this.properties.blog.createTime)  // è¦è®°å¾—å…ˆnew Date
      let fmt = formatTime(createTime)
      this.setData({
        _createTime: fmt
      })
    }
  },

  /**
   * ç»„ä»¶çš„åˆå§‹æ•°æ®
   */
  data: {
    _createTime: ''
  },

  /**
   * ç»„ä»¶çš„æ–¹æ³•åˆ—è¡¨
   */
  methods: {
  }
})

```



```js
// components/blog-card/cmp.js

// å¼•å…¥æ ¼å¼åŒ–æ—¶é—´çš„jsæ–‡ä»¶
import formatTime from '../../utils/formatTime.js'
Component({
  /**
   * ç»„ä»¶çš„å±æ€§åˆ—è¡¨
   */
  properties: {
    blog: Object
  },

  observers: {
    ['blog.createTime'](val){
      if(val){
        this.setData({
          _createTime: formatTime(new Date(val))  // è¦è®°å¾—å…ˆnew Date
        })
      }
    }
  },

  /**
   * ç»„ä»¶çš„åˆå§‹æ•°æ®
   */
  data: {
    _createTime: ''
  },

  /**
   * ç»„ä»¶çš„æ–¹æ³•åˆ—è¡¨
   */
  methods: {
  }
})

```



#### ä¸Šæ»‘ä¸‹æ‹‰åŠ è½½æ›´å¤š

å¯¹è¿›è¡Œä¿®æ”¹ï¼š

```js
  _loadBlogList( start = 0 ){ // startå˜æˆäº†ä¸€ä¸ªå‚æ•°ï¼Œé»˜è®¤ä¸º0
    wx.showLoading({
      title: 'åŠ è½½ä¸­',
    })
    wx.cloud.callFunction({
      name: 'blog',
      data:{
        start,
        count: 10,
        $url: 'list',
      }
    }).then(res=>{
      console.log(res)
      this.setData({
        blogList: this.data.blogList.concat(res.result)
      })
      wx.hideLoading()
      wx.stopPullDownRefresh()  //è¿™æ­¥ä¸å†™çš„è¯çœŸæœºä¸ä¼šå›å¼¹é¡µé¢
    })
  },
```

```js
  onPullDownRefresh: function () {
    this.setData({
      blogList: []
    })
    this._loadBlogList(0)
  },

  /**
   * é¡µé¢ä¸Šæ‹‰è§¦åº•äº‹ä»¶çš„å¤„ç†å‡½æ•°
   */
  onReachBottom: function () {
    this._loadBlogList(this.data.blogList.length)
  },
```



#### å›¾ç‰‡é¢„è§ˆ

å’Œä¹‹å‰çš„å‘å¸ƒåŠ¨æ€æ—¶çš„é¢„è§ˆå›¾ç‰‡å·®ä¸å¤šï¼Œä¾æ—§æ˜¯ä½¿ç”¨wx.previewImage()

```js
    onPreviewImage(event){
      console.log(event)
      wx.previewImage({
        urls: this.properties.blog.img,
        current: event.currentTarget.dataset.index
      })
    },
```

å¦å¤–æˆ‘è¿˜é«˜äº†ä¸€ä¸ªå¤´åƒé¢„è§ˆï¼š

```js
    onPreviewAvatar(event){
      console.log(event)
      wx.previewImage({
        urls: [].concat(this.properties.blog.avatarUrl)
      })
    }
```

è¿™é‡Œæœ‰ä¸ªæœ‰æ„æ€çš„äº‹ï¼Œè¿™ä¸ªç”¨æˆ·å¤´åƒçš„urlæ˜¯åœ¨ç”¨æˆ·è¦å‘å¸ƒåŠ¨æ€æ˜¯é€šè¿‡å¾®ä¿¡æˆæƒwx.getUserInfoå¾—åˆ°çš„ã€‚ç”¨æˆ·å¤´åƒå›¾ç‰‡çš„ URLã€‚URL æœ€åä¸€ä¸ªæ•°å€¼ä»£è¡¨æ­£æ–¹å½¢å¤´åƒå¤§å°ï¼ˆæœ‰ 0ã€46ã€64ã€96ã€132 æ•°å€¼å¯é€‰ï¼Œ0 ä»£è¡¨ 640x640 çš„æ­£æ–¹å½¢å¤´åƒï¼Œ46 è¡¨ç¤º 46x46 çš„æ­£æ–¹å½¢å¤´åƒï¼Œå‰©ä½™æ•°å€¼ä»¥æ­¤ç±»æ¨ã€‚é»˜è®¤132ï¼‰ï¼Œç”¨æˆ·æ²¡æœ‰å¤´åƒæ—¶è¯¥é¡¹ä¸ºç©ºã€‚è‹¥ç”¨æˆ·æ›´æ¢å¤´åƒï¼ŒåŸæœ‰å¤´åƒ URL å°†å¤±æ•ˆã€‚

é»˜è®¤132çš„å›¾ç‰‡é¢„è§ˆçœ‹èµ·æ¥å¤ªæ¨¡ç³Šäº†ï¼Œäºæ˜¯æˆ‘æ”¹äº†ä¸€ä¸‹/miniprogram/pages/blog/blog.js ä¸­çš„onLoginSuccess()

ï¼Œæ‰‹åŠ¨æŠŠurlæœ«å°¾çš„'/132'æ”¹æˆäº†â€™/0â€˜ï¼Œè¿™æ ·å°±æ˜¯é«˜æ¸…åŸå›¾ äº†ã€‚



#### åšæ–‡è¯¦æƒ…

ç‚¹å‡»åšæ–‡è·³è½¬åˆ°åšæ–‡è¯¦æƒ…ä¸­ï¼Œå¯ä»¥çœ‹åˆ°è¯„è®ºã€‚

ç»‘å®šä¸€ä¸ªç‚¹å‡»äº‹ä»¶è§¦å‘goCommentå‡½æ•°ï¼ŒåŒæ—¶è‡ªå®šä¹‰ä¸€ä¸ªå±æ€§`data-blogid`ç”¨ä»¥ä¿å­˜å¹¶ä¼ é€’å½“å‰åšæ–‡çš„`_id`ï¼Œåšæ–‡è¯¦æƒ…é¡µå°±å¯ä»¥é€šè¿‡è¿™ä¸ª`blogid`å‘äº‘æ•°æ®åº“è·å–åˆ°æ•°æ®ã€‚

```html
  <!-- åšå®¢å¡ç‰‡ -->
  <view class="blog-list">
    <block wx:for="{{blogList}}" wx:key="_id">
      <view class="blog-panel">
        <blog-card blog="{{item}}"
                   data-blogid="{{item._id}}"
                   bindtap="goComment" />
      </view>
    </block>
  </view>
```

```js
  goComment(event){
    console.log(event)
    wx.navigateTo({
      url: '../../pages/blog-comment/blog-comment?blogId='+event.target.dataset.blogid,
    })
  },
```

ä½†æ˜¯ç”±äºäº‹ä»¶å†’æ³¡çš„å½±å“ï¼Œå½“æˆ‘ç‚¹å‡»å›¾ç‰‡æƒ³è¦é¢„è§ˆçš„æ—¶å€™ï¼Œä¹Ÿè§¦å‘äº†è·³è½¬åˆ°è¯¦æƒ…é¡µçš„äº‹ä»¶ã€‚æ‰€ä»¥è¦æŠŠä¹‹å‰å¤´åƒé¢„è§ˆå’Œå›¾ç‰‡é¢„è§ˆæ—¶ä½¿ç”¨çš„`bindtap`æ”¹æˆ`catchtap`ã€‚è¿™æ ·å°±è§£å†³äº†äº‹ä»¶å†’æ³¡ã€‚



### ã€ä¼˜åŒ–ã€‘

ä¸€ã€å‘å¸ƒåŠ¨æ€çš„æ—¶å€™åŠ ä¸Šè’™æ¿æ•ˆæœï¼Œé¿å…ç”¨æˆ·å¤šæ¬¡ç‚¹å‡»å‘å¸ƒæŒ‰é’®ï¼Œè¿™ä¸€ç‚¹å°ç¨‹åºçš„showloadingæä¾›äº†ä¸€ä¸ªmaské€‰é¡¹ï¼Œéå¸¸ä¾¿æ·ã€‚

/miniprogram/pages/blog-edit/blog-edit.js  ğŸ‘‡

```js
    wx.showLoading({
      title: 'å‘å¸ƒä¸­',
      mask: true,  //æœ‰è’™æ¿æ•ˆæœ
    })
```



äºŒã€å‘å¸ƒåŠ¨æ€åè‡ªåŠ¨åˆ·æ–°ä¹è¯„åšå®¢åŠ¨æ€é¡µé¢

â€‹	![](https://pic1.zhimg.com/80/v2-5f6a5145640977926e83debd451b7154_hd.png)

æˆ‘ä»¬éœ€è¦åœ¨è¿™é‡Œåšäº›æ“ä½œã€‚æˆ‘ä»¬æƒ³è¦é¡µé¢è¿”å›åˆ°blogé¡µé¢ï¼Œç„¶åé‡æ–°åˆ·æ–°é¡µé¢ï¼Œè¿™ä¸ªæ“ä½œå¯ä»¥è°ƒç”¨blogçš„ä¸Šæ‹‰åˆ·æ–°çš„å‡½æ•°ã€‚é‚£ä¹ˆè¦å¦‚ä½•åœ¨blog-edité¡µé¢è°ƒç”¨blogé¡µé¢çš„å‡½æ•°å‘¢ï¼Ÿè¿™å°±è¦ç”¨åˆ°[getCurrentPages](https://developers.weixin.qq.com/miniprogram/dev/reference/api/getCurrentPages.html)ï¼Œè·å–å½“å‰é¡µé¢æ ˆã€‚æ•°ç»„ä¸­ç¬¬ä¸€ä¸ªå…ƒç´ ä¸ºé¦–é¡µï¼Œæœ€åä¸€ä¸ªå…ƒç´ ä¸ºå½“å‰é¡µé¢ã€‚

å…ˆæ¥çœ‹çœ‹è¿™ä¸ªé¡µé¢æ ˆé•¿å•¥æ ·ğŸ‘‡

![](https://pic1.zhimg.com/v2-335827d0a48555dc9584de2ee13c85ac_r.jpg)

è¿™æ ·åœ¨blog-edité¡µé¢å°±å¯ä»¥æ‹¿åˆ°blogé¡µé¢çš„å®ä¾‹äº†ï¼Œè¿›è€Œå¯ä»¥è°ƒç”¨blogçš„ä¸Šæ‹‰åˆ·æ–°å‡½æ•°ğŸ‘‡



### ã€é‡å¤§bugã€‘å®ç°å›¾ç‰‡ä¸ä¹±åº

ç”±äºå›¾ç‰‡åœ¨ä¸Šä¼ çš„æ—¶å€™ä½¿ç”¨çš„æ˜¯promise.allï¼Œå„ä¸ªpromiseä¹‹é—´æ²¡æœ‰ä¸¥æ ¼çš„å…ˆåé¡ºåºï¼Œå¯¼è‡´å›¾ç‰‡çš„é¡ºåºä¹±äº†ï¼ï¼ï¼

æ‰€ä»¥æ˜¯ä¸å¯ä»¥ç”¨å¼‚æ­¥çš„æ–¹å¼æ¥ä¸Šä¼ å¤šå¼ å›¾ç‰‡çš„ï¼Œéœ€è¦ç”¨**é€’å½’**çš„æ–¹å¼ï¼

```js
  // å‘å¸ƒåŠŸèƒ½
  // å›¾ç‰‡æ•°æ® â€”â€”> äº‘å­˜å‚¨   fileID â€”â€”>äº‘æ•°æ®åº“
  send() {

    if (content.trim() === '') {
      wx.showModal({
        title: 'è¯·å†™ç‚¹ä»€ä¹ˆå§~',
        content: '',
      })
      return
    }
    //ğŸ‘†æ–‡æœ¬ä¸ºç©ºä¸å…è®¸ï¼Œæ–‡æœ¬ä¸ä¸ºç©ºæ‰æ‰§è¡Œä¸‹é¢çš„ç¨‹åºğŸ‘‡

    wx.showLoading({
      title: 'å‘å¸ƒä¸­',
      mask: true,  //æœ‰è’™æ¿æ•ˆæœ
    })

    let imagesObj = {}
    imagesObj.urlList = this.data.images //this.data.imagesæ˜¯ç”±æ‰€æœ‰å·²é€‰å›¾ç‰‡urlç»„æˆçš„æ•°ç»„
    let fileIds = []  // ç”¨äºå­˜å‚¨fileID
    this.uploadimg(imagesObj, fileIds)


  },


  uploadimg(imgObj, fileIds) {
    var that = this,
      i = imgObj.i ? imgObj.i : 0,//å½“å‰ä¸Šä¼ çš„å“ªå¼ å›¾ç‰‡
      success = imgObj.success ? imgObj.success : 0,//ä¸Šä¼ æˆåŠŸçš„ä¸ªæ•°
      fail = imgObj.fail ? imgObj.fail : 0;//ä¸Šä¼ å¤±è´¥çš„ä¸ªæ•°

    let item = imgObj.urlList[i]
    // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æˆªå–åˆ°æ¯å¼ å›¾ç‰‡çš„åç¼€å
    let suffix = /\.\w+$/.exec(item)[0]
    
    wx.cloud.uploadFile({
      cloudPath: 'blog/' + Date.now() + '-' + Math.random() * 1000000 + suffix, //äº‘å­˜å‚¨è·¯å¾„ï¼Œå¿…é¡»å…ˆå­˜åœ¨ï¼Œè¿™é‡Œåšäº†å”¯ä¸€åŒ–ï¼Œé¿å…é‡åå¯¼è‡´çš„èµ„æºè¦†ç›–
      filePath: imgObj.urlList[i],
      success: (res) => {
        success++;//å›¾ç‰‡ä¸Šä¼ æˆåŠŸï¼Œå›¾ç‰‡ä¸Šä¼ æˆåŠŸçš„å˜é‡+1
        console.log(res)
        fileIds = fileIds.concat(res.fileID) //æ¯æ¬¡ä¸Šä¼ æˆåŠŸå°±æ·»åŠ fileIDåˆ°æ•°ç»„ä¸­
        console.log(i);
        //è¿™é‡Œå¯èƒ½æœ‰BUGï¼Œå¤±è´¥ä¹Ÿä¼šæ‰§è¡Œè¿™é‡Œ,æ‰€ä»¥è¿™é‡Œåº”è¯¥æ˜¯åå°è¿”å›è¿‡æ¥çš„çŠ¶æ€ç ä¸ºæˆåŠŸæ—¶ï¼Œè¿™é‡Œçš„successæ‰+1
      },
      fail: (res) => {
        fail++;//å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼Œå›¾ç‰‡ä¸Šä¼ å¤±è´¥çš„å˜é‡+1
        console.log('fail:' + i + "fail:" + fail);
        wx.hideLoading()
        wx.showToast({
          title: 'å›¾ç‰‡ä¸Šä¼ å¤±è´¥',
          icon: 'none'
        })
      },
      complete: () => {
        console.log(i);
        i++;//è¿™ä¸ªå›¾ç‰‡æ‰§è¡Œå®Œä¸Šä¼ åï¼Œå¼€å§‹ä¸Šä¼ ä¸‹ä¸€å¼ 
        if (i == imgObj.urlList.length) {   //å½“å›¾ç‰‡ä¼ å®Œæ—¶ï¼Œåœæ­¢è°ƒç”¨          
          console.log('æ‰§è¡Œå®Œæ¯•');
          console.log('æˆåŠŸï¼š' + success + " å¤±è´¥ï¼š" + fail);

          if(fail===0&&success===imgObj.urlList.length){ //å…¨éƒ¨ä¸Šä¼ æˆåŠŸæ—¶ï¼Œè¿›è¡Œæ•°æ®å­˜å…¥äº‘æ•°æ®åº“
            console.log(fileIds)
            // fileIDå­˜å…¥äº‘æ•°æ®åº“
            db.collection('blog').add({
              data: {
                ...userInfo,
                content,
                img: fileIds,
                createTime: db.serverDate(),  //æœåŠ¡å™¨æ—¶é—´  
              }
            }).then(res => {
              wx.hideLoading()
              wx.showToast({
                title: 'å‘å¸ƒæˆåŠŸ',
              })

              // è¿”å›åŠ¨æ€é¡µé¢ï¼Œå¹¶åˆ·æ–°
              wx.navigateBack()
              const pages = getCurrentPages()
              console.log(pages)
              const pervPage = pages[pages.length - 2] //æ‹¿åˆ°ä¸Šä¸€é¡µé¢çš„å®ä¾‹
              pervPage.onPullDownRefresh() //è°ƒç”¨ä¸Šä¸€é¡µé¢çš„ä¸Šæ‹‰åˆ·æ–°å‡½æ•°

            }).catch(err => {
              wx.hideLoading()
              wx.showToast({
                title: 'å‘å¸ƒå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œ',
                icon: 'none'
              })
            })
          }
        } else {//è‹¥å›¾ç‰‡è¿˜æ²¡æœ‰ä¼ å®Œï¼Œåˆ™ç»§ç»­è°ƒç”¨å‡½æ•°
          console.log(i);
          imgObj.i = i;
          imgObj.success = success;
          imgObj.fail = fail;
          that.uploadimg(imgObj, fileIds);
        }

      }
    });

  },
```



### äº‘æ•°æ®åº“æ¨¡ç³ŠæŸ¥è¯¢ä¸ç´¢å¼•ç®¡ç†

åœ¨æœç´¢æ¡†å’ŒæŒ‰é’®ç»‘å®šäº‹ä»¶ğŸ‘‡

```html
<!--components/search/cmp.wxml-->
<view class="container">
  <i class="iconfont icon-sousuo find"></i>
  <input class="bar" 
         placeholder="{{placeholder}}" 
         placeholder-class="in-bar"
         bindinput="onInput"></input>
  <button size="mini" class="search" bindtap="onSearch">æœç´¢</button>
</view>
```

```js
  methods: {
    onInput(event){
      console.log(event)
      keywords = event.detail.value
    },


    onSearch(){
      console.log(keywords)
    },
  }
```

è·å–åˆ°è¾“å…¥çš„å…³é”®å­—æ¥ä¸‹æ¥å°±æ˜¯å‘èµ·å¯¹æ•°æ®åº“çš„æŸ¥è¯¢äº†ï¼Œè¿™ä¸€æ­¥ä¸è¦å†™åœ¨searchè¿™ä¸ªç»„ä»¶ä¸­ï¼Œæœ€å¥½å†™åœ¨blogä¸­ï¼Œè®©searchç»„ä»¶å‘blogå‘èµ·æŸ¥è¯¢æ“ä½œï¼Œè¿™æ ·åˆ†ç¦»ä¸šåŠ¡æ¯”è¾ƒåˆç†ã€‚

![](https://pic4.zhimg.com/80/v2-1a492d111c3da0c7cc452ece7f6ea54f_hd.jpg)

![](https://pic4.zhimg.com/v2-9b004c552718361111b10884d3bf3e1f_r.jpg)

/miniprogram/pages/blog/blog.js ğŸ‘‡

```js
  onSearch(event){
    console.log(event.detail.keyword)
    // æˆ‘ä»¬æœç´¢å‡ºç»“æœçš„æ—¶å€™ï¼Œé¦–å…ˆæ¸…ç©ºblogList
    this.setData({
      blogList: [],
    })
    keyword=event.detail.keyword
      //é‡æ–°åŠ è½½åšå®¢é¡µé¢
    this._loadBlogList(0)
  },
```

è¿™é‡Œæˆ‘ä»¬å°±è¦é‡æ–°æ”¹é€ ä¸€ä¸‹_loadBlogListè¿™ä¸ªå‡½æ•°äº†ï¼Œéœ€è¦æŠŠkeywordä¹Ÿä½œä¸ºè°ƒç”¨äº‘å‡½æ•°blogçš„ä¸€ä¸ªå‚æ•°ä¼ å…¥ğŸ‘‡

![](https://pic3.zhimg.com/v2-e252c803cb75b12c749f4a395804fffa_r.jpg)

è¿›è€Œäº‘å‡½æ•°blogä¹Ÿè¦è¿›è¡Œæœ‰å…³å¯¹äº‘æ•°æ®åº“æ¨¡ç³ŠæŸ¥è¯¢çš„ä¿®æ”¹ğŸ‘‡

è¿™é‡Œä½¿ç”¨äº†**äº‘å¼€å‘çš„æ­£åˆ™è¡¨è¾¾å¼**

![](https://pic3.zhimg.com/v2-9b8ed2d647a69012f846320b88bbb43e_r.jpg)

æ•ˆæœğŸ‘‡

![](https://pic1.zhimg.com/80/v2-0fb16305ce2888387999c03ce79bf2bd_hd.png)



#### æ·»åŠ ç´¢å¼•ä¼˜åŒ–æœç´¢é€Ÿåº¦

![](https://pic2.zhimg.com/v2-25a391f5c87f36f73b6af46d3bed236d_r.jpg)

è¿™æ ·ç»™contentå­—æ®µæ·»åŠ ç´¢å¼•ï¼Œå¯ä»¥ä¼˜åŒ–æœç´¢é€Ÿåº¦ã€‚



### äº‘æ•°æ®åº“æƒé™ç®¡ç†

![](https://pic1.zhimg.com/v2-855598f6fa06f9fa858e0618d02e8ce4_r.jpg)

ä»¥ä¸Šæ˜¯äº‘æ•°æ®åº“çš„æƒé™ç®¡ç†ï¼Œé»˜è®¤æ˜¯ä»…æœ‰åˆ›å»ºè€…å¯è¯»å†™ï¼Œè®°å¾—ä¿®æ”¹æˆæ‰€æœ‰ç”¨æˆ·å¯è¯»ï¼Œä»…åˆ›å»ºè€…å¯è¯»å†™ã€‚



å¦å¤–ï¼Œå¯¹äºäº‘æ•°æ®åº“çš„æ“ä½œéƒ½æ”¾åœ¨äº‘å‡½æ•°ä¸­è¿›è¡Œï¼Œä¸è¦åœ¨å°ç¨‹åºç«¯è¿›è¡Œï¼Œæœ‰å‘ï¼Œæ¯”å¦‚å°ç¨‹åºç«¯è¯»å–æ•°æ®åªèƒ½è¯»å–20æ¡ã€‚



## 6.è¯„è®ºä¸åˆ†äº«

```
- äº‘æ•°æ®åº“ä¸­1å¯¹Nå…³ç³»çš„ä¸‰ç§è®¾è®¡æ–¹å¼
- äº‘è°ƒç”¨å®ç°æ¨¡æ¿æ¶ˆæ¯æ¨é€
- äº‘æ•°æ®åº“å¤šé›†åˆæŸ¥è¯¢
- åšå®¢åˆ†äº«ç»™å¥½å‹
```

### åšå®¢æ§åˆ¶ç»„ä»¶

è¿™ä¸ªæ§åˆ¶ç»„ä»¶åŒ…æ‹¬**è¯„è®ºåŠŸèƒ½**å’Œ**åˆ†äº«åŠŸèƒ½**ã€‚

ç”¨æˆ·ç‚¹å‡»è¯„è®ºçš„æ—¶å€™ï¼Œæˆ‘ä»¬è¦å…ˆåˆ¤æ–­ç”¨æˆ·æ˜¯å¦å·²ç»æˆæƒè¿‡ï¼Œåªæœ‰æˆæƒè¿‡çš„æ‰å¯ä»¥è¿›è¡Œè¯„è®ºã€‚è¿™é‡Œå¯ä»¥å¤ç”¨å‰é¢å°è£…è¿‡çš„**loginæˆæƒç»„ä»¶**ã€‚æˆæƒè¿‡åï¼Œç”¨æˆ·è¿›è¡Œè¾“å…¥è¯„è®ºçš„å†…å®¹ï¼Œè¿™éƒ¨åˆ†æˆ‘ä»¬ä½¿ç”¨çš„ä¹‹å‰çš„**åº•éƒ¨å¼¹å‡ºå±‚ç»„ä»¶**ã€‚



æ–°å»ºç»„ä»¶ğŸ‘‰/miniprogram/components/blog-ctrl/cmp.wxml 

è¦åœ¨blog.jsonå¼•å…¥è€Œéåœ¨blog-cardä¸­å¼•å…¥ã€‚

```json
  "usingComponents": {
    "search-cmp": "../../components/search/cmp",
    "login-cmp": "/components/login/cmp",
    "blog-card": "/components/blog-card/cmp",
    "blog-ctrl": "/components/blog-ctrl/cmp"
  },
```



è¿™é‡Œåˆæ›´æ–°äº†ä¸¤ä¸ªæ–°å›¾æ ‡ï¼Œè¯„è®ºå’Œåˆ†äº«ï¼Œè€æ ·å­åœ¨iconfontå®˜ç½‘ä¸Šæ‰¾ï¼Œç„¶åæ›´æ–°é¡¹ç›®ä¸­iconfont.cssæ ·å¼ä»£ç ã€‚

```html
// miniprogram/components/blog-ctrl/cmp.wxml 
<view class="ctrl">
  <view class="ctrl-item" bindtap="onComment">
    <i class="iconfont icon-pinglun icon"></i>
    <text>è¯„è®º</text>
  </view>
  <view class="ctrl-item share">
    <i class="iconfont icon-fenxiang icon"></i>
    <text>åˆ†äº«</text>
  </view>
</view>

```



```css
//miniprogram/components/blog-ctrl/cmp.wxss 
.ctrl{
  display: flex;
  align-items: center;
  background-color: #fff;
  height: 100%;
}

.ctrl-item{
  flex: 1;
  text-align: center;
  color: rgba(40, 47, 60, 0.8);
  font-size: 26rpx;
  height: 60rpx;
  display: flex;
  flex-direction: row;
  align-items: center;
  justify-content: center;
}

.ctrl-item .icon{
  margin-right: 12rpx;
  font-size: 32rpx;
}

.ctrl-item text {
  font-size: 32rpx;
}
```

ç„¶åæˆ‘æŸ¥çœ‹é¡µé¢ï¼Œå‘ç°iconå›¾æ ‡å¹¶æ²¡æœ‰å‡ºç°ï¼Œè¿™é‡Œæˆ‘çŠ¯äº†ä¸€ä¸ªä¹‹å‰çš„é”™è¯¯ï¼Œç»„ä»¶ä¼šå±è”½å¤–ç•Œçš„cssæ ·å¼ï¼Œè¿™å°±æ˜¯[ç»„ä»¶æ ·å¼éš”ç¦»](https://developers.weixin.qq.com/miniprogram/dev/framework/custom-component/wxml-wxss.html#%E7%BB%84%E4%BB%B6%E6%A0%B7%E5%BC%8F%E9%9A%94%E7%A6%BB) ã€‚æ‰€ä»¥è¯´å…¨å±€ä½œç”¨ä¸‹çš„iconfont.wxssæ˜¯ä½œç”¨ä¸åˆ°è¯¥ç»„ä»¶çš„ã€‚æˆ‘ä»¬ç”¨å¤–éƒ¨æ ·å¼ç±»externalClassesæ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ğŸ‘‡

å¯¹äºblogè¿™ä¸ªé¡µé¢æ¥è¯´ï¼Œå®ƒæ˜¯pagesè·¯å¾„ä¸‹çš„ï¼Œä¸æ˜¯ç»„ä»¶ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨iconfont.cssï¼Œè€Œä¸”blog-ctrlä¹Ÿæ˜¯åœ¨blogè¿™ä¸ªé¡µé¢ä½¿ç”¨çš„ã€‚

![](https://pic2.zhimg.com/80/v2-6460416e64bb56f7676ef93258e6317f_hd.png)

åœ¨å¼•ç”¨blog-ctrlçš„åŒæ—¶ï¼Œå°†iconfont.cssä¸­çš„å›¾æ ‡å¯¹åº”çš„æ ·å¼åä¼ å…¥ç»™ç»„ä»¶blog-ctrlã€‚ç„¶åblog-ctrl.jsç§è¿›è¡Œæ³¨å†ŒğŸ‘‡

![](https://pic2.zhimg.com/80/v2-a93c32e709057d98e78251fba37f6a77_hd.png)

ä¹‹åå°±å¯ä»¥æˆåŠŸæ˜¾ç¤ºå‡ºæ¥äº†ğŸ‘‡

![](https://pic1.zhimg.com/80/v2-8fce64ddb2395cd373daae964524e868_hd.png)



#### ç‚¹å‡»è¯„è®ºæŒ‰é’®çš„åŠŸèƒ½

åœ¨ç‚¹å‡»äº†è¯„è®ºæŒ‰é’®çš„æ—¶å€™ï¼Œä¼šå…ˆåˆ¤æ–­æ˜¯å¦å·²æˆæƒï¼Œè‹¥å·²æˆæƒåˆ™å¯ä»¥å¼€å§‹å†™è¯„è®ºï¼Œå¦åˆ™è¦å…ˆæˆæƒã€‚

è¿™é‡Œblog-ctrlä¼šå¼•ç”¨å‰é¢å°è£…è¿‡çš„æˆæƒç»„ä»¶loginï¼Œç°åœ¨jsoné…ç½®ç§è¿›è¡Œå¼•å…¥ğŸ‘‡

```json
{
  "component": true,
  "usingComponents": {
    "login-cmp": "/components/login/cmp"
  }
}
```

ç„¶ååœ¨blog-ctrl.wxmlä¸­ä½¿ç”¨ï¼Œè¿™é‡Œloginç»„ä»¶ä¸­æœ‰ä¸€ä¸ªå±æ€§showæ¥è§„å®šå…¶è‡ªèº«æ˜¾ç¤ºä¸å¦ï¼Œéœ€è¦è°ƒç”¨è€…ä¼ å…¥ã€‚æ‰€ä»¥åœ¨ä½¿ç”¨loginç»„ä»¶çš„æ—¶å€™è¦ä¼ é€’ä¸€ä¸ªshowçš„å€¼ï¼Œè€Œè¿™ä¸ªå€¼ä¹Ÿæ˜¯ç”±blog-ctrl.jsè¿›è¡Œç®¡ç†ã€‚

![](https://pic4.zhimg.com/80/v2-9d0db556ce7ca6f5e659eb68e7a98627_hd.png)

![](https://pic3.zhimg.com/v2-10fb2fe00abd549e95afe74e0fe9201e_r.jpg)

å…ˆæ¸…æ¥šæˆæƒç¼“å­˜ï¼Œç„¶åæµ‹è¯•ä¸€ä¸‹ğŸ‘‡

![](https://pic4.zhimg.com/80/v2-0e88118e00caade1d743be36c26dd744_hd.png)

è¿™é‡Œçš„â€œæ‹’ç»â€å’Œâ€œå…è®¸â€ç‚¹å‡»äº†ä¹‹åè¦æœ‰ä¸€äº›åŠ¨ä½œï¼Œæˆ‘ä»¬åœ¨å°è£…loginç»„ä»¶çš„æ—¶å€™ï¼Œç•™ä¸‹äº†ä¸¤ä¸ªå¾ˆçµæ´»çš„äº‹ä»¶ğŸ‘‡

![](https://pic2.zhimg.com/80/v2-612a3cc04197b408224292ec82ae5b52_hd.png)

![](https://pic3.zhimg.com/80/v2-c322f843b563b2d75a4ab0aa2917bfec_hd.png)

è¿›è€Œå¯ä»¥åœ¨/miniprogram/components/blog-ctrl/cmp.js ä¸­è¿›è¡ŒonLoginsuccesså’ŒonLoginfailçš„ç¼–å†™ã€‚

![](https://pic1.zhimg.com/80/v2-271881f9fa45d65b132578224d2f0705_hd.png)

#### å¤ç”¨åº•éƒ¨å¼¹å‡ºå±‚å®ç°è¯„è®ºæ¡†

è¿™éƒ¨åˆ†è¿›è¡Œè¯„è®ºæ¡†çš„å®ç°ï¼Œè¿™é‡Œå¼•ç”¨åˆ°ä¹‹å‰å°è£…å¥½çš„åº•éƒ¨å¼¹å‡ºå±‚ç»„ä»¶/components/bottom-layer/cmp.wxml 

å…ˆåœ¨jsoné…ç½®ä¸­è¿›è¡Œå¼•å…¥ï¼Œç„¶åä½¿ç”¨ä¹‹ğŸ‘‡

![](https://pic1.zhimg.com/80/v2-a27ecd8038a52976abe4a8516eeed4de_hd.png)

åŒæ ·çš„åº•éƒ¨å¼¹å‡ºå±‚çš„æ˜¾ç¤ºä¸å¦ä¹Ÿä¸ä¸€ä¸ªå±æ€§æœ‰å…³ã€‚é»˜è®¤å€¼ä¸ºfalseï¼Œå…¶å€¼åœ¨/miniprogram/components/blog-ctrl/cmp.js ä¸­ä¼šéšç€å„ç§æ“ä½œè€Œå˜åŒ–ã€‚è¿™é‡Œä¸è¯¦ç»†è®°å½•ã€‚



![](https://pic1.zhimg.com/80/v2-0e999f1a323389802aae73acb11e8da7_hd.png)

ç›®å‰è¿™ä¸ªåº•éƒ¨å¼¹å‡ºå±‚è¿˜æ˜¯ä¸€ç‰‡ç©ºç™½ï¼Œå®ƒä½¿ç”¨äº†slotç»“æ„ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦è¿›è¡Œå¯¹å…¶å†…å®¹çš„ç¼–å†™ğŸ‘‡

```html
<bottom-layer  layerShow="{{layerShow}}">
  <view slot="layer-content">
    <textarea name="content" class="comment-content" 
    placeholder="åˆ†äº«ä½ çš„è¯„è®º~" value="{{content}}"
    fixed="true"></textarea>
    <button size="mini" class="send">å‘å¸ƒ</button>
  </view>
</bottom-layer>

/miniprogram/components/blog-ctrl/cmp.wxml 
```



### äº‘æ•°æ®åº“ä¸­1å¯¹Nå…³ç³»çš„ä¸‰ç§è®¾è®¡æ–¹å¼

æ‰€è°“æ•°æ®åº“ä¸­çš„1å¯¹Nå…³ç³»ï¼Œä¸¾ä¸ªæ —å­å³ä¸€ä¸ªå­¦ç”Ÿå¯ä»¥é€‰ä¿®å¤šé—¨è¯¾ç¨‹ï¼Œä¸€æ¡åšå®¢åŠ¨æ€å¯ä»¥å¯¹åº”å¤šå¼ å›¾ç‰‡ã€å¤šæ¡è¯„è®ºã€‚

æœ¬é¡¹ç›®ä¸­çš„åšæ–‡åŠ¨æ€å°±æ¶‰åŠåˆ°è¿™ç§äº‘æ•°æ®åº“1å¯¹Nçš„å…³ç³»ã€‚

è¿™é‡Œä¸€æ¡åšæ–‡åŠ¨æ€å¯¹åº”ç€Næ¡è¯„è®ºï¼Œæ ¹æ®Nçš„æ•°é‡çº§å¤§å°å¯ä»¥æœ‰ä¸‰ç§è®¾è®¡æ–¹å¼ï¼š

ã€ä¸€ã€å½“Nä¸ºå‡ ä¸ªæˆ–è€…äºŒåå‡ ä¸ªæ—¶ã€‘ï¼š

â€‹	ç›´æ¥åœ¨æ¯ä¸€æ¡blogçš„åŠ¨æ€æ•°æ®ä¸­ä¿å­˜ä¸€ä¸ªè¯„è®ºæ•°ç»„ï¼Œé‡Œé¢ä¿å­˜ç€è¯¥blogçš„æ‰€æœ‰è¯„è®ºï¼Œç±»ä¼¼ä¸‹é¢çš„img

â€‹	![](https://pic2.zhimg.com/v2-cd634431d3c6435091dc73fe93f28b81_r.jpg)



ã€äºŒã€å½“Nä¸ºå‡ åä¸ªæ—¶ã€‘

è¿™æ—¶ä¹‹å‰çš„æ–¹æ³•ä¸€å°±ä¸å¤ªé€‚åˆäº†ï¼Œå¯ä»¥å¦å¤–æ–°å»ºä¸€ä¸ªè¯„è®ºé›†åˆcommentï¼Œå…¶ä¸­æ¯æ¡æ•°æ®éƒ½æœ‰ä¸€ä¸ªè‡ªå·±çš„idï¼Œè€Œblogæ¯ä¸€æ¡åŠ¨æ€æ•°æ®éƒ½ä¿å­˜å…¶å¯¹åº”çš„è¯„è®ºidï¼Œé€šè¿‡è¯„è®ºidè¿›ä¸€æ­¥æŸ¥æ‰¾å¾—åˆ°è¯„è®ºå†…å®¹ã€‚

å³1è®°å½•Nçš„ä¿¡æ¯



ã€ä¸‰ã€å½“Nä¸ºæˆç™¾ä¸Šåƒæ—¶ã€‘

æ–°å»ºè¯„è®ºé›†åˆcommentï¼Œæ¯ä¸€æ¡è¯„è®ºæ•°æ®éƒ½ä¿å­˜å…¶å¯¹åº”çš„åŠ¨æ€çš„idï¼Œä¸€æ¡åŠ¨æ€æƒ³è¦å¾—åˆ°å…¶æ‰€æœ‰è¯„è®ºï¼Œå¯ä»¥æ ¹æ®å…¶åŠ¨æ€idæ¥æŸ¥æ‰¾æ‰€æœ‰åŒ…å«è¯¥idçš„è¯„è®ºã€‚

å³Nè®°å½•1çš„ä¿¡æ¯ã€‚

æœ¬é¡¹ç›®é‡‡ç”¨æ–¹æ³•ä¸‰ã€‚





### è¯„è®ºåŠŸèƒ½å®ç°

æ–°å»ºä¸€ä¸ªè¯„è®ºé›†åˆblog-commentç”¨ä»¥å­˜æ”¾æ‰€æœ‰çš„è¯„è®ºæ•°æ®ã€‚

åœ¨å†™å®Œè¯„è®ºç‚¹å‡»å‘é€æŒ‰é’®æ—¶ï¼Œè§¦å‘äº‹ä»¶ï¼Œæ‰§è¡Œjså‡½æ•°onSend

![](https://pic4.zhimg.com/80/v2-9666131e4a23395f28060bab83deb68e_hd.png)

```js
   // components/blog-ctrl/cmp.js
let userInfo = {}
const db = wx.cloud.database()

onInput(event){
      this.setData({
        content: event.detail.value
      })
      // console.log(this.data.content)
    },

    onSend(){

      // æ’å…¥æ•°æ®åº“
      let content = this.data.content
      if(content.trim()==""){
        wx.showModal({
          title: 'è¯„è®ºå†…å®¹ä¸èƒ½ä¸ºç©º',
          content: '',
        })
        return
      }

      wx.showLoading({
        title: 'è¯„è®ºä¸­',
        mask: true,
      })

      db.collection('blog-comment').add({
        data: {
          content,
          createTime: db.serverDate(),
          blogId: this.properties.blogId,
          nickName: userInfo.nickName,
          avatarUrl: userInfo.avatarUrl
        }
      }).then(res=>{
        wx.hideLoading()
        wx.showToast({
          title: 'è¯„è®ºæˆåŠŸ',
        })

        // æ”¶èµ·è¯„è®ºæ¡†
        this.setData({
          layerShow: false,
          content: ""
        })
      })

      // æ¨é€æ¨¡æ¿æ¶ˆæ¯
    },
```

è¿™é‡Œç›´æ¥åœ¨å®¢æˆ·ç«¯å¤„å°†æ•°æ®å­˜å…¥äº‘æ•°æ®åº“ä¸­ã€‚

æ¥ä¸‹æ¥å®Œæˆè®¢é˜…æ¶ˆæ¯æ¨é€åŠŸèƒ½ã€‚



### è®¢é˜…æ¶ˆæ¯æ¨é€åŠŸèƒ½

æ‰€è°“â€œè®¢é˜…æ¶ˆæ¯æ¨é€â€ï¼Œå°±æ˜¯ä½ å‘é€äº†ä¸€æ¡åŠ¨æ€ã€‚ç„¶åæœ‰åˆ«äººè¯„è®ºäº†è¯¥åŠ¨æ€ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å¾®ä¿¡é€šçŸ¥ä½ ã€‚è¿™é‡Œè¦ç”¨åˆ°**äº‘è°ƒç”¨åŠŸèƒ½**ã€‚

ã€äº‘è°ƒç”¨ã€‘å®˜æ–¹æ–‡æ¡£ğŸ‘‰[ç‚¹å‡»](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/guide/openapi/openapi.html#%E4%BA%91%E8%B0%83%E7%94%A8)

åŸºäºäº‘å‡½æ•°ï¼Œé€šè¿‡äº‘å‡½æ•°å»è°ƒç”¨æœåŠ¡ç«¯çš„ä¸€äº›å¼€æ”¾æ¥å£ï¼Œè¿™äº›æ¥å£åŒ…æ‹¬æ¨¡æ¿æ¶ˆæ¯æ¨é€ã€ç”Ÿæˆå°ç¨‹åºåŠŸèƒ½ç­‰ã€‚

æœ¬é¡¹ç›®å°±ç”¨åˆ°[è®¢é˜…æ¶ˆæ¯æ¨é€](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/subscribe-message.html)åŠŸèƒ½ã€‚

è¯·æ³¨æ„ï¼Œå°ç¨‹åºæ¨¡æ¿æ¶ˆæ¯æ¥å£å°†äº2020å¹´1æœˆ10æ—¥ä¸‹çº¿ï¼Œå¼€å‘è€…å¯ä½¿ç”¨[è®¢é˜…æ¶ˆæ¯åŠŸèƒ½](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/subscribe-message.html)

é¦–å…ˆè¦åˆ¶ä½œä¸€ä¸ªæ¶ˆæ¯æ¨¡æ¿ğŸ‘‡

åœ¨å¾®ä¿¡å…¬ä¼—å¹³å°æ‰‹åŠ¨é…ç½®è·å–æ¨¡æ¿ IDï¼š
ç™»å½• [https://mp.weixin.qq.com](https://mp.weixin.qq.com/) è·å–æ¨¡æ¿ï¼Œå¦‚æœæ²¡æœ‰åˆé€‚çš„æ¨¡æ¿ï¼Œå¯ä»¥ç”³è¯·æ·»åŠ æ–°æ¨¡æ¿ï¼Œå®¡æ ¸é€šè¿‡åå¯ä½¿ç”¨ã€‚

![intro](https://res.wx.qq.com/wxdoc/dist/assets/img/subscribe-message.b562750a.jpg)

è¿™æ˜¯æˆ‘é€‰å®šçš„ä¸€ä¸ªæ¨¡æ¿ğŸ‘‡

![](https://pic4.zhimg.com/v2-3f2894d071368e379eab2b4870f5dadf_r.jpg)

æ¨¡æ¿çš„IDæ˜¯æœ€é‡è¦çš„ï¼Œåé¢è¦ç”¨åˆ°ã€‚



æ–°å»ºä¸€ä¸ªäº‘å‡½æ•°sendMessageï¼Œåœ¨å…¶ç›®å½•ä¸‹æ–°å»ºä¸€ä¸ªconfig.jsonï¼Œæ³¨æ„å‘½åå¿…é¡»ä¸ºconfig.jsonï¼Œå†…å®¹å¦‚ä¸‹ğŸ‘‡

```json
{
  "permissions": {
    "openapi": [
      "subscribeMessage.send"
    ]
  }
}
```

ç„¶åç¼–å†™sendMessageçš„index.jsï¼š

ç”¨åˆ°äº†æœåŠ¡ç«¯æ¶ˆæ¯å‘é€æ¥å£ [subscribeMessage.send](https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/subscribe-message/subscribeMessage.send.html)ï¼Œè¿™é‡Œç”¨çš„æ˜¯[äº‘è°ƒç”¨çš„æ–¹å¼](https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/subscribe-message/subscribeMessage.send.html#method-cloud)

```js
// äº‘å‡½æ•°å…¥å£æ–‡ä»¶
const cloud = require('wx-server-sdk')

cloud.init()

// äº‘å‡½æ•°å…¥å£å‡½æ•°
exports.main = async (event, context) => {
  // const { OPENID } = cloud.getWXContext()
  try {
    const result = await cloud.openapi.subscribeMessage.send ({
      // touser: OPENID,
      touser: event.openid,  // è·å–åˆ°å½“å‰åŠ¨æ€å‘å¸ƒè€…çš„openidï¼Œå¾—ä»¥å¯¹å…¶å‘é€è®¢é˜…æ¶ˆæ¯
      page: `/pages/blog-comment/blog-comment?blogId=${event.blogId}`,
      data: {
        thing1:{
          value: "æ‚¨çš„ä¹è¯„åŠ¨æ€æœ‰äº†æ–°å›å¤"
        },
        thing3: {
          value: event.content  
        }
      },
      templateId: 'Vs66cfna_zW0TP4L53sqxY7d2wV8qLkS6TimIBIkfis'
    })
    console.log(result)
    return result
  } catch (err) {
    console.log(err)
    return err
  }
}

```

æ¥ä¸‹æ¥åœ¨onSendå‡½æ•°ä¸­è¿›è¡Œæ”¹é€ ï¼Œå®ç°**è·å–ä¸‹å‘æƒé™**ï¼Œä½¿ç”¨çš„äº‘è°ƒç”¨æ˜¯æ¶ˆæ¯è®¢é˜…æ¥å£ [wx.requestSubscribeMessage](https://developers.weixin.qq.com/miniprogram/dev/api/open-api/subscribe-message/wx.requestSubscribeMessage.html)ï¼Œç„¶ååœ¨è¯„è®ºæ•°æ®æ·»åŠ åˆ°äº‘æ•°æ®åº“ä¸­åè°ƒç”¨äº‘å‡½æ•°sendMessageè¿›è¡Œè®¢é˜…æ¶ˆæ¯æ¨é€ï¼š

```js
        onSend(){

      // æ’å…¥æ•°æ®åº“
      let content = this.data.content
      let that = this
      if(content.trim()==""){
        wx.showModal({
          title: 'è¯„è®ºå†…å®¹ä¸èƒ½ä¸ºç©º',
          content: '',
        })
        return
      }

      wx.showLoading({
        title: 'è¯„è®ºä¸­',
        mask: true,
      })

      // å¾€äº‘æ•°æ®åº“ä¸­æ’å…¥è¯„è®ºæ•°æ®
      db.collection('blog-comment').add({
        data: {
          content,
          createTime: db.serverDate(),
          blogId: that.properties.blogId,
          nickName: userInfo.nickName,
          avatarUrl: userInfo.avatarUrl
        }
      }).then(res => {
        console.log(res)
        // æ”¶èµ·è¯„è®ºæ¡†
        that.setData({
          layerShow: false,
          content: ""
        })

        wx.hideLoading()
        wx.showToast({
          title: 'è¯„è®ºæˆåŠŸ',
        })
      })

      wx.requestSubscribeMessage({
        tmplIds: ['Vs66cfna_zW0TP4L53sqxY7d2wV8qLkS6TimIBIkfis'],
        success(res) {
          console.log(res)
          // æ¨é€æ¨¡æ¿æ¶ˆæ¯
          wx.cloud.callFunction({
            name: 'sendMessage',
            data: {
              content,
              openid: that.properties.openid,
              blogId: that.properties.blogId
            }
          }).then(res => {
            console.log(res)
          }).catch(err => {
            console.log(err)
          })
         
        },
        fail(err) {
          console.log(err)
        },
        complete(data) {
          console.log(data)
        }
      })


    },
```

è¿™æ ·ï¼Œå½“ç”¨æˆ·å…è®¸äº†è®¢é˜…æ¶ˆæ¯çš„æ¨é€åï¼Œæ¯å½“åˆ«äººè¯„è®ºäº†ä»–çš„åŠ¨æ€ï¼Œéƒ½ä¼šæ”¶åˆ°ä¸€æ¡è®¢é˜…æ¶ˆæ¯ã€‚

ã€æœ‰ä¸ªè¦æ³¨æ„çš„ç‚¹ã€‘ï¼Œè‹¥ç”¨æˆ·æ— æ³•æ­£å¸¸æ”¶åˆ°åˆ«äººè¯„è®ºåŠ¨æ€çš„æ¶ˆæ¯é€šçŸ¥ï¼Œæ—¶å› ä¸ºç”¨æˆ·ä¸å…è®¸å½“å‰å°ç¨‹åºå¯åŠ¨â€æ¶ˆæ¯è®¢é˜…â€œï¼Œéœ€è¦ç”¨æˆ·æ‰‹åŠ¨åœ¨å°ç¨‹åºçš„è®¾ç½®ä¸­å¼€å¯â€æ¥æ”¶è®¢é˜…æ¶ˆæ¯â€œã€‚



<img src="https://pic2.zhimg.com/80/v2-4ce3c702544e2d1cb96b33cf22ed3bf3_hd.png" style="width:300px" />



### åšå®¢æ­£æ–‡å®ç°

#### ä»äº‘æ•°æ®åº“è·å–æ•°æ®

å½“æˆ‘ä»¬ç‚¹å‡»ä¸€æ¡åšæ–‡åŠ¨æ€çš„æ—¶å€™ï¼Œä¼šè·³è½¬åˆ°å…¶åšå®¢æ­£æ–‡ï¼Œå¹¶è·å–åˆ°åšå®¢çš„blogidï¼Œæ ¹æ®è¿™ä¸ªblogidå»äº‘æ•°æ®åº“è¯·æ±‚æ•°æ®ï¼Œè¿™ä¸ªæ•°æ®åŒ…æ‹¬åšæ–‡å’Œè¯„è®ºä¸¤éƒ¨åˆ†ã€‚

ä½†æ˜¯åšæ–‡æ•°æ®æ˜¯å­˜æ”¾åœ¨blogé›†åˆä¸­ï¼Œè¯„è®ºæ˜¯å­˜æ”¾åœ¨blog-commenté›†åˆä¸­ï¼Œæ‰€ä»¥éœ€è¦åˆ†åˆ«å‘ä¸¤ä¸ªæ•°æ®åº“é›†åˆå‘èµ·è¯·æ±‚ï¼Œè¿™é‡Œåœ¨äº‘å‡½æ•°blogä¸­è¿›è¡Œç¼–å†™ğŸ‘‡

```js
  app.router('detail', async (ctx,next)=>{
    let blogId = event.blogId
    // åšæ–‡è¯¦æƒ…æŸ¥è¯¢
    let detail = await blogCollection.where({
      _id: blogId
    }).get().then(res=>{
      return res.data
    })

    // è¯„è®ºæŸ¥è¯¢
    const countResult = await blogCommentCollection.count()
    const total = countResult.total   // è¯„è®ºæ€»æ¡æ•°
    let commentList = {
      data: []
    }
    if(total>0){ // å¦‚æœåˆtotal>0ï¼Œè¯´æ˜æœ‰è¯„è®ºï¼Œè¦è¿›è¡ŒæŸ¥è¯¢
      // æ‰€æœ‰è¯„è®ºæ€»æ•° / æœ€å¤§æŸ¥è¯¢é‡ ç„¶åå‘ä¸Šå–æ•´ï¼Œå³ä¸ºè¦æŸ¥è¯¢æ‰€æœ‰è¯„è®ºè¦è¿›è¡Œçš„æ¬¡æ•°
      const batchTimes = Math.ceil(total/MAX_LIMIT) 
      const tasks = []
      for(let i = 0; i<batchTimes; i++){
        let promise = blogCommentCollection.skip(i * MAX_LIMIT)
                      .limit(MAX_LIMIT).where({
                        blogId: blogId
                      }).orderBy('createTime','desc')
                      .get()
        tasks.push(promise)  
      } 
      if(tasks.length>0){
        commentList = (await Promise.all(tasks)).reduce((acc,cur)=>{
          return {
            data: acc.data.concat(cur.data)
          }
        })
      }
    }

    ctx.body={
      commentList,
      detail
    }

  })
```

è¿™é‡Œç”¨åˆ°äº†promise.allã€‚

ç„¶åblog-comment.jsä¸­è°ƒç”¨è¯¥äº‘å‡½æ•°ï¼š

```js
  onLoad: function (options) {
    console.log(options)
    this._getBlogDetail(options.blogId)
  },

  _getBlogDetail(blogId){
    wx.showLoading({
      title: 'åŠ è½½ä¸­',
      mask: true
    })

    wx.cloud.callFunction({
      name: 'blog',
      data:{
        $url: 'detail',
        blogId: this.data.blogId
      }
    }).then(res=>{
      wx.hideLoading()
      console.log(res)
       this.setData({
        blog: res.result.detail[0],
        commentList: res.result.commentList.data
      })
    })
  },
```

è¿™æ—¶æ‹¿åˆ°çš„æ•°æ®ï¼Œé‡Œé¢çš„æ—¶é—´æ ¼å¼ä¸å¯¹ï¼Œéœ€è¦è¿›è¡Œæ ¼å¼åŒ–å¤„ç†ã€‚

ä¹‹å‰å°è£…è¿‡ä¸€ä¸ªæ ¼å¼åŒ–æ—¶é—´çš„å·¥å…·/miniprogram/utils/formatTime.js ï¼Œå¼•ç”¨è¿™ä¸ªå·¥å…·è¿›è¡Œæ•°æ®çš„æ ¼å¼åŒ–å¤„ç†ï¼š

![](https://pic2.zhimg.com/v2-d6fddc5afa7c1fdc6b36d24a18fef921_r.jpg)

#### é¡µé¢æ¸²æŸ“

```html
<!--pages/blog-comment/blog-comment.wxml-->
<scroll-view scroll-y="true" class="container">
  <view class="blog-card">
    <blog-card blog="{{blog}}" />
  </view>

  <!-- è¯„è®ºç‚¹èµtab -->
  <view class="tab">
    <view class="tab-item">è¯„è®ºåˆ—è¡¨</view>
  </view>

  <!-- è¯„è®ºå†…å®¹åˆ—è¡¨ -->
  <view class="comment-list">
    <!-- è¯„è®º -->
    <block wx:for="{{commentList}}" wx:key="_id">
      <view class="comment">
        <view class="comment-title">
          <image class="comment-portrait" src="{{item.avatarUrl}}"></image>
          <text class="comment-nickname">{{item.nickName}}</text>
        </view>
        <view class="comment-content">
        {{item.content}}
        </view>
        <view class="comment-time">{{item.createTime}}</view>
      </view>
    </block>
  </view>
</scroll-view>

<view class="blog-ctrl">
  <blog-ctrl blogId="{{blog._id}}" 
             iconfont="iconfont" 
             icon-pinglun="icon-pinglun" 
             icon-fenxiang="icon-fenxiang" 
             bind:refreshCommentList="_getBlogDetail" />
</view>
```



åœ¨æ­£æ–‡é¡µä¹Ÿæ˜¯å¯ä»¥è¿›è¡Œè¯„è®ºçš„ï¼Œè¯„è®ºå‘é€åï¼Œåº”è¯¥é‡æ–°åˆ·æ–°å½“å‰é¡µï¼Œè¿™ä¸ªåŠ¨ä½œè¦å¦‚æœè§¦å‘å‘¢ï¼Ÿ

ä¿®æ”¹blog-ctrl.jsä¸­çš„onSendå‡½æ•°ï¼Œåœ¨è¯„è®ºæ•°æ®å‘å¸ƒæˆåŠŸåï¼Œå‘çˆ¶çº§ç»„ä»¶è°ƒç”¨è€…å‘èµ·ä¸€ä¸ªäº‹ä»¶ï¼Œ

```js
// çˆ¶çº§åˆ·æ–°è¯„è®ºé¡µé¢
this.triggerEvent('refreshCommentList')
```

ç„¶ååˆblog-commentè¿›è¡Œåˆ·æ–°åŠ¨ä½œï¼š

```html
<view class="blog-ctrl">
  <blog-ctrl blogId="{{blog._id}}" 
             iconfont="iconfont" 
             icon-pinglun="icon-pinglun" 
             icon-fenxiang="icon-fenxiang"
             bind:refreshCommentList="_getBlogDetail" />
```



#### åšæ–‡åˆ†äº«åŠŸèƒ½

æˆ‘ä»¬è¦ç‚¹å‡»åˆ†äº«æŒ‰é’®ï¼Œç„¶åå°†åšæ–‡åˆ†äº«å‡ºå»ã€‚å›æ¥çœ‹blog-ctrlé‡Œçš„è¿™éƒ¨åˆ†ä»£ç ï¼š

```html
   <i class="iconfont icon-fenxiang icon"></i>
    <text>åˆ†äº«</text>
```

å°ç¨‹åºè§„å®šï¼Œè¦æƒ³[è½¬å‘åˆ†äº«](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/share.html#%E4%BD%BF%E7%94%A8%E6%8C%87%E5%BC%95)ï¼Œå¿…é¡»ä½¿ç”¨buttonæ ‡ç­¾ï¼Œæ‰€ä»¥è¿™é‡Œè¦ä¿®æ”¹ã€‚

```html
    <button open-type="share" size="mini" class="share-btn">
      <i class="iconfont icon-fenxiang icon"></i>
      <text>åˆ†äº«</text>
    </button>
```

é€šè¿‡ç»™ `button` ç»„ä»¶è®¾ç½®å±æ€§ `open-type="share"`ï¼Œå¯ä»¥åœ¨ç”¨æˆ·ç‚¹å‡»æŒ‰é’®åè§¦å‘ [`Page.onShareAppMessage`](https://developers.weixin.qq.com/miniprogram/dev/reference/api/Page.html#onshareappmessageobject-object) äº‹ä»¶ã€‚



çŸ¥é“æ€ä¹ˆè§¦å‘è½¬å‘åˆ†äº«äº‹ä»¶äº†ï¼Œä¸‹ä¸€æ­¥å°±æ˜¯è¦æŠŠæœ‰ç”¨çš„æ•°æ®ä¼ è¿›å»ã€‚æ•°æ®åŒ…æ‹¬blogIdå’Œblog itemè‡ªèº«

æ‰€ä»¥åœ¨ä½¿ç”¨blog-ctrlç»„ä»¶çš„æ—¶å€™ï¼Œå°±æŠŠè¿™ä¸¤æ•°æ®ä¼ å…¥ï¼š

![](https://pic3.zhimg.com/80/v2-d7bc4a56305c245d3f8295dc50079337_hd.png)

ç„¶åblog-ctrlç»„ä»¶æ¥æ”¶è¿™ä¸¤ä¸ªæ•°æ®ï¼Œå¹¶åœ¨è½¬å‘æŒ‰é’®å¤„ä½¿ç”¨ï¼š

```html
    <button open-type="share" 
            size="mini" class="share-btn"
            data-blogid="{{blogId}}" data-blog="{{blog}}">
      <i class="iconfont icon-fenxiang icon"></i>
      <text>åˆ†äº«</text>
    </button>
```

ç„¶åæ‰€åœ¨é¡µé¢å°±ä¼šè‡ªåŠ¨è§¦å‘onShareAppMessageï¼Œæ‰“å°ä¸€ä¸‹çœ‹çœ‹å‚æ•°æœ‰æ²¡æœ‰ä¼ åˆ°

```js
  /**
   * ç”¨æˆ·ç‚¹å‡»å³ä¸Šè§’åˆ†äº«
   */
  onShareAppMessage: function (event) {
    console.log(event)
  }
```

![](https://pic3.zhimg.com/v2-6cf02cc787fddd8adf44468aa537bd72_r.jpg)

æˆåŠŸè§¦å‘onShareAppMessageå¹¶è·å¾—å‚æ•°æ•°æ®ã€‚

ç¼–å†™onShareAppMessageğŸ‘‡

```js
   /*
   * ç”¨æˆ·ç‚¹å‡»å³ä¸Šè§’åˆ†äº«
   */
  onShareAppMessage: function (event) {
    console.log(event)
    let blogObj = event.target.dataset.blog
    return {
      title: blogObj.content,
      path: `/pages/blog-comment/blog-comment?blogId=${blogObj._id}`,
      imageUrl: blogObj.img[0] //ä¸å†™çš„è¯é»˜è®¤æˆªå›¾è¯¥é¡µé¢80%ï¼Œ imageUrlæ”¯æŒhttpå›¾ç‰‡é“¾æ¥å’Œäº‘æ–‡ä»¶IDï¼ˆäº‘æ–‡ä»¶ID 2019.07æ–°å¢åŠŸèƒ½ï¼‰
    }
  }
```

<img src="https://pic4.zhimg.com/80/v2-99140aeddb475144d20b8f9afe3773fa_hd.png" style="width:300px" />

 

## 7.ã€æˆ‘çš„ã€‘åŠŸèƒ½å®ç°

```
- å¯¹æ¯”ä¸åŒæ–¹å¼è·å–ç”¨æˆ·ä¿¡æ¯çš„åº”ç”¨åœºæ™¯
- æœ¬åœ°å­˜å‚¨æ’­æ”¾å†å²
- äº‘å‡½æ•°è°ƒç”¨äº‘æ•°æ®åº“ä¸å°ç¨‹åºè°ƒç”¨äº‘æ•°æ®åº“çš„å·®åˆ«
- äº‘è°ƒç”¨ç”Ÿæˆå°ç¨‹åºç 
```





### ã€é‡è¦ã€‘å¯¹æ¯”ä¸åŒæ–¹å¼è·å–ç”¨æˆ·ä¿¡æ¯çš„åº”ç”¨åœºæ™¯

#### open-data

<https://developers.weixin.qq.com/miniprogram/dev/component/open-data.html>

![](https://pic1.zhimg.com/80/v2-ffbfcdcdbc2d215247aa7995dc08905f_hd.png)

open-data**ä¸éœ€è¦ç”¨æˆ·è¿›è¡Œæˆæƒ**ï¼Œç›´æ¥å°±å¯ä»¥æ˜¾ç¤ºå‡ºæ¥ï¼Œä½†æ˜¯åªèƒ½åœ¨wxmlä¸­è·å–å¾—åˆ°ï¼Œä¹Ÿåªèƒ½åœ¨ç•Œé¢ä¸Šæ˜¾ç¤ºï¼Œæ— æ³•è¿›è¡Œjsçº§åˆ«çš„æ“ä½œã€‚ 



#### wx.getUserInfo()

<https://developers.weixin.qq.com/miniprogram/dev/api/open-api/user-info/wx.getUserInfo.html>

è°ƒç”¨å‰éœ€è¦ [ç”¨æˆ·æˆæƒ](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/authorize.html) scope.userInfoã€‚å…ˆé€šè¿‡wx.getSetting()æŸ¥çœ‹ç”¨æˆ·æ˜¯å¦å·²æˆæƒã€‚

åªæœ‰åœ¨è·å¾—ç”¨æˆ·æˆæƒåæ‰èƒ½æ­£å¸¸ä½¿ç”¨wx.getUserInfo()

```
    wx.getSetting({
      success: res=>{
        console.log(res)

        if(res.authSetting['scope.userInfo']){
          // åªæœ‰åœ¨è·å¾—ç”¨æˆ·æˆæƒåæ‰èƒ½æ­£å¸¸ä½¿ç”¨wx.getUserInfo()
          wx.getUserInfo({
            success: (res) => {
              console.log(res)
            }
          })
        }

      }
    })
```

![](https://pic4.zhimg.com/v2-08a75c3d6c31c93bd49500dced359477_r.jpg)



#### buttonè§¦å‘æˆæƒ

```html
<button open-type="getUserInfo" bindgetuserinfo="onGotUserInfo">
  ç‚¹å‡»æˆæƒ
</button>
```

```js
  onGotUserInfo(event){
    console.log(event)  //å¾—åˆ°æˆæƒä¿¡æ¯
  },
```

![](https://pic2.zhimg.com/80/v2-c3e214959de03cd23cb11e8adfd8c846_hd.png)





#### openidè·å–

ä»¥ä¸Šçš„æ–¹å¼éƒ½æ— æ³•è·å–åˆ°openid

ä¼ ç»Ÿçš„è·å–æ–¹æ³•å¦‚ä¸‹ï¼š

![](https://pic2.zhimg.com/v2-14a762771b6882073d72917ee56edb51_r.jpg)

codeçš„æœ‰æ•ˆæœŸåªæœ‰äº”åˆ†é’Ÿã€‚

éœ€è¦å‰åç«¯åä½œï¼Œæ¯”è¾ƒéº»çƒ¦ã€‚



äº‘å¼€å‘è·å–openidæ–¹å¼å¦‚ä¸‹ï¼š

![](https://pic2.zhimg.com/v2-5f63f30964fb19da3448326d40c7307d_r.jpg)



```js
  getOpenid(){
    wx.cloud.callFunction({
      name: 'login',
    }).then(res=>{
      console.log(res)
    })
  },
```

å¾—åˆ°çš„resä¸­å°±åŒ…å«æˆ‘ä»¬æƒ³è¦çš„appidå’Œopenidã€‚

è¿™é‡Œè°ƒç”¨äº†äº‘å‡½æ•°ä¸­çš„loginï¼Œè¿™ä¸ªloginäº‘å‡½æ•°æ˜¯ç³»ç»Ÿè‡ªå¸¦çš„ï¼Œè¦ç”¨ä¹‹å‰è®°å¾—å…ˆå°†å…¶ä¸Šä¼ å¹¶éƒ¨ç½²åˆ°äº‘ç«¯ã€‚



### â€œæˆ‘çš„â€é¡µé¢å®ç°

æ›´æ–°å›¾æ ‡ï¼Œå’Œå‰é¢çš„ä¸€æ ·ï¼Œä¸èµ˜è¿°ã€‚

htmlç»“æ„ğŸ‘‡

```html
<view class="profile-header">
  <view class="avatar-url">
    <open-data type="userAvatarUrl"></open-data>
  </view>
  <open-data type="userNickName" class="nickname"></open-data>
</view>

<view class="nav">
  <view class="nav-item">
    <navigator class="content" url="/pages/profile-playhistory/profile-playhistory" hover-class="none">
      <i class="iconfont icon-jilu"></i>
      <text class="text">æœ€è¿‘æ’­æ”¾</text>
      <i class="iconfont icon-changyongtubiao-xianxingdaochu-zhuanqu-"></i>
    </navigator>
  </view>
  <view class="nav-item">
    <navigator class="content" url="/pages/profile-bloghistory/profile-bloghistory" hover-class="none">
      <i class="iconfont icon-fabu2"></i>
      <text class="text">æˆ‘çš„ä¹è¯„</text>
      <i class="iconfont icon-changyongtubiao-xianxingdaochu-zhuanqu-"></i>
    </navigator>
  </view>
  <view class="nav-item">
    <navigator class="content">
      <i class="iconfont icon-erweima"></i>
      <text class="text">å°ç¨‹åºç </text>
      <i class="iconfont icon-changyongtubiao-xianxingdaochu-zhuanqu-"></i>
    </navigator>
  </view>
</view>
```

è¿™é‡Œé¡µé¢è·³è½¬æ²¡æœ‰ç”¨ä»¥å¾€ç»‘å®šäº‹ä»¶js navigateToçš„æ–¹æ³•ï¼Œè€Œæ˜¯ç”¨äº†ä¸€ä¸ªæ–°æ ‡ç­¾`navigator`ï¼Œè¯¥æ ‡ç­¾çš„urlå±æ€§å¡«ä¸Šç›®æ ‡é¡µé¢çš„urlå³å¯è·³è½¬ã€‚æ³¨æ„åŠ ä¸Š`hover-class="none"`ï¼Œè¿™æ ·å¯ä»¥æ¶ˆé™¤ç‚¹å‡»æ—¶äº§ç”Ÿçš„é˜´å½±ã€‚



åœ¨app.jsonä¸­è¿›è¡Œæ–°é¡µé¢çš„é…ç½®ï¼Œæ–°å¢ä¸¤ä¸ªæ–°é¡µé¢ï¼š

```
  "pages": [
    "pages/playlist/playlist",
    "pages/blog/blog",
    "pages/profile/profile",
    "pages/demo/demo",
    "pages/musiclist/musiclist",
    "pages/player/player",
    "pages/blog-edit/blog-edit",
    "pages/blog-comment/blog-comment",
    "pages/profile-playhistory/profile-playhistory",
    "pages/profile-bloghistory/profile-bloghistory"
  ],
```



æ ·å¼çš„å¤„ç†ä¸­ï¼Œæˆ‘è¦ç”¨åˆ°èƒŒæ™¯å›¾ï¼Œä½†æ˜¯å°ç¨‹åºä¸­èƒŒæ™¯ä¸èƒ½ç”¨æœ¬åœ°å›¾ç‰‡ï¼Œè€Œè¦ä½¿ç”¨httpsé“¾æ¥å›¾ç‰‡æˆ–è€…base64æ ¼å¼å›¾ç‰‡ã€‚ä½¿ç”¨base64çš„è¯æ¯”èµ·httpsé“¾æ¥å›¾ç‰‡ï¼Œä¸ç”¨å»å¤šåšç½‘ç»œè¯·æ±‚ï¼Œæ€§èƒ½è¾ƒå·ï¼Œä½†æ˜¯base64å›¾ç‰‡ä¸å®œè¿‡å¤§ã€‚



### æ’­æ”¾å†å²æœ¬åœ°å­˜å‚¨å®ç°

æ’­æ”¾å†å²çš„ä¿¡æ¯å­˜å‚¨ä¸€èˆ¬æœ‰ä¸¤ç§æ–¹æ³•ï¼Œä¸€ç§æ˜¯å°†æ’­æ”¾å†å²ä¿¡æ¯å­˜å…¥æ•°æ®åº“ä¸­ï¼Œå¦ä¸€ç§æ˜¯ä½¿ç”¨æœ¬åœ°å­˜å‚¨ã€‚è¿™é‡Œæˆ‘é‡‡ç”¨å°ç¨‹åºæœ¬åœ°ç¼“å­˜å®ç°ã€‚

ç¼“å­˜çš„keyå€¼ä½¿ç”¨openidï¼Œè¿™æ ·å¯ä»¥å”¯ä¸€æ ‡è¯†ç”¨æˆ·ã€‚

app.jsçš„onLaunchåœ¨å°ç¨‹åºä¸€å¼€å§‹å°±ä¼šæ‰§è¡Œï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œè·å¾—openidï¼š

```js
//app.js
App({
  onLaunch: function () {
    
    if (!wx.cloud) {
      console.error('è¯·ä½¿ç”¨ 2.2.3 æˆ–ä»¥ä¸Šçš„åŸºç¡€åº“ä»¥ä½¿ç”¨äº‘èƒ½åŠ›')
    } else {
      wx.cloud.init({
        // env å‚æ•°è¯´æ˜ï¼š
        //   env å‚æ•°å†³å®šæ¥ä¸‹æ¥å°ç¨‹åºå‘èµ·çš„äº‘å¼€å‘è°ƒç”¨ï¼ˆwx.cloud.xxxï¼‰ä¼šé»˜è®¤è¯·æ±‚åˆ°å“ªä¸ªäº‘ç¯å¢ƒçš„èµ„æº
        //   æ­¤å¤„è¯·å¡«å…¥ç¯å¢ƒ ID, ç¯å¢ƒ ID å¯æ‰“å¼€äº‘æ§åˆ¶å°æŸ¥çœ‹
        //   å¦‚ä¸å¡«åˆ™ä½¿ç”¨é»˜è®¤ç¯å¢ƒï¼ˆç¬¬ä¸€ä¸ªåˆ›å»ºçš„ç¯å¢ƒï¼‰
        env: 'dev-r049g',
        traceUser: true,  //è®°å½•å°ç¨‹åºçš„è®¿é—®è€…
      })
    }

    this.globalData = {
      playingMusicId: -1,
      openid: -1,  // æ­£å¸¸ç”¨æˆ·çš„openidä¸ä¼šæ˜¯-1ï¼Œè¿™é‡Œå ä½ç”¨äºå­˜å‚¨çœŸæ­£çš„openid
    }  
    this.getOpenid()
  },
  setPlayingMusicId(musicId){
    this.globalData.playingMusicId = musicId
  },
  getPlayingMusicId(){
    return this.globalData.playingMusicId
  },


  getOpenid(){
    console.log(123)
    wx.cloud.callFunction({
      name: 'login'
    }).then(res=>{
      this.globalData.openid = res.result.openid

      if (wx.getStorageSync(this.globalData.openid)==''){
        wx.setStorageSync(this.globalData.openid, []) // ä¸€å¼€å§‹å°±è·å¾—openidä½œä¸ºæœ¬åœ°ç¼“å­˜çš„keyï¼Œåˆå§‹æ—¶ç¼“å­˜ä¸ºç©ºæ•°ç»„
      }else{
        // å¦åˆ™ä»€ä¹ˆéƒ½ä¸åš
      }

    })
  },
})

```



åœ¨éŸ³ä¹æ’­æ”¾çš„jsæ–‡ä»¶player.jsä¸­ç¼–å†™savePlayHistory()å‡½æ•°ï¼š

```js
// ä¿å­˜æ’­æ”¾å†å²
savePlayHistory(){
  // å½“å‰æ­£åœ¨æ’­æ”¾çš„æ­Œæ›²
  const music = musiclist[nowPlayingIndex]
  const openid = app.globalData.openid  
  const history = wx.getStorageSync(openid)

  let exist = false // æ ‡å¿—å½“å‰æ­Œæ›²æ˜¯å¦å·²å­˜åœ¨äºhistoryä¸­ï¼Œæ˜¯çš„è¯ä¸å†é‡å¤è®°å½•
  for(let i = 0; i < history.length; i++){
    if( history[i].id == music.id ){
      exist = true
      break  // ä¸€æ—¦å‘ç°å­˜åœ¨å°±è·³å‡º
    }
  }
  if(!exist){
    history.unshift(music)  // æ•°ç»„å¤´éƒ¨æ’å…¥
    wx.setStorageSync(openid, history)
  }
},
```

åœ¨æ­Œæ›²æ’­æ”¾çš„æ—¶å€™è°ƒç”¨è¯¥å‡½æ•°ï¼š

```js
      if(!this.data.isSame){
        backgroundAudioManager.src = result.data[0].url  //æ­Œæ›²æº
        backgroundAudioManager.title = music.name //æ­Œæ›²å
        backgroundAudioManager.coverImgUrl = music.al.picUrl //æ­Œæ›²å°é¢
        backgroundAudioManager.singer = music.ar[0].name //æ­Œæ‰‹å
        backgroundAudioManager.epname = music.al.name //ä¸“è¾‘å

        // ä¿å­˜æ’­æ”¾å†å²
        this.savePlayHistory()
      }
```

è¿™æ ·å°±æˆåŠŸçš„å°†æ’­æ”¾è¿‡çš„æ¯é¦–æ­Œçš„å…·ä½“ä¿¡æ¯å­˜å…¥äº†ç¼“å­˜æ•°ç»„ä¸­ã€‚



### æ’­æ”¾å†å²é¡µé¢å®ç°

å…ˆè·å–æœ¬åœ°ç¼“å­˜æ•°æ®å¹¶ä¿å­˜ï¼š

```js
  onLoad: function (options) {
    
    const playHistory = wx.getStorageSync(app.globalData.openid)
    if(playHistory.length==0){
      wx.showModal({
        title: 'æ’­æ”¾å†å²ä¸ºç©º',
        content: '',
      })
    }else{
      this.setData({
        musiclist: playHistory
      })
    }
  },
```

ç„¶åè°ƒç”¨ä¹‹å‰å°è£…è¿‡çš„æ­Œæ›²åˆ—è¡¨ç»„ä»¶musiclistï¼Œå°†æ•°æ®ä¼ å…¥

```html
<musiclist-cmp musiclist="{{musiclist}}" />
```

çœ‹ä¸‹æ•ˆæœï¼Œèƒ½æ­£å¸¸æ˜¾ç¤ºï¼Œç‚¹å‡»æ­Œæ›²è¿˜èƒ½è¿›è¡Œæ’­æ”¾ï¼Œä¸€åˆ‡çœ‹èµ·æ¥å¾ˆæ£’çš„æ ·å­ğŸ‘‡

![](https://pic1.zhimg.com/80/v2-906445acff5286e599c38818a45991ad_hd.png)

ä½†æ˜¯ï¼Œå½“ç‚¹å‡»ä¸‹ä¸€é¦–æ’­æ”¾çš„æ—¶å€™ï¼Œæ˜¯æ’­æ”¾çš„æœ€åä¸€ä¸ªç‚¹å¼€çš„çš„æ­Œå•åˆ—è¡¨çš„ä¸‹ä¸€é¦–æ­Œï¼Œè€Œä¸æ˜¯å½“å‰æ’­æ”¾å†å²é‡Œçš„æ­Œã€‚è¿™ä¸ªbugæ˜¯å› ä¸ºç¼“å­˜ä¸­çš„æ­Œå•åˆ—è¡¨æ²¡æœ‰ä¿®æ”¹çš„åŸå› ï¼Œé‚£ä¹ˆæ”¹å®ƒğŸ‘‡

```js
  onLoad: function (options) {
    
    const playHistory = wx.getStorageSync(app.globalData.openid)
    if(playHistory.length==0){
      wx.showModal({
        title: 'æ’­æ”¾å†å²ä¸ºç©º',
        content: '',
      })
    }else{
      // storageé‡Œå­˜å‚¨çš„musiclistæ›¿æ¢æˆæ’­æ”¾å†å²çš„æ­Œå•
      wx.setStorage({
        key: 'musiclist',
        data: playHistory,
      })
      this.setData({
        musiclist: playHistory
      })
    }
  },
```

æå®šã€‚



### æˆ‘çš„ä¹è¯„å®ç°

äº‘å‡½æ•°blogï¼Œé€šè¿‡openidä»æ•°æ®åº“è·å–æ‰€æœ‰ä¹è¯„æ•°æ®ï¼š

```js
  const wxContext = cloud.getWxContext()
  app.router('getListByOpenid', async(ctx, next)=>{
    ctx.body = await blogCollection.where({
      _openid: wxContext.OPENID
    }).skip(event.start).limit(event.count)
    .orderBy('createTime', 'desc').get().then(res=>{
      return res.data
    })
  })
```



è°ƒç”¨äº‘å‡½æ•°ï¼š

```js
  onLoad: function (options) {
    this._getListByCloudFn()
  },

  _getListByCloudFn(){
    wx.showLoading({
      title: 'åŠ è½½ä¸­',
    })
    wx.cloud.callFunction({
      name: 'blog',
      data: {
        $url: 'getListByOpenid',
        start: this.data.blogList.length,
        count: 10
      }
    }).then(res=>{
      this.setData({
        blogList: this.data.blogList.concat(res.result) 
      })
      wx.hideLoading()
    })
  },
```



æ¥ä¸‹æ¥è¿›è¡Œé¡µé¢çš„å¸ƒå±€å’Œæ¸²æŸ“ï¼Œå¼•å…¥ä¹‹å‰å°è£…è¿‡çš„blog-cardç»„ä»¶å’Œblog-ctrlç»„ä»¶ï¼Œ

```html
<view>
  <block wx:for="{{blogList}}" wx:key="_id">
    <view class="blog-panel">
      <blog-card blog="{{item}}"
                 bindtap="goComment"
                 data-blogid="{{item._id}}"></blog-card>
      <blog-ctrl blogId="{{item._id}}"
                 blog="{{item}}"
                 iconfont="iconfont"
                 icon-pinglun="icon-pinglun"
                 icon-fenxiang="icon-fenxiang"></blog-ctrl>
    </view>
  
  </block>
</view>

```

jséƒ¨åˆ†ï¼š

```js
// pages/profile-bloghistory/profile-bloghistory.js
Page({

  /**
   * é¡µé¢çš„åˆå§‹æ•°æ®
   */
  data: {
    blogList: []
  },

  /**
   * ç”Ÿå‘½å‘¨æœŸå‡½æ•°--ç›‘å¬é¡µé¢åŠ è½½
   */
  onLoad: function (options) {
    this._getListByCloudFn()
  },

  _getListByCloudFn(){
    wx.showLoading({
      title: 'åŠ è½½ä¸­',
    })
    wx.cloud.callFunction({
      name: 'blog',
      data: {
        $url: 'getListByOpenid',
        start: this.data.blogList.length,
        count: 10
      }
    }).then(res=>{
      this.setData({
        blogList: this.data.blogList.concat(res.result) 
      })
      wx.hideLoading()
    })
  },

  goComment(event) {
    console.log(event)
    wx.navigateTo({
      url: '../../pages/blog-comment/blog-comment?blogId=' + event.target.dataset.blogid,
    })
  },

  /**
   * ç”Ÿå‘½å‘¨æœŸå‡½æ•°--ç›‘å¬é¡µé¢åˆæ¬¡æ¸²æŸ“å®Œæˆ
   */
  onReady: function () {

  },

  /**
   * ç”Ÿå‘½å‘¨æœŸå‡½æ•°--ç›‘å¬é¡µé¢æ˜¾ç¤º
   */
  onShow: function () {

  },

  /**
   * ç”Ÿå‘½å‘¨æœŸå‡½æ•°--ç›‘å¬é¡µé¢éšè—
   */
  onHide: function () {

  },

  /**
   * ç”Ÿå‘½å‘¨æœŸå‡½æ•°--ç›‘å¬é¡µé¢å¸è½½
   */
  onUnload: function () {

  },

  /**
   * é¡µé¢ç›¸å…³äº‹ä»¶å¤„ç†å‡½æ•°--ç›‘å¬ç”¨æˆ·ä¸‹æ‹‰åŠ¨ä½œ
   */
  onPullDownRefresh: function () {
    this.setData({
      blogList: []
    })

    this._getListByCloudFn()
    wx.stopPullDownRefresh()
  },

  /**
   * é¡µé¢ä¸Šæ‹‰è§¦åº•äº‹ä»¶çš„å¤„ç†å‡½æ•°
   */
  onReachBottom: function () {
    this._getListByCloudFn()
  },

  /**
   * ç”¨æˆ·ç‚¹å‡»å³ä¸Šè§’åˆ†äº«
   */
  onShareAppMessage: function (event) {
    console.log(event)
    let blogObj = event.target.dataset.blog
    return {
      title: blogObj.content,
      path: `/pages/blog-comment/blog-comment?blogId=${blogObj._id}`,
      imageUrl: blogObj.img[0]
    }
  }
})
```

æå®šã€‚

### äº‘è°ƒç”¨ç”Ÿæˆå°ç¨‹åºç 

å®˜æ–¹æ–‡æ¡£ï¼š<https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/qr-code.html>

äº‘è°ƒç”¨ç”Ÿæˆå°ç¨‹åºç ï¼š<https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/qr-code/wxacode.getUnlimited.html#method-cloud>

å…ˆæ–°å»ºä¸€ä¸ªäº‘å‡½æ•°getQrCodeç”¨äºä¸“é—¨è´Ÿè´£èƒœåœºå°ç¨‹åºç ï¼Œå› ä¸ºè¦ä½¿ç”¨äº‘è°ƒç”¨ï¼Œå’Œä¹‹å‰ä½¿ç”¨è®¢é˜…æ¶ˆæ¯åŠŸèƒ½ä¸€æ ·ï¼Œéƒ½è¦åœ¨äº‘å‡½æ•°ä¸­æ–°å»ºå¤šä¸€ä¸ªé…ç½®æ–‡ä»¶`config.json`ï¼Œéœ€åœ¨ `config.json` ä¸­é…ç½®  `wxacode.getUnlimited` API çš„æƒé™ï¼š

```json
{
  "permissions": {
    "openapi": [
      "wxacode.getUnlimited"
    ]
  }
}
```



```js
// äº‘å‡½æ•°å…¥å£æ–‡ä»¶
const cloud = require('wx-server-sdk')

cloud.init()

// äº‘å‡½æ•°å…¥å£å‡½æ•°
exports.main = async (event, context) => {
  const wxContext = cloud.getWXContext()

  const result = await cloud.openapi.wxacode.getUnlimited({
    scene: wxContext.OPENID  //è¿™äº‘å‡½æ•°é‡Œå‚æ•°æœ€åä¸€é¡¹è¿˜ä¸èƒ½æœ‰é€—å·ï¼Œæˆ‘è¸©è¿‡è¿™ç§å‘ã€‚
  })
  // console.log(result) 
  const upload = await cloud.uploadFile({
    cloudPath: 'qrcode/' + Date.now() + '_' + Math.random() + '.png',
    fileContent: result.buffer
  })

  return upload.fileID
}
```

cloud.openapi.wxacode.getUnlimited()è°ƒç”¨äº§ç”Ÿçš„ç»“æœä¸­çš„bufferæ˜¯æˆ‘ä»¬æƒ³è¦çš„å°ç¨‹åºç èµ„æºï¼Œä½†æ˜¯æ˜¯bufferæ ¼å¼ï¼Œæ— æ³•ç›´æ¥ä½¿ç”¨ï¼Œæ‰€ä»¥å°†å…¶ä»¥å›¾ç‰‡pngæ ¼å¼å­˜è¿›äº‘å­˜å‚¨ä¸­ï¼Œç”Ÿæˆå¯¹åº”çš„file IDï¼Œè¿™æ ·å°±å¯ä»¥è¯†åˆ«ä¸ºå›¾ç‰‡äº†ã€‚

```js
  onTapQrCode(){
    wx.showLoading({
      title: 'ç”Ÿæˆä¸­',
    })
    wx.cloud.callFunction({
      name: 'getQrCode'
    }).then(res=>{
      console.log(res)
      const fileId = res.result
      wx.previewImage({
        urls: [fileId],
        current: fileId
      })

      wx.hideLoading()
    })
  },
```

é€šè¿‡ä¸€ä¸ªé¢„è§ˆå›¾ç‰‡çš„åŠŸèƒ½æ˜¾ç¤ºå°ç¨‹åºç ã€‚

![](https://pic1.zhimg.com/v2-bac9efed9a3b6820439c8ccd87329c6c_b.webp)

## 8.å°ç¨‹åºé«˜çº§çŸ¥è¯†

```
- å°ç¨‹åºæ¸²æŸ“å±‚ä¸é€»è¾‘å±‚äº¤äº’åŸç†
- å°ç¨‹åºè¿è¡Œæœºåˆ¶ä¸æ›´æ–°æœºåˆ¶
- å°ç¨‹åºæ€§èƒ½ä¸ä½“éªŒä¼˜åŒ–
- å°ç¨‹åºä¸Šçº¿å®¡æ ¸æµç¨‹
- å°ç¨‹åºåœºæ™¯å€¼çš„åº”ç”¨
```

### å°ç¨‹åºæ¸²æŸ“å±‚å’Œé€»è¾‘å±‚çš„åŸç†

![](https://pic4.zhimg.com/v2-1f7f0cc4206ee5619409c8aacaa047af_r.jpg)

æ¸²æŸ“å±‚å³å¤„ç†é¡µé¢æ˜¾ç¤ºçš„ï¼Œå¯¹åº”çš„æ˜¯HTMLå’ŒCSSï¼›é€»è¾‘å±‚æ˜¯å¤„ç†é¡µé¢JSé€»è¾‘çš„ã€‚ç½‘é¡µç¨‹åºçš„æ¸²æŸ“å±‚å’Œé€»è¾‘å±‚æ˜¯äº’æ–¥çš„ï¼Œæ¸²æŸ“å¼•æ“å’ŒJSå¼•æ“éƒ½åœ¨ä¸€ä¸ªå•çº¿ç¨‹é‡Œã€‚å½“æ¸²æŸ“å¼•æ“æ­£åœ¨å·¥ä½œæ¸²æŸ“é¡µé¢çš„æ—¶å€™ï¼ŒJSè„šæœ¬æ˜¯ä¸ä¼šæ‰§è¡Œçš„ï¼Œè€Œå½“è„šæœ¬æ‰§è¡Œçš„æ—¶å€™é¡µåŒæ ·ä¸ä¼šæ¸²æŸ“ç•Œé¢ã€‚æ‰€ä»¥å½“JSè„šæœ¬è¦è¿›è¡Œå¤§é‡çš„è®¡ç®—çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šä½¿å¾—é¡µé¢å¤±å»å“åº”ã€‚ä½†æ˜¯åœ¨**å°ç¨‹åºä¸­ï¼Œæ¸²æŸ“å±‚å’Œé€»è¾‘å±‚æ˜¯åˆ†å¼€çš„ï¼Œå®ƒä»¬åˆ†åˆ«è¿è¡Œåœ¨ä¸åŒçš„çº¿ç¨‹å½“ä¸­ã€‚**

![](https://pic1.zhimg.com/v2-9c93be298bbfc9b0b8377e172fc94b6c_r.jpg)



å°ç¨‹åºæœ¬è´¨ä¸Šä¹Ÿæ˜¯ä¸€ä¸ªHybridç¨‹åºã€‚

![](https://pic4.zhimg.com/v2-d8394edf0838de302b86626afb443ce7_b.png)

Nativeç³»ç»Ÿå±‚å†…æœ‰ä¸€ä¸ªJSBridgeï¼Œé€šè¿‡ä»–å¯ä»¥å®ç°å¯¹åº•å±‚APIæ¥å£çš„è°ƒç”¨ï¼Œå¦‚å¾®ä¿¡çš„å®šä½ã€æ‰«ç ã€ç¦»çº¿å­˜å‚¨ã€ç½‘ç»œè¯·æ±‚ã€å¾®ä¿¡æ­¥æ•°ç­‰ç­‰ã€‚è€Œå°ç¨‹åºæ¸²æŸ“å±‚å’Œé€»è¾‘å±‚çš„äº¤äº’ï¼Œä¸æ˜¯ç›´æ¥äº¤äº’çš„ï¼Œè€Œæ˜¯é€šè¿‡ä¸€ä¸ªä¸­é—´å±‚Nativeç³»ç»Ÿå±‚æ¥å®ç°çš„ã€‚

æ‰€ä»¥å°ç¨‹åºæœ€å¥½ä¸è¦è¿›è¡Œé¢‘ç¹çš„setData()ï¼Œå› ä¸ºè¿™ä¼šé¢‘ç¹çš„è§¦å‘æ¸²æŸ“å±‚ã€ç³»ç»Ÿå±‚ã€é€»è¾‘å±‚ä¹‹é—´çš„æ•°æ®ä¼ é€’ï¼Œå¯¹æ€§èƒ½æ˜¯ä¸ªå¾ˆä¸å¥½çš„å½±å“ã€‚å¦å¤–ï¼Œé‚£äº›ä¸éœ€è¦æ˜¾ç¤ºåœ¨é¡µé¢ä¸­çš„æ•°æ®ä¸è¦æ”¾åœ¨dataä¸­ï¼Œè€Œæ˜¯ç”¨å˜é‡å­˜å‚¨å³å¯ï¼Œå¦‚æœè¿™ç§ä¸éœ€è¦è¦æ˜¾ç¤ºåœ¨é¡µé¢çš„æ•°æ®éƒ½æ”¾åœ¨dataä¸­ï¼Œé‚£ä¹ˆä¿®æ”¹å®ƒçš„æ—¶å€™åˆè¦è¿›è¡Œæ— è°“çš„setDataæ“ä½œï¼Œæ²¡å¿…è¦ï¼Œå¾ˆæ¶ˆè€—èµ„æºã€‚



### å°ç¨‹åºçš„è¿è¡Œæœºåˆ¶

- å†·å¯åŠ¨ï¼šä¹‹å‰æ²¡æ‰“å¼€è¿‡è¯¥å°ç¨‹åºï¼Œè¿™æ—¶æ‰“å¼€çš„è¯å°±å«å†·å¯åŠ¨ã€‚å¦å¤–ï¼Œè¯¥å°ç¨‹åºæœ‰å¯åŠ¨è¿‡ï¼Œä½†æ˜¯è¢«äººä¸ºä¸»åŠ¨é”€æ¯äº†ï¼Œå†    æ‰“å¼€ä¹Ÿæ˜¯å†·å¯åŠ¨ã€‚
- çƒ­å¯åŠ¨ï¼šä¹‹å‰æ‰“å¼€è¿‡å°ç¨‹åºï¼Œåœ¨ä¸€å®šæ—¶é—´å†…(ä¸€èˆ¬æ˜¯äº”åˆ†é’Ÿ)å†æ¬¡æ‰“å¼€ï¼Œå°±æ˜¯çƒ­å¯åŠ¨ã€‚
- å‰å°å’Œåå°ï¼šå‰å°å°±æ˜¯å°ç¨‹åºæ˜¾ç¤ºç€å°±æ˜¯å‰å°çš„çŠ¶æ€ï¼Œå½“æ‰‹æœºæŒ‰homeé”®æˆ–è€…æŒ‰å°ç¨‹åºå³ä¸Šè§’å…³é—­æŒ‰é’®çš„æ—¶å€™ï¼Œå°ç¨‹åºå°±åˆ‡æ¢åˆ°åå°äº†ã€‚å¾®ä¿¡å¼€å‘è€…å·¥å…·é‡Œä¹Ÿæœ‰â€œåˆ‡åå°â€ã€â€œåˆ‡å‰å°â€çš„åŠŸèƒ½ã€‚
- å°ç¨‹åºé”€æ¯ï¼šå°ç¨‹åºè¢«åˆ‡åå°ä¹‹åå¹¶æ²¡æœ‰ç«‹å³é”€æ¯ï¼Œä¸€èˆ¬ä¼šè¿è¡Œä¸€æ®µæ—¶é—´(ä¸€èˆ¬æ˜¯äº”åˆ†é’Ÿ)ä¹‹åæ‰çœŸæ­£é”€æ¯ã€‚å¯ä»¥äººå·¥é”€æ¯ã€‚



### å°ç¨‹åºçš„æ›´æ–°æœºåˆ¶

åœ¨app.jsä¸­è¿›è¡Œå°ç¨‹åºæ›´æ–°æ“ä½œï¼Œåœ¨æ¯æ¬¡onLaunchçš„æ—¶å€™å°±æ‰§è¡Œä¸‹åˆ—å‡½æ•°ï¼š

```js
  checkUpdate(){
    const updateManager = wx.getUpdateManager()
    // æ£€æµ‹ç‰ˆæœ¬æ›´æ–°
    updateManager.onCheckForUpdate(res=>{
      if(res.hasUpdate){
        updateManager.onUpdateReady(()=>{
          wx.showModal({
            title: 'æ›´æ–°æç¤º',
            content: 'å½“å‰æœ‰æ–°ç‰ˆæœ¬ï¼Œæ˜¯å¦é‡å¯',
            success(res){
              if(res.confirm){
                updateManager.applyUpdate()
              }
            }
          })
        })
      }
    })
  },
```

å¯ä»¥åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­è¿›è¡Œæ¨¡æ‹ŸğŸ‘‡

![](https://pic2.zhimg.com/v2-46c1ad769fb4072a6f9eea402584d7d5_r.jpg)



![](https://pic1.zhimg.com/80/v2-c610b71649f66c6eb855d8b0495d25a4_hd.jpg)



### å°ç¨‹åºæ€§èƒ½ä¸ä½“éªŒä¼˜åŒ–

- åˆç†è®¾ç½®å¯ç‚¹å‡»å…ƒç´ çš„å“åº”åŒºåŸŸçš„å¤§å°ï¼Œå¸¸è§çš„æ‰©å¤§æ–¹æ³•æ˜¯è®¾ç½®padding
- é¿å…æ¸²æŸ“é¡µé¢è€—æ—¶è¿‡é•¿
- é¿å…æ‰§è¡Œè„šæœ¬çš„æ—¶é—´è¿‡é•¿ï¼Œæ£€æŸ¥è„šæœ¬çš„é€»è¾‘æ˜¯å¦æœ‰é—®é¢˜ï¼Œè¿›è¡Œä¼˜åŒ–
- å¯¹ç½‘ç»œçš„è¯·æ±‚åšå¿…è¦çš„ç¼“å­˜ä»¥é¿å…å¤šä½™çš„è¯·æ±‚
- ä¸è¦å¼•ç”¨æœªè¢«ä½¿ç”¨çš„wxssæ ·å¼ï¼Œå‡å°‘ç¨‹åºåŒ…å¤§å°
- æ‰€æœ‰èµ„æºè¯·æ±‚å»ºè®®éƒ½ä½¿ç”¨HTTPSï¼Œæ¯”èµ·æ˜æ–‡ä¼ è¾“çš„HTTPæ›´åŠ å®‰å…¨
- ä¸ä½¿ç”¨åºŸå¼ƒæ¥å£
- é¿å…è¿‡å¤§çš„WXMLèŠ‚ç‚¹æ•°ç›®ï¼š
  - ä¸€ä¸ªé¡µé¢å°‘äº1000ä¸ªWXMLèŠ‚ç‚¹
  - èŠ‚ç‚¹æ ‘æ·±åº¦å°‘äº30å±‚
  - å­èŠ‚ç‚¹æ ‘ä¸å¤§äº60ä¸ª
- åŠæ—¶å›æ”¶å®šæ—¶å™¨
- é¿å…ä½¿ç”¨`:active`ä¼ªç±»æ¥å®ç°ç‚¹å‡»æ€ï¼Œæ”¹ç”¨`hover-class`
-  æ»šåŠ¨åŒºåŸŸå¯å¼€å¯æƒ¯æ€§æ»šåŠ¨ä»¥ä¼˜åŒ–ç”¨æˆ·ä½“éªŒ
  - å®‰å“æœºè‡ªå¸¦æƒ¯æ€§æ»šåŠ¨æ•ˆæœ
  - IOSï¼šè¦æ‰‹åŠ¨è®¾ç½® -webkit-overflow-scrolling:touch çš„æ ·å¼
- æ‰€æœ‰è¯·æ±‚çš„è€—æ—¶ä¸åº”å¤ªä¹…ï¼Œå¦å¤–åŠ ä¸Šshowloadingçš„æ•ˆæœ
- é¿å…çŸ­æ—¶é—´å†…å‘èµ·å¤ªå¤šå›¾ç‰‡è¯·æ±‚ï¼Œå°å›¾æ ‡ä¸è¦ç”¨å›¾ç‰‡ï¼Œç”¨iconfontç­‰å­—ä½“å›¾æ ‡
- é¿å…åœ¨çŸ­æ—¶é—´å†…å‘èµ·å¤ªå¤šè¯·æ±‚
- setData
  - setDataæ•°æ®ä¸å®œè¿‡å¤§ï¼Œæœ€å¤§1Mã€‚å¤ªå¤§çš„è¯æ¸²æŸ“å±‚ã€é€»è¾‘å±‚ã€ç³»ç»Ÿå±‚é—´çš„äº¤äº’è´Ÿæ‹…é‡ 
  - é¿å…é¢‘ç¹çš„è°ƒç”¨setData
  - ä¸ç”¨äºç»‘å®šæ˜¾ç¤ºåœ¨wxmlä¸Šçš„æ•°æ®ä¸è¦å­˜äºdataï¼Œä»è€Œä¸ç”¨è°ƒç”¨setData



#### æ€§èƒ½è¯„åˆ†

ç‚¹å¼€å¾®ä¿¡å¼€å‘è€…å·¥å…·è°ƒè¯•å™¨é‡Œæœ‰Auditsï¼Œç„¶åæ‰‹åŠ¨ç‚¹å‡»å„ä¸ªé¡µé¢ï¼Œä¼šè‡ªåŠ¨è¿›è¡Œè¯„åˆ†ã€‚

![](https://pic2.zhimg.com/v2-03e2cf0f649eaca45b8625aeb8f7d385_b.png)



### è¯¦è§£setDataå·¥ä½œåŸç†

#### å¼‚æ­¥ä¸åŒæ­¥

å®˜ç½‘æ–‡æ¡£ï¼š<https://developers.weixin.qq.com/miniprogram/dev/reference/api/Page.html#Page.prototype.setData(Object%20data,%20Function%20callback)>

`setData` å‡½æ•°ç”¨äºå°†æ•°æ®ä»é€»è¾‘å±‚å‘é€åˆ°è§†å›¾å±‚ï¼ˆå¼‚æ­¥ï¼‰ï¼ŒåŒæ—¶æ”¹å˜å¯¹åº”çš„ `this.data` çš„å€¼ï¼ˆåŒæ­¥ï¼‰ã€‚è¿™å¥è¯å¾—ç†è§£ä¸€ä¸‹ã€‚

![](https://pic4.zhimg.com/v2-d8394edf0838de302b86626afb443ce7_r.jpg)

ä½¿ç”¨setDataçš„æ—¶å€™ï¼Œé€»è¾‘å±‚ä¿®æ”¹äº†æ•°æ®ä¹‹åï¼Œå°†æ•°æ®ä¼ ç»™ç³»ç»Ÿå±‚ï¼ŒåŒæ—¶æ”¹å˜å¯¹åº”çš„ `this.data` çš„å€¼ï¼ˆåŒæ­¥ï¼‰ï¼›ç³»ç»Ÿå±‚å†ä¼ ç»™æ¸²æŸ“å±‚ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯ï¼ˆå¼‚æ­¥ï¼‰çš„è¿‡ç¨‹ã€‚

![](https://pic2.zhimg.com/v2-b5926677b7f9a34035919a288ade4a6d_r.jpg)

ä»ä¸Šå›¾ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼ŒsetDataä¸­çš„å›è°ƒå‡½æ•°ä¹Ÿæ˜¯ä¸€ä¸ªå¼‚æ­¥çš„æ“ä½œï¼Œå®ƒä¼šç­‰ä¸‹é¢çš„jsä»£ç æ‰§è¡Œå®Œæˆä¹‹åæ‰æ‰§è¡Œå›è°ƒå‡½æ•°ã€‚



#### ä¿®æ”¹å¯¹è±¡é‡Œçš„å€¼

å¯¹äºdataä¸­çš„å¯¹è±¡ç±»å‹çš„æ•°æ®ï¼Œå¦‚æœè¦ä¿®æ”¹å…¶æ•°æ®ï¼Œä¸èƒ½å°†æ•´ä¸ªå¯¹è±¡æ•°æ®éƒ½æ”¹äº†ï¼Œä½†æ˜¯æ³¨æ„ï¼Œä»¥ä¸‹è¿™æ ·åšæ˜¯é”™çš„ï¼š

```
  onChange(){
    this.setData({
      testObj.age: 6
    })
  },
```

è¦ç”¨æ–¹æ‹¬å·å’Œå¼•å·åŒ…è£¹èµ·æ¥æ‰æ˜¯æ­£ç¡®çš„ğŸ‘‡

```js
  onChange(){
    this.setData({
      ['testObj.age']: 6
    })
  },
```

å¦å¤–ï¼ŒsetDataä¸­çš„æ•°æ®å¯ä»¥æ˜¯æ–°æ•°æ®ï¼Œå¯ä»¥ä¸ç”¨äº‹å…ˆåœ¨dataä¸­å®šä¹‰å¥½ã€‚



### åœºæ™¯å€¼senceåŠå…¶åº”ç”¨åœºæ™¯

å®˜ç½‘ğŸ‘‰<https://developers.weixin.qq.com/miniprogram/dev/framework/app-service/scene.html>

åœºæ™¯å€¼ç”¨æ¥æè¿°ç”¨æˆ·è¿›å…¥å°ç¨‹åºçš„è·¯å¾„ã€‚å®Œæ•´åœºæ™¯å€¼çš„å«ä¹‰è¯·æŸ¥çœ‹[åœºæ™¯å€¼åˆ—è¡¨](https://developers.weixin.qq.com/miniprogram/dev/reference/scene-list.html)ã€‚

å¯ä»¥åœ¨ `App` çš„ `onLaunch` å’Œ `onShow`ï¼Œæˆ–[wx.getLaunchOptionsSync](https://developers.weixin.qq.com/miniprogram/dev/api/base/app/life-cycle/wx.getLaunchOptionsSync.html) ä¸­è·å–åˆ°åœºæ™¯å€¼

![](https://pic1.zhimg.com/80/v2-8d65af69b420a16851553c6daea83c11_hd.png)

![](https://pic2.zhimg.com/80/v2-285855b5fa7718e365f3fb8df1d5f59c_hd.png)

![](https://pic4.zhimg.com/80/v2-64ca333e81f24bd7af49d23094ca1efb_hd.jpg)

æˆ‘ä»¬å¯ä»¥åœ¨å¼€å‘è€…å·¥å…·ä¸­åˆ‡å‰å°å’Œå‰åå°æ¥æ¨¡æ‹Ÿå„ç§åœºæ™¯å€¼ğŸ‘‡

![](https://pic1.zhimg.com/80/v2-a5bab23bec95f04251a794c611e6433e_hd.png)



æˆ‘ä»¬å¯ä»¥é€šè¿‡åœºæ™¯å€¼æ¥äº†è§£åˆ°ç”¨æˆ·çš„æ¥æºï¼Œå¹¶è¿›è¡Œè¿›ä¸€æ­¥çš„é€»è¾‘æ“ä½œï¼Œæˆ–è€…ç”¨äºç”¨æˆ·åˆ†æï¼Œè¿™å¯¹äºè¿è¥æ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„ç‚¹ã€‚

### é¡µé¢æ”¶å½•sitemap.json

æ„Ÿè§‰ä¸æ˜¯å¤ªä¸»è¦ï¼Œä¸åšç¬”è®°äº†ã€‚



## 9.åå°ç®¡ç†ç³»ç»Ÿ

```
- å‰åç«¯åˆ†ç¦»æ¶æ„çš„åå°ç®¡ç†ç³»ç»Ÿ
- vue-admin-templateæ„å»ºç®¡ç†ç³»ç»Ÿå‰ç«¯
- Koa2æ„å»ºç®¡ç†ç³»ç»Ÿåç«¯
- HTTP APIè®¿é—®äº‘å¼€å‘èµ„æº
```

### é¡¹ç›®æ¶æ„ï¼š

â€‹		**å‰åç«¯åˆ†ç¦»**

![](https://pic2.zhimg.com/80/v2-1089ff56600d4f7148699f7804c92b12_hd.png)



### vue-admin-templateæ„å»ºå‰ç«¯éƒ¨åˆ†

 [vue-admin-template](https://github.com/PanJiaChen/vue-admin-template)æ˜¯[vue-element-admin](http://panjiachen.github.io/vue-element-admin)çš„åŸºç¡€æ¨¡æ¿ï¼Œæœ¬é¡¹ç›®åªç”¨vue-admin-templateå°±è¡Œäº†ã€‚

```js
# å…‹éš†é¡¹ç›®
git clone https://github.com/PanJiaChen/vue-admin-template.git

# è¿›å…¥é¡¹ç›®ç›®å½•
cd vue-admin-template

# å®‰è£…ä¾èµ–
npm install

# å»ºè®®ä¸è¦ç›´æ¥ä½¿ç”¨ cnpm å®‰è£…ä»¥æ¥ï¼Œä¼šæœ‰å„ç§è¯¡å¼‚çš„ bugã€‚å¯ä»¥é€šè¿‡å¦‚ä¸‹æ“ä½œè§£å†³ npm ä¸‹è½½é€Ÿåº¦æ…¢çš„é—®é¢˜
npm install --registry=https://registry.npm.taobao.org

# å¯åŠ¨æœåŠ¡
npm run dev
```

å°†src/viewsä¸­å¤šä½™çš„æ–‡ä»¶å¤¹åˆ å»ï¼Œåªç•™ä¸‹loginå’Œ404ï¼›ä¹‹åæ–°å»ºéœ€è¦çš„æ–‡ä»¶å¤¹å’Œæ–‡ä»¶ğŸ‘‡

![](https://pic3.zhimg.com/80/v2-47acc78651f2db33d40f010d1aabab60_hd.png)

è¿™é‡Œå°±åŒ…å«äº†éœ€è¦ç®¡ç†çš„åšå®¢ç®¡ç†ã€æ­Œå•ç®¡ç†ã€è½®æ’­å›¾ç®¡ç†ã€‚ç„¶åè¿›è¡Œrouterçš„è·¯ç”±é…ç½®ã€‚è¯¦è§\src\router\index.jsã€‚

è·¯ç”±é…ç½®å¥½ä¹‹åå°±å¯ä»¥è¿›è¡Œå‰ç«¯é¡µé¢çš„ç¼–å†™äº†ã€‚

![](https://pic3.zhimg.com/80/v2-1f4eb447af112720bc5f69bcee4f1443_hd.png)



### Koa2æ„å»ºç®¡ç†ç³»ç»Ÿåç«¯

æ–°å»ºadmin-backendæ–‡ä»¶å¤¹ï¼Œç„¶å`npm init`è¿›è¡Œé¡¹ç›®åˆå§‹åŒ–ã€‚

æ¥ç€`npm i koa`å®‰è£…koaã€‚

æ–°å»ºapp.jsæ–‡ä»¶å¹¶ç¼–å†™å¦‚ä¸‹ä»£ç ğŸ‘‡

```js
const Koa = require('koa')
const app = new Koa()

app.use(async (ctx) => {
    ctx.body = `<h1>ä½ å¥½ï¼</h1>
                <h2>æ¬¢è¿ä½¿ç”¨koaï¼</h2>`
})

app.listen(3000, () => {
    console.log('æœåŠ¡å·²å¯åŠ¨')
})
```

ç„¶ååœ¨å‘½ä»¤è¡Œè¾“å…¥`node app.js`å°±å¯ä»¥å¯åŠ¨æœåŠ¡å™¨äº†ï¼Œåœ¨<http://localhost:3000/>å°±å¯ä»¥çœ‹åˆ°å†…å®¹äº†ğŸ‘‡

![](https://pic1.zhimg.com/80/v2-56535c5a922dde22a6c701589cf2422c_hd.png)

è¿™æ ·å°±ç”¨node+koaæ­å»ºèµ·äº†ä¸€ä¸ªç®€æ˜“çš„æœåŠ¡å™¨äº†ã€‚





### access-tokençš„ç¼“å­˜å’Œæ›´æ–°

å®˜ç½‘æ–‡æ¡£ï¼š<https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/access-token/auth.getAccessToken.html>

access_tokenæ˜¯æ¥å£è°ƒç”¨å‡­è¯ã€‚å½“æˆ‘ä»¬é€šè¿‡HTTP APIè¿™ç§æ–¹å¼è°ƒç”¨æ¥å£çš„æ—¶å€™éƒ½è¦ç”¨åˆ°è¿™ä¸ªå‚æ•°ã€‚æˆ‘ä»¬éœ€è¦å¯¹access_tokenè¿›è¡Œç›¸åº”çš„ç¼“å­˜å’Œæ›´æ–°ã€‚

æˆ‘ä»¬åœ¨åç«¯ä¸­è¦å¯¹https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=APPID&secret=APPSECRETå‘èµ·httpè¯·æ±‚ï¼Œè¿™é‡Œæˆ‘ä½¿ç”¨requestå’Œrequest-promiseæ¥å‘é€è¯·æ±‚ã€‚

å…ˆå®‰è£…ä¹‹    `npm install request`ã€ `npm install request-promise`

ç„¶åç¼–å†™ä¸€ä¸ªä¸“é—¨çš„å·¥å…·jsæ–‡ä»¶æ¥ç”¨äºå‘é€è¯·æ±‚ğŸ‘‡

![](https://pic4.zhimg.com/80/v2-2e6de796a3a090bea04244c453311aad_hd.png)

å‘½ä»¤è¡Œ`node utils/getAccessToken.js`æ‰§è¡Œä¹‹ï¼Œå¯ä»¥çœ‹åˆ°æˆåŠŸçš„è¿”å›äº†access_tokençš„ä¿¡æ¯ğŸ‘‡

![](https://pic3.zhimg.com/80/v2-68f416e8a521ce1476e0c01d6f4221bf_hd.png)

è·å¾—tokenä¹‹åå°±è¦ä¿å­˜å¥½å®ƒï¼Œæˆ‘å°†å…¶å†™å…¥ä¸€ä¸ªjsonæ–‡ä»¶ä¸­ï¼š

![](https://pic2.zhimg.com/v2-a04b14661a9794e343871333a537a495_r.jpg)



ç¼–å†™è¯»å–`access_token.json`æ–‡ä»¶çš„æ–¹æ³•ğŸ‘‡

```js
const getAccessToken = async () => {
    // è¯»å–æ–‡ä»¶
    // const readRes = fs.readFileSync(fileName)  //å¦‚æœä¸åŠ  'utf8'ï¼Œå¾—åˆ°çš„æ˜¯Buffer
    const readRes = fs.readFileSync(fileName, 'utf8')  //åŠ ä¸Š 'utf8'ï¼Œå¾—åˆ°å­—ç¬¦ä¸²æ ¼å¼
    // console.log(readRes)
    const readObj = JSON.parse(readRes)
    console.log(readObj)

}

getAccessToken()
```

å¦‚æœ`access_token.json`æ–‡ä»¶å­˜åœ¨çš„è¯æ˜¯å¯ä»¥æ­£å¸¸è·å–åˆ°çš„ï¼Œä½†æ˜¯å½“`access_token.json`æ–‡ä»¶ä¸€å¼€å§‹ä¸å­˜åœ¨çš„è¯ï¼Œè¿™æ ·å°±ä¼šæŠ¥é”™äº†ï¼Œè€Œnodejsæ˜¯å•çº¿ç¨‹çš„ï¼Œæ‰€ä»¥å¿…é¡»è¦ç”¨try catchæ¥å¤„ç†ğŸ‘‡

```js
const getAccessToken = async () => {
    // è¯»å–æ–‡ä»¶
    try {
        const readRes = fs.readFileSync(fileName, 'utf8')  //åŠ ä¸Š 'utf8'ï¼Œå¾—åˆ°å­—ç¬¦ä¸²æ ¼å¼
        const readObj = JSON.parse(readRes)

        return readObj.access_token
    } catch (error) {
        await updateAccessToken()  // è¯¥æ–‡ä»¶ä¸å­˜åœ¨æ‰€ä»¥è¦é‡æ–°å‘é€è¯·æ±‚å¹¶å†™å…¥æ–‡ä»¶
        await getAccessToken()  // è¯»å–æ–‡ä»¶
    }

}
```

tokençš„æœ‰æ•ˆæœŸæ˜¯2å°æ—¶ï¼Œä¹Ÿå°±æ˜¯7200ç§’ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æ¯éš”ä¸€å®šçš„æ—¶é—´å‘é€è¯·æ±‚æ›´æ–°tokenï¼š

```js
// å®šæ—¶æ›´æ–°token
setInterval(async () => {
    await updateAccessToken()
}, (7200 - 300) * 1000);  // tokenæœ‰æ•ˆæœŸæ˜¯2å°æ—¶ä¹Ÿå°±æ˜¯7200ç§’ï¼Œæˆ‘æå‰5åˆ†é’Ÿä¹Ÿå°±æ˜¯300ç§’å»æ›´æ–°

```

å½“æˆ‘ä»¬å…³é—­æœåŠ¡å™¨æˆ–è€…å› ä¸ºæœåŠ¡å™¨å®•æœºäº†ï¼Œå†æ¬¡å¼€å¯çš„æ—¶å€™ï¼Œç”¨çš„è¿˜æ˜¯è€çš„tokenï¼Œå¾ˆå¯èƒ½å·²ç»è¿‡æœŸäº†ï¼Œæ‰€ä»¥éœ€è¦æ‹¿tokenæ–‡ä»¶ä¸­çš„åˆ›å»ºæ—¶é—´å’Œå½“å‰æ—¶é—´å¯¹æ¯”ï¼Œè‹¥è¶…è¿‡2å°æ—¶ï¼Œå°±è¦é‡æ–°è¯·æ±‚tokenã€‚

```js
const rp = require('request-promise')
const fs = require('fs')
const path = require('path')
const fileName = path.resolve(__dirname, './access_token.json')

const APPID = 'ä½ çš„appid'
const APPSECRET = 'ä½ çš„secret'
const URL = `https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=${APPID}&secret=${APPSECRET}`

const updateAccessToken = async () => {
    const resStr = await rp(URL)  // è¿”å›ç»“æœæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²æ ¼å¼çš„ï¼Œéœ€è¦json.paresè½¬åŒ–ä¸ºjsonæ ¼å¼
    const res = JSON.parse(resStr)
    console.log(res)

    // å†™æ–‡ä»¶
    if (res.access_token) {
        fs.writeFileSync(fileName, JSON.stringify({
            access_token: res.access_token,
            createTime: new Date()
        }))
    } else {
        // å½“æ— æ³•æ­£ç¡®è·å–åˆ°access_tokençš„æ—¶å€™è¦å†æ¬¡è°ƒç”¨æœ¬æ–¹æ³•
        await updateAccessToken()
    }
}

const getAccessToken = async () => {
    // è¯»å–æ–‡ä»¶
    try {
        // const readRes = fs.readFileSync(fileName)  //å¦‚æœä¸åŠ  'utf8'ï¼Œå¾—åˆ°çš„æ˜¯Buffer
        const readRes = fs.readFileSync(fileName, 'utf8')  //åŠ ä¸Š 'utf8'ï¼Œå¾—åˆ°å­—ç¬¦ä¸²æ ¼å¼
        // console.log(readRes)
        const readObj = JSON.parse(readRes)
        // console.log(readObj)

        const createTime = new Date(readObj.createTime).getTime()
        const nowTime = new Date().getTime()
        if ((nowTime - createTime) / 1000 / 60 / 60 >= 2) {
            await updateAccessToken()  // ç”±äºæœåŠ¡å™¨å®•æœºå…³é—­ç­‰åŸå› å¯¼è‡´tokenè¿‡æœŸæ²¡æœ‰åŠæ—¶æ›´æ–°ï¼Œæ‰€ä»¥è¦é‡æ–°å‘é€è¯·æ±‚å¹¶å†™å…¥æ–‡ä»¶
            await getAccessToken()  // è¯»å–æ–‡ä»¶
        }

        return readObj.access_token
    } catch (error) {
        await updateAccessToken()  // è¯¥æ–‡ä»¶ä¸å­˜åœ¨æ‰€ä»¥è¦é‡æ–°å‘é€è¯·æ±‚å¹¶å†™å…¥æ–‡ä»¶
        await getAccessToken()  // è¯»å–æ–‡ä»¶
    }

}

// å®šæ—¶æ›´æ–°token
setInterval(async () => {
    await updateAccessToken()
}, (7200 - 300) * 1000);  // tokenæœ‰æ•ˆæœŸæ˜¯2å°æ—¶ä¹Ÿå°±æ˜¯7200ç§’ï¼Œæˆ‘æå‰5åˆ†é’Ÿä¹Ÿå°±æ˜¯300ç§’å»æ›´æ–°

module.exports = getAccessToken //æ¨¡å—å¯¼å‡º
```



### MVCæ¨¡å¼

*MVC*å…¨åæ˜¯Model View Controllerï¼Œæ˜¯æ¨¡å‹(model)ï¼è§†å›¾(view)ï¼æ§åˆ¶å™¨(controller)çš„ç¼©å†™ã€‚

å¯¹äºæˆ‘ä»¬çš„é¡¹ç›®ï¼ŒMå±‚(model)ä¸€èˆ¬æ˜¯å’Œæ•°æ®åº“å’Œæ•°æ®ç›¸å…³çš„ã€‚Vå±‚(view)ä¸€èˆ¬å°±æ˜¯å‰ç«¯æ˜¾ç¤ºçš„éƒ¨åˆ†ã€‚Cå±‚(controllerç›¸å½“äºMå±‚å’ŒVå±‚ä¹‹é—´çš„çº½å¸¦,ä¸»è¦ç”¨äºæ§åˆ¶è·³è½¬ã€å¤„ç†ä¸šåŠ¡é€»è¾‘ã€‚

æˆ‘åœ¨é¡¹ç›®ä¸­æ–°å»ºäº†ä¸€ä¸ªæ–‡ä»¶å¤¹controllerï¼Œä»£è¡¨Cå±‚ã€‚æˆ‘ä¼šæŠŠå‰ç«¯è¯·æ±‚éƒ½å‘é€åˆ°controllerï¼Œç„¶åé€šè¿‡controllerå»è°ƒç”¨äº‘å¼€å‘é‡Œçš„å†…å®¹ï¼Œç„¶åæŠŠç»“æœè¿”å›åˆ°å‰ç«¯å»å±•ç¤ºã€‚

controlleræ–‡ä»¶å¤¹ä¸‹æ–°å»ºä¸€ä¸ªplaylist.jsï¼Œæˆ‘æŠŠæ‰€æœ‰å…³äºæ­Œå•å¤„ç†çš„ä¸šåŠ¡éƒ½æ”¾åœ¨è¿™é‡Œã€‚



### è·¯ç”±åˆæ¢

é¦–å…ˆæˆ‘ä»¬éœ€è¦è·¯ç”±ç®¡ç†ï¼Œå…ˆæ¥`npm i koa-router`å®‰è£…ä¸€ä¸‹koa-routerã€‚

**controller/playlist.jsï¼š**

```js
const Router = require('koa-router')
const router = new Router()

router.get('/list', async (ctx, next) => {
    // æŸ¥è¯¢æ­Œå•åˆ—è¡¨
    ctx.body = 'æ­Œå•åˆ—è¡¨'
})

module.exports = router  //ä½œä¸ºä¸€ä¸ªæ¨¡å—å¯¼å‡º
```



åœ¨app.jsä¸­å¼•ç”¨ä¸Šè¿°å®šä¹‰å¥½çš„è·¯ç”±ï¼š

![](https://pic2.zhimg.com/v2-bc5f3531b4459db3a52901be4a91278d_r.jpg)

`node app`å¯åŠ¨æœåŠ¡å™¨ï¼Œç„¶ååœ¨è®¿é—®<http://localhost:3000/playlist/list>å°±å¯ä»¥çœ‹åˆ°è¯¥è·¯ç”±æˆåŠŸè·³è½¬å¹¶æ˜¾ç¤ºğŸ‘‡

![](https://pic1.zhimg.com/80/v2-9907492c8de8f3464a8001f8ce7f219c_hd.png)

é‚£ä¹ˆæ¥ä¸‹æ¥åªè¦åœ¨è¯¥è·¯ç”±ä¸‹ï¼Œè°ƒç”¨å°ç¨‹åºäº‘å¼€å‘çš„HTTP APIè·å–åˆ°æ•°æ®ã€‚

### HTTP API è§¦å‘äº‘å‡½æ•°è·å–æ­Œå•åˆ—è¡¨

è¿™é‡Œæˆ‘ä»¬è¦åœ¨åç«¯ä»£ç ä¸­è°ƒç”¨æœ¬å°ç¨‹åºäº‘å‡½æ•°ä¸­çš„musicäº‘å‡½æ•°ï¼Œå…¶ä¸­å°±åŒ…å«äº†è·å–æ­Œå•åˆ—è¡¨æ•°æ®çš„æ–¹æ³•ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºğŸ‘‡

![](https://pic3.zhimg.com/v2-1d5552c2e71f6e0ecacae975a1068a32_r.jpg)

é‚£ä¹ˆè¦å¦‚ä½•åœ¨åç«¯ä»£ç ä¸­è§¦å‘å°ç¨‹åºäº‘å‡½æ•°ï¼Ÿ

å®˜ç½‘æ–‡æ¡£ï¼š<https://developers.weixin.qq.com/miniprogram/dev/wxcloud/reference-http-api/functions/invokeCloudFunction.html>

éœ€è¦å¯¹ä¸‹é¢è¿™ä¸ªè¯·æ±‚ç½‘å€å‘é€postè¯·æ±‚ã€‚

ã€è¯·æ±‚åœ°å€ã€‘

```text
POST https://api.weixin.qq.com/tcb/invokecloudfunction?access_token=ACCESS_TOKEN&env=ENV&name=FUNCTION_NAME
```

æ³¨æ„è¿™é‡Œçš„ä¸‰ä¸ªå‚æ•°access_tokenã€envã€nameã€‚

```js
const Router = require('koa-router')
const router = new Router()
const rp = require('request-promise')
const getAccessToken = require('..//utils/getAccessToken')

const ENV = 'dev-r049g'  // æˆ‘çš„å°ç¨‹åºäº‘ç¯å¢ƒid

router.get('/list', async (ctx, next) => {
    // æŸ¥è¯¢æ­Œå•åˆ—è¡¨
    const access_token = await getAccessToken() // getAccessTokenæ˜¯å¼‚æ­¥æ“ä½œè¦åŠ ä¸Šawait
    // console.log('access_tokenæ˜¯' + access_token);

    const url = `https://api.weixin.qq.com/tcb/invokecloudfunction?access_token=${access_token}&env=${ENV}&name=music`

    let options = {
        method: 'POST',
        uri: url,
        body: {
            $url: 'playlist',
            start: 0,
            count: 50
        },
        json: true // Automatically stringifies the body to JSON
    }
    const data = await rp(options)
        .then((res) => {
            // console.log(res);
            return JSON.parse(res.resp_data).data
        }).catch((err) => {
            console.log('POST failed...');
        })

    ctx.body = {
        data,
        code: 20000 // å‰ç«¯requestæ–¹æ³•è¦æ±‚äº†è¿”å›ç»“æœæœ‰code: 20000æ‰ç®—è¿”å›æˆåŠŸï¼Œæ‰€ä»¥è¦åŠ ä¸Šcode: 20000
    }


    // ctx.body = 'æ­Œå•åˆ—è¡¨'
})

module.exports = router  //ä½œä¸ºä¸€ä¸ªæ¨¡å—å¯¼å‡º
```

é‡å¯æœåŠ¡å™¨app.jsï¼Œç„¶åè®¿é—®<http://localhost:3000/playlist/list>ï¼Œå¯ä»¥çœ‹åˆ°æ•°æ®æˆåŠŸè·å–åˆ°äº†ğŸ‘‡

![](https://pic1.zhimg.com/v2-7c82b2e35f38460b5336d79fd8736d04_r.jpg)







### æ­Œå•åˆ—è¡¨å‰åç«¯äº¤äº’ä¸è·¨åŸŸé—®é¢˜

åç«¯æ¥å£å·²ç»å®Œæˆï¼Œå›åˆ°å‰ç«¯éƒ¨åˆ†ï¼Œæˆ‘éœ€è¦åœ¨å‰ç«¯éƒ¨åˆ†å‘è¿™ä¸ªåç«¯æ¥å£å‘èµ·Ajaxè¯·æ±‚ã€‚è¿™é‡Œvue-admin-templateé¡¹ç›®é‡Œå°è£…å¥½äº†ä¸€ä¸ªaxiosçš„å·¥å…·request.jsï¼Œæˆ‘ç›´æ¥ç”¨è¿™ä¸ªrequest.jsæ¥å‘é€è¯·æ±‚ã€‚

vue-admin-template/src/api/playlist.jsï¼š

```js
import request from '../utils/request'

const baseURL = 'http://localhost:3000'

export function fetchList(params) {
    return request({
        params,
        url: `${baseURL}/playlist/list`,
        method: 'get'
    })
}

```

æ¥ç€åœ¨list.vueä¸­è°ƒç”¨ä¸Šè¿°æ–¹æ³•è¿›è¡Œå‘é€Ajaxè¯·æ±‚ï¼š

```js
<script>
import { fetchList } from "@/api/playlist";
export default {
  data() {
    return {
      playlist: [],
      count: 50
    };
  },

  created() {
    this.getList();
  },

  methods: {
    getList() {
      fetchList({
        start: this.playlist.length,
        count: this.count
      })
        .then(res => {
          console.log(res);
        })
        .catch(err => {
          console.log("ERROR");
        });
    }
  }
};
</script>
```

ç„¶åæˆ‘ä»¬å¯åŠ¨åç«¯æœåŠ¡å™¨å’Œå‰ç«¯é¡¹ç›®ï¼Œè®¿é—®<http://localhost:9528/#/playlist/list>çš„æ—¶å€™å‘ç”Ÿäº†ç½‘ç»œé”™è¯¯ï¼Œæ§åˆ¶å°æ˜¾ç¤ºå­˜åœ¨**è·¨åŸŸé—®é¢˜**ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚å› ä¸º<http://localhost:9528/#/playlist/list>å’Œåç«¯æ¥å£urlhttp://localhost:3000/playlist/list?start=0&count=50åŸŸåä¸ä¸€è‡´ï¼Œè¿åäº†åŒæºç­–ç•¥ã€‚

![](https://pic2.zhimg.com/v2-286322a828af2b11c69aaddcd23ccec5_r.jpg)

é‚£ä¹ˆæˆ‘å°±åœ¨åç«¯éƒ¨åˆ†è®¾ç½®å…è®¸å…¶è·¨åŸŸï¼Œç”¨åˆ°äº†**koa2-cors**ã€‚

å›åˆ°åç«¯é¡¹ç›®ï¼Œ`npm i koa2-cors`å®‰è£…koa2-corsã€‚ç„¶åä½¿ç”¨å®ƒğŸ‘‡

```js
const cors = require('koa2-cors')

// è·¨åŸŸ
app.use(cors({
    origin: ['http://localhost:9528'], // æ•°ç»„ï¼Œé‡Œé¢å­˜æ”¾å…è®¸è®¿é—®æœ¬åç«¯é¡¹ç›®çš„å‰ç«¯url
    credentials: true  // è¯ä¹¦è®¾ä¸ºtrueï¼Œè¡¨ç¤ºå…è®¸
}))
```

é‡å¯æœåŠ¡ï¼Œå‘ç°è·¨åŸŸçš„é—®é¢˜å°±è§£å†³äº†ï¼Œå¹¶æˆåŠŸè¿”å›äº†æ•°æ®ğŸ‘‡

![](https://pic2.zhimg.com/v2-657ea7dbbc5d038701e3f2d87e42b4fd_r.jpg)

å‰ç«¯æˆåŠŸè·å–åˆ°æ•°æ®åå°±å¥½åŠäº†ã€‚

vue-admin-templateä¸­å†…ç½®äº†element-uiï¼Œå°±ç›´æ¥ç”¨element-uiæ¥åšå¥½äº†ã€‚







ã€‚